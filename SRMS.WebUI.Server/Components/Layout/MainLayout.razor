@using SRMS.Application.Notifications.Interfaces
@using Microsoft.EntityFrameworkCore
@using SRMS.Infrastructure
@using System.Security.Claims
@inherits LayoutComponentBase
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<MudThemeProvider Theme="@_theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout UserAttributes="@(new Dictionary<string, object> { { "data-theme", _isDarkMode ? "dark" : "light" } })">
    <!-- Modern App Bar with Glassmorphism -->
    <MudAppBar Elevation="1" Dense="false" Class="glass"
        Style="backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color);">
        <!-- Menu Toggle Button -->
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
            OnClick="@ToggleDrawer" Class="hover-scale" />

        <!-- Logo & Title -->
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudPaper Elevation="0"
                Style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(139,92,246,0.3);">
                <MudIcon Icon="@Icons.Material.Filled.School" Color="Color.Surface" />
            </MudPaper>
            <MudText Typo="Typo.h6"
                Style="font-weight: 700; background: linear-gradient(135deg, #a78bfa 0%, #d946ef 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                SRMS
            </MudText>
        </MudStack>

        <MudSpacer />

        <!-- Search (Optional) -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudTextField @bind-Value="_searchString" Placeholder="Search..." Adornment="Adornment.Start"
                AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" Variant="Variant.Outlined"
                Margin="Margin.Dense" Class="mr-4" Style="max-width: 350px; border-radius: 12px;" />
        </MudHidden>

        <!-- Dark/Light Mode Toggle -->
        <MudTooltip Text="@(_isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode")">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Outlined.LightMode : Icons.Material.Outlined.DarkMode)"
                Color="Color.Inherit" OnClick="@ToggleDarkMode" Class="hover-scale" />
        </MudTooltip>

        <!-- User Menu -->
        <AuthorizeView>
            <Authorized>
                <!-- Notifications -->
                <MudTooltip Text="Notifications">
                    <MudBadge Content="@_notificationCount" Color="Color.Error" Overlap="true"
                        Visible="@(_notificationCount > 0)" Class="animate-pulse">
                        <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit"
                            Href="/Notifications" Class="hover-scale" />
                    </MudBadge>
                </MudTooltip>

                <!-- User Menu -->
                <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit"
                    AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="hover-scale">

                    <ChildContent>
                        <!-- User Info Card -->
                        <MudPaper Class="pa-4 glass-card" Style="min-width: 280px; border-radius: 12px; margin: 8px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                <MudAvatar Color="Color.Primary" Size="Size.Large">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                        @context.User.Identity?.Name
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(context.User)"
                                        Style="width: fit-content;">
                                        @GetUserRole(context.User)
                                    </MudChip>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                        <MudDivider />

                        <!-- Menu Items -->
                        <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/profile" Class="hover-brightness">
                            <MudText>Profile</MudText>
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Settings" Href="/settings" Class="hover-brightness">
                            <MudText>Settings</MudText>
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Logout" Href="/api/auth/logout"
                            IconColor="Color.Error" Class="hover-brightness">
                            <MudText Color="Color.Error">Logout</MudText>
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/login" Variant="Variant.Filled" Color="Color.Primary"
                    StartIcon="@Icons.Material.Filled.Login" Class="btn-modern btn-primary">
                    Sign In
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <!-- Modern Drawer / Sidebar -->
    <MudDrawer @bind-Open="_drawerOpen" Class="glass" ClipMode="DrawerClipMode.Always" Elevation="2" id="nav-drawer"
        Style="backdrop-filter: blur(20px); border-right: 1px solid var(--border-color);">
        <NavMenu />
    </MudDrawer>

    <!-- Main Content with Modern Background -->
    <MudMainContent Style="background: var(--bg-primary); min-height: 100vh;">
        <MudPaper Class="gradient-mesh" Elevation="0"
            Style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.3; pointer-events: none; z-index: 0;" />
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-6" Style="position: relative; z-index: 1;">
            <AuthorizeView>
                <Authorized>
                    @Body
                </Authorized>
                <NotAuthorized>
                    @if (IsPublicPage())
                    {
                        @Body
                    }
                    else
                    {
                        <MudStack Class="animate-fade-in" Style="width: 100%">
                            <MudPaper Elevation="0" Class="glass-card pa-8 text-center"
                                Style="max-width: 600px; margin: 100px auto;">
                                <MudPaper Elevation="0"
                                    Style="width: 120px; height: 120px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 0 20px rgba(239,68,68,0.3);">
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Surface"
                                        Style="font-size: 60px;" />
                                </MudPaper>
                                <MudText Typo="Typo.h3" Class="mb-3" Style="font-weight: 700;">Access Denied</MudText>
                                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
                                    You need to be logged in to access this page. Please sign in to continue.
                                </MudText>
                                <MudButton Href="/login" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                                    StartIcon="@Icons.Material.Filled.Login" Class="btn-modern btn-primary">
                                    Sign In Now
                                </MudButton>
                            </MudPaper>
                        </MudStack>
                    }
                </NotAuthorized>
            </AuthorizeView>
        </MudContainer>
    </MudMainContent>
</MudLayout>


@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = true;
    private MudTheme? _theme = null;
    private string _searchString = "";
    private int _notificationCount = 0;

    protected override async Task OnInitializedAsync()
    {
        _theme = new()
        {
            PaletteLight = _lightPalette,
            PaletteDark = _darkPalette,
            LayoutProperties = new LayoutProperties()
        };

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(userIdStr, out var userId))
            {
                _notificationCount = await NotificationService.GetUnreadCountAsync(userId);
            }
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
    }

    private string GetUserRole(System.Security.Claims.ClaimsPrincipal user)
    {
        if (user.IsInRole("SuperRoot")) return "Super Admin";
        if (user.IsInRole("Admin")) return "Administrator";
        if (user.IsInRole("Manager")) return "Manager";
        if (user.IsInRole("Student")) return "Student";
        return "User";
    }

    private Color GetRoleColor(System.Security.Claims.ClaimsPrincipal user)
    {
        if (user.IsInRole("SuperRoot")) return Color.Error;
        if (user.IsInRole("Admin")) return Color.Primary;
        if (user.IsInRole("Manager")) return Color.Info;
        if (user.IsInRole("Student")) return Color.Success;
        return Color.Default;
    }

    private bool IsPublicPage()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var path = uri.AbsolutePath.ToLower().TrimEnd('/');

        if (string.IsNullOrEmpty(path)) path = "/";

        var publicPages = new[]
        {
            "/", "/login", "/register", "/forgot-password", "/verify-email", "/reset-password", "/about",
            "/contact", "/help"
        };
        return publicPages.Contains(path);
    }

    // Enhanced Light Theme Palette - Softer for eyes
    private readonly PaletteLight _lightPalette = new()
    {
        Black = "#0f172a",
        AppbarText = "#1e293b",
        AppbarBackground = "rgba(248,250,252,0.95)",
        DrawerBackground = "rgba(248,250,252,0.95)",
        DrawerText = "#334155",
        DrawerIcon = "#64748b",
        Surface = "#ffffff",
        Background = "#f8fafc",
        BackgroundGray = "#f1f5f9",
        TextPrimary = "#0f172a",
        TextSecondary = "#475569",
        Primary = "#8b5cf6",
        PrimaryContrastText = "#ffffff",
        Secondary = "#d946ef",
        Info = "#3b82f6",
        Success = "#10b981",
        Warning = "#f59e0b",
        Error = "#ef4444",
        Dark = "#1e293b",
        GrayLight = "#e2e8f0",
        GrayLighter = "#f1f5f9",
    };

    // Enhanced Dark Theme Palette - More comfortable for eyes
    private readonly PaletteDark _darkPalette = new()
    {
        Primary = "#8b5cf6",
        Secondary = "#d946ef",
        Surface = "#151b2e",
        Background = "#0a0f1e",
        BackgroundGray = "#151b2e",
        AppbarText = "#f1f5f9",
        AppbarBackground = "rgba(10,15,30,0.95)",
        DrawerBackground = "rgba(10,15,30,0.95)",
        DrawerText = "#cbd5e1",
        DrawerIcon = "#94a3b8",
        ActionDefault = "#94a3b8",
        ActionDisabled = "#475569",
        ActionDisabledBackground = "#1f2937",
        TextPrimary = "#f1f5f9",
        TextSecondary = "#cbd5e1",
        TextDisabled = "#64748b",
        Info = "#60a5fa",
        Success = "#34d399",
        Warning = "#fbbf24",
        Error = "#f87171",
        Dark = "#0a0f1e",
        LinesDefault = "rgba(139,92,246,0.15)",
        TableLines = "rgba(139,92,246,0.15)",
        Divider = "rgba(255,255,255,0.06)",
        OverlayLight = "rgba(10,15,30,0.5)",
    };

}