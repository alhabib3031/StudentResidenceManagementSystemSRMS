@using SRMS.Application.Notifications.Interfaces
@using System.Security.Claims
@using Microsoft.Extensions.Localization
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IStringLocalizer<Resource> L

<!-- Modern Sidebar Header -->
<MudPaper class="pa-5" style="border-bottom: 1px solid var(--border-color);">
    <MudPaper
        style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: var(--shadow-glow); animation: float 3s ease-in-out infinite;">
        <MudIcon Icon="@Icons.Material.Filled.School" Color="Color.Surface" Size="Size.Large" />
    </MudPaper>
    <MudText Typo="Typo.h6" Align="Align.Center"
        Style="font-weight: 700; background: linear-gradient(135deg, var(--primary-400) 0%, var(--secondary-500) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        @L["Brand_Title"]
    </MudText>
    <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
        @L["Brand_Subtitle"]
    </MudText>
</MudPaper>

<MudPaper class="pa-3">
    <AuthorizeView>
        <Authorized Context="auth">
            <!-- SuperRoot Menu -->
            <AuthorizeView Roles="SuperRoot">
                <MudNavGroup Title='@(L["SuperRootPanel"])' Icon="@Icons.Material.Filled.Shield" IconColor="Color.Error"
                    Expanded="true" Class="modern-nav-group">
                    <MudNavLink Href="/superroot" Icon="@Icons.Material.Filled.Dashboard" Class="modern-nav-link">
                        @L["Dashboard"]
                    </MudNavLink>
                    <MudNavLink Href="/superroot/users" Icon="@Icons.Material.Filled.People" Class="modern-nav-link">
                        @L["ManageUsers"]
                    </MudNavLink>
                    @* <MudNavLink Href="/admin/user-reviews" Icon="@Icons.Material.Filled.RateReview" *@
                    @*     Class="modern-nav-link"> *@
                    @*     @L["Admin_UserReviews_Title"] *@
                    @* </MudNavLink> *@
                    <MudNavLink Href="/superroot/roles" Icon="@Icons.Material.Filled.AdminPanelSettings"
                        Class="modern-nav-link">
                        @L["ManageRoles"]
                    </MudNavLink>
                    <MudNavLink Href="/superroot/settings" Icon="@Icons.Material.Filled.Settings"
                        Class="modern-nav-link">
                        @L["SystemSettings"]
                    </MudNavLink>
                    <MudNavLink Href="/superroot/audit" Icon="@Icons.Material.Filled.History" Class="modern-nav-link">
                        @L["AuditLogs"]
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>

            <!-- Admin Menu -->
            <AuthorizeView Roles="Admin,SuperRoot">
                <MudNavGroup Title='@(L["Administration"])' Icon="@Icons.Material.Filled.AdminPanelSettings"
                    IconColor="Color.Primary" Expanded="@IsAdmin()" Class="modern-nav-group">
                    <MudNavLink Href="/admin" Icon="@Icons.Material.Filled.Dashboard" Class="modern-nav-link">
                        @L["AdminDashboard"]
                    </MudNavLink>
                    <MudNavLink Href="/admin/residences" Icon="@Icons.Material.Filled.Apartment"
                        Class="modern-nav-link">
                        @L["Residences"]
                    </MudNavLink>
                    <MudNavLink Href="/admin/managers" Icon="@Icons.Material.Filled.SupervisedUserCircle"
                        Class="modern-nav-link">
                        @L["ManagersLabel"]
                    </MudNavLink>
                    <MudNavLink Href="/admin/reports" Icon="@Icons.Material.Filled.Assessment" Class="modern-nav-link">
                        @L["Reports"]
                    </MudNavLink>
                    <MudNavLink Href="/admin/colleges" Icon="@Icons.Material.Filled.AccountBalance"
                        Class="modern-nav-link">
                        @L["Admin_Colleges_Title"]
                    </MudNavLink>
                    <MudNavLink Href="/admin/nationalities" Icon="@Icons.Material.Filled.Public"
                        Class="modern-nav-link">
                        @L["Nationalities"]
                    </MudNavLink>
                    <MudNavLink Href="/admin/user-reviews" Icon="@Icons.Material.Filled.RateReview"
                        Class="modern-nav-link">
                        @L["Admin_UserReviews_Title"]
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>

            <!-- Manager Menu -->
            <AuthorizeView Roles="Manager,Admin,SuperRoot">
                <MudNavGroup Title='@(L["Management"])' Icon="@Icons.Material.Filled.ManageAccounts"
                    IconColor="Color.Info" Expanded="@IsManager()" Class="modern-nav-group">
                    <MudNavLink Href="/manager" Icon="@Icons.Material.Filled.Dashboard" Class="modern-nav-link">
                        @L["ManagerDashboard"]
                    </MudNavLink>
                    <MudNavLink Href="/students" Icon="@Icons.Material.Filled.School" Class="modern-nav-link">
                        @L["StudentsLabel"]
                    </MudNavLink>
                    <MudNavLink Href="/rooms" Icon="@Icons.Material.Filled.MeetingRoom" Class="modern-nav-link">
                        @L["RoomsLabel"]
                    </MudNavLink>
                    <MudNavLink Href="/complaints" Icon="@Icons.Material.Filled.Report" Class="modern-nav-link">
                        @L["ComplaintsLabel"]
                    </MudNavLink>
                    <MudNavLink Href="/payments" Icon="@Icons.Material.Filled.Payment" Class="modern-nav-link">
                        @L["PaymentsLabel"]
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>

            <!-- College Registrar Menu -->
            <AuthorizeView Roles="CollegeRegistrar">
                <MudNavGroup Title='@(L["Registrar_Dashboard_Title"])' Icon="@Icons.Material.Filled.AccountBalance"
                    IconColor="Color.Info" Expanded="true" Class="modern-nav-group">
                    <MudNavLink Href="/registrar" Icon="@Icons.Material.Filled.Dashboard" Class="modern-nav-link">
                        @L["Dashboard"]
                    </MudNavLink>
                    <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.Person" Class="modern-nav-link">
                        @L["MyProfile"]
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>

            <!-- Student Menu -->
            <AuthorizeView Roles="Student">
                <MudNavGroup Title='@(L["StudentPortalLabel"])' Icon="@Icons.Material.Filled.School"
                    IconColor="Color.Success" Expanded="true" Class="modern-nav-group">
                    <MudNavLink Href="/student" Icon="@Icons.Material.Filled.Dashboard" Class="modern-nav-link">
                        @L["MyDashboard"]
                    </MudNavLink>
                    <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.Person" Class="modern-nav-link">
                        @L["MyProfile"]
                    </MudNavLink>
                    <MudNavLink Href="/student/room" Icon="@Icons.Material.Filled.MeetingRoom" Class="modern-nav-link">
                        @L["MyRoom"]
                    </MudNavLink>
                    <MudNavLink Href="/student/payments" Icon="@Icons.Material.Filled.Payment" Class="modern-nav-link">
                        @L["MyPayments"]
                    </MudNavLink>
                    <MudNavLink Href="/student/complaints" Icon="@Icons.Material.Filled.Report" Class="modern-nav-link">
                        @L["MyComplaints"]
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>

            <!-- Common Links -->
            <MudDivider Class="my-3" Style="border-color: var(--border-color);" />

            <MudNavLink Href="/notifications" Icon="@Icons.Material.Filled.Notifications" Class="modern-nav-link">
                <div class="d-flex align-center justify-space-between w-100">
                    <span>@L["Notifications_Header"]</span>
                    <MudBadge Content="@_notificationCount" Color="Color.Error" Overlap="false" Class="animate-pulse"
                        Visible="@(_notificationCount > 0)" />
                </div>
            </MudNavLink>

            <MudNavLink Href="/help" Icon="@Icons.Material.Filled.Help" Class="modern-nav-link">
                @L["HelpSupport"]
            </MudNavLink>
        </Authorized>

        <NotAuthorized>
            <!-- Public Menu -->
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home" Class="modern-nav-link">
                @L["Home"]
            </MudNavLink>
            <MudNavLink Href="/about" Icon="@Icons.Material.Filled.Info" Class="modern-nav-link">
                @L["AboutUs"]
            </MudNavLink>
            <MudNavLink Href="/contact" Icon="@Icons.Material.Filled.ContactMail" Class="modern-nav-link">
                @L["Contact"]
            </MudNavLink>
            <MudNavLink Href="/help" Icon="@Icons.Material.Filled.Help" Class="modern-nav-link">
                @L["Help"]
            </MudNavLink>

            <MudDivider Class="my-3" Style="border-color: var(--border-color);" />

            <MudNavLink Href="/login" Icon="@Icons.Material.Filled.Login" Class="modern-nav-link">
                <MudText Style="font-weight: 600;">@L["SignIn"]</MudText>
            </MudNavLink>
            <MudNavLink Href="/register" Icon="@Icons.Material.Filled.PersonAdd" Class="modern-nav-link">
                <MudText Style="font-weight: 600;">@L["Register"]</MudText>
            </MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudPaper>

<!-- Version Info & Footer -->
<MudSpacer />
<MudPaper class="pa-4 text-center" style="border-top: 1px solid var(--border-color);">
    <MudStack Spacing="2">
        <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
            <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Small" /> @L["VersionInfo"]
        </MudText>
        <MudText Typo="Typo.caption" Color="Color.Tertiary" Align="Align.Center">
            @L["Copyright"]
        </MudText>
    </MudStack>
</MudPaper>

<style>
    .modern-nav-group {
        margin-bottom: 8px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .modern-nav-group:hover {
        background: var(--bg-hover);
    }

    .modern-nav-link {
        border-radius: 10px;
        margin: 4px 0;
        padding: 10px 16px;
        transition: all 0.2s ease;
    }

    .modern-nav-link:hover {
        background: var(--bg-hover);
        transform: translateX(4px);
    }

    .modern-nav-link.active {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        box-shadow: var(--shadow-glow);
        font-weight: 600;
    }

    .mud-nav-link-text {
        font-size: 0.875rem;
    }
</style>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private int _notificationCount = 0;

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (Guid.TryParse(userIdStr, out var userId))
                {
                    _notificationCount = await NotificationService.GetUnreadCountAsync(userId);
                }
            }
        }
    }

    private bool IsAdmin()
    {
        return AuthenticationStateTask?.Result.User.IsInRole("Admin") ?? false;
    }

    private bool IsManager()
    {
        return AuthenticationStateTask?.Result.User.IsInRole("Manager") ?? false;
    }
}