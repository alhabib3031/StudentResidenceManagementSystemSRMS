@page "/profile"
@attribute [Authorize]
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@using SRMS.Application.Identity.DTOs
@using SRMS.Application.Identity.Interfaces
@inject ISnackbar Snackbar
@inject IUserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["Profile_PageTitle"]</PageTitle>

<MudStack Class="animate-fade-in w-full">
    <!-- Header -->
    <MudText Typo="Typo.h4" Class="text-gradient mb-4 font-bold">
        <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
        @L["Profile_Header"]
    </MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }
    else if (_currentUser == null)
    {
        <MudAlert Severity="Severity.Error">@L["Profile_Error_Load"]</MudAlert>
    }
    else
    {
        <MudGrid>
            <!-- Profile Card -->
            <MudItem xs="12" md="4">
                <MudPaper Class="glass-card p-6 text-center">
                    <MudPaper Elevation="0" Class="relative inline-block mb-4 bg-transparent">
                        <MudAvatar Size="Size.Large" Class="w-[120px] h-[120px] shadow-lg">
                            @if (!string.IsNullOrEmpty(_currentUser.ProfilePicture))
                            {
                                <MudImage Src="@_currentUser.ProfilePicture" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                            }
                        </MudAvatar>
                        
                        <div class="absolute bottom-0 right-0">
                            <MudFileUpload T="IBrowserFile" FilesChanged="HandleAvatarUpload" Accept=".jpg,.png,.jpeg">
                                <ActivatorContent>
                                    <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.CameraAlt" Size="Size.Small" />
                                </ActivatorContent>
                            </MudFileUpload>
                        </div>
                    </MudPaper>

                    <MudText Typo="Typo.h5" Class="font-semibold">@_currentUser.FullName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">@_currentUser.Email</MudText>

                    <MudChip T="string" Color="@(_currentUser.IsActive ? Color.Success : Color.Error)" Size="Size.Small">
                        <MudIcon Icon="@Icons.Material.Filled.Circle" Color="@(_currentUser.IsActive ? Color.Success : Color.Error)" Size="Size.Small"
                            Class="mr-2" />
                        @(_currentUser.IsActive ? L["Profile_Status_Active"] : L["Profile_Status_Inactive"])
                    </MudChip>

                    <MudDivider Class="my-4" />

                    <MudStack Class="text-left" Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Profile_MemberSince"]</MudText>
                        <MudText Typo="Typo.body2" Class="mb-3">@_currentUser.CreatedAt.ToString("MMMM dd, yyyy")</MudText>

                        <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Profile_LastLogin"]</MudText>
                        <MudText Typo="Typo.body2">@(_currentUser.LastLoginAt?.ToString("MMM dd, yyyy - hh:mm tt") ?? L["Profile_Never"])</MudText>
                        
                        @if (_currentUser.Roles.Any())
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-3">@L["Profile_Roles"]</MudText>
                            <MudStack Row="true" Class="mt-1" Wrap="Wrap.Wrap">
                                @foreach (var role in _currentUser.Roles)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(role)">@role</MudChip>
                                }
                            </MudStack>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Profile Information -->
            <MudItem xs="12" md="8">
                <MudPaper Class="glass-card pa-6">
                    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="p-6">
                        <!-- Personal Information Tab -->
                        <MudTabPanel Text='@L["Profile_Tab_PersonalInfo"]' Icon="@Icons.Material.Filled.Person">
                            <EditForm Model="@_profileModel" OnValidSubmit="SaveProfile">
                                <DataAnnotationsValidator />

                                <MudGrid>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.FirstName" Label='@L["Profile_Label_FirstName"]'
                                            Variant="Variant.Outlined" Required="true"
                                            For="@(() => _profileModel.FirstName)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.LastName" Label='@L["Profile_Label_LastName"]'
                                            Variant="Variant.Outlined" Required="true"
                                            For="@(() => _profileModel.LastName)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.Email" Label='@L["Profile_Label_Email"]'
                                            Variant="Variant.Outlined" InputType="InputType.Email" Disabled="true"
                                            For="@(() => _profileModel.Email)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.PhoneNumber" Label='@L["Profile_Label_PhoneNumber"]'
                                            Variant="Variant.Outlined" For="@(() => _profileModel.PhoneNumber)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.City" Label='@L["Profile_Label_City"]'
                                            Variant="Variant.Outlined" For="@(() => _profileModel.City)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.Country" Label='@L["Profile_Label_Country"]'
                                            Variant="Variant.Outlined" For="@(() => _profileModel.Country)" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_profileModel.Street" Label='@L["Profile_Label_Street"]'
                                            Variant="Variant.Outlined" For="@(() => _profileModel.Street)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_profileModel.PostalCode" Label='@L["Profile_Label_PostalCode"]'
                                            Variant="Variant.Outlined" For="@(() => _profileModel.PostalCode)" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudSelect T="string" @bind-Value="_profileModel.PreferredLanguage" Label='@L["Profile_Label_PreferredLanguage"]'
                                            Variant="Variant.Outlined">
                                            <MudSelectItem Value="@("en")">@L["English"]</MudSelectItem>
                                            <MudSelectItem Value="@("ar")">@L["Arabic"]</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12" Class="flex justify-end">
                                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                                            Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                                            Class="btn-modern btn-primary" Disabled="_isSaving">
                                            @if (_isSaving)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>@L["Profile_Button_Saving"]</span>
                                            }
                                            else
                                            {
                                                <span>@L["Profile_Button_SaveChanges"]</span>
                                            }
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>
                            </EditForm>
                        </MudTabPanel>

                        @if (_userDetails?.StudentDetails != null)
                        {
                            <MudTabPanel Text='@L["Profile_Tab_AcademicInfo"]' Icon="@Icons.Material.Filled.School">
                                <MudGrid>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.StudentDetails.UniversityName" Label='@L["ProfileCompletion_UniversityName"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.StudentDetails.CollegeName" Label='@L["ProfileCompletion_College"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.StudentDetails.StudentNumber" Label='@L["ProfileCompletion_StudentNumber"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.StudentDetails.Major" Label='@L["ProfileCompletion_Major"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@($"{_userDetails.StudentDetails.AcademicYear} ({_userDetails.StudentDetails.AcademicTerm})")" Label='@L["Profile_AcademicStatus"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                     <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.StudentDetails.NationalId" Label='@L["ProfileCompletion_NationalId"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                </MudGrid>
                            </MudTabPanel>
                            
                            <MudTabPanel Text='@L["Profile_Tab_Documents"]' Icon="@Icons.Material.Filled.Description">
                                <MudList T="string">
                                    @if (!string.IsNullOrEmpty(_userDetails.StudentDetails.BirthCertificatePath))
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.AttachFile">
                                            <div class="d-flex align-center justify-space-between w-100">
                                                <MudText>@L["ProfileCompletion_BirthCertificate"]</MudText>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@_userDetails.StudentDetails.BirthCertificatePath" Target="_blank">@L["View"]</MudButton>
                                            </div>
                                        </MudListItem>
                                    }
                                    @if (!string.IsNullOrEmpty(_userDetails.StudentDetails.HighSchoolCertificatePath))
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.AttachFile">
                                            <div class="d-flex align-center justify-space-between w-100">
                                                <MudText>@L["ProfileCompletion_HighSchoolCertificate"]</MudText>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@_userDetails.StudentDetails.HighSchoolCertificatePath" Target="_blank">@L["View"]</MudButton>
                                            </div>
                                        </MudListItem>
                                    }
                                    @if (!string.IsNullOrEmpty(_userDetails.StudentDetails.HealthCertificatePath))
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.AttachFile">
                                            <div class="d-flex align-center justify-space-between w-100">
                                                <MudText>@L["ProfileCompletion_HealthCertificate"]</MudText>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@_userDetails.StudentDetails.HealthCertificatePath" Target="_blank">@L["View"]</MudButton>
                                            </div>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudTabPanel>
                        }

                        @if (_userDetails?.RegistrarDetails != null)
                        {
                            <MudTabPanel Text='@L["Profile_Tab_WorkInfo"]' Icon="@Icons.Material.Filled.Work">
                                <MudGrid>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.RegistrarDetails.CollegeName" Label='@L["ProfileCompletion_College"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField Value="@_userDetails.RegistrarDetails.EmployeeNumber" Label='@L["ProfileCompletion_EmployeeNumber"]' ReadOnly="true" Variant="Variant.Outlined" />
                                    </MudItem>
                                </MudGrid>
                            </MudTabPanel>
                        }

                        <!-- Security Tab -->
                        <MudTabPanel Text='@L["Profile_Tab_Security"]' Icon="@Icons.Material.Filled.Security">
                            <EditForm Model="@_passwordModel" OnValidSubmit="ChangePassword">
                                <DataAnnotationsValidator />

                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_passwordModel.CurrentPassword" Label='@L["Profile_Label_CurrentPassword"]'
                                            Variant="Variant.Outlined" InputType="InputType.Password" Required="true"
                                            For="@(() => _passwordModel.CurrentPassword)" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_passwordModel.NewPassword" Label='@L["Profile_Label_NewPassword"]'
                                            Variant="Variant.Outlined" InputType="InputType.Password" Required="true"
                                            For="@(() => _passwordModel.NewPassword)" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_passwordModel.ConfirmPassword"
                                            Label='@L["Profile_Label_ConfirmNewPassword"]' Variant="Variant.Outlined"
                                            InputType="InputType.Password" Required="true"
                                            For="@(() => _passwordModel.ConfirmPassword)" />
                                    </MudItem>
                                    <MudItem xs="12" Class="flex justify-end">
                                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                                            Color="Color.Primary" StartIcon="@Icons.Material.Filled.Lock"
                                            Class="btn-modern btn-primary" Disabled="_isChangingPassword">
                                            @if (_isChangingPassword)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>@L["Profile_Button_Changing"]</span>
                                            }
                                            else
                                            {
                                                <span>@L["Profile_Button_ChangePassword"]</span>
                                            }
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>
                            </EditForm>
                        </MudTabPanel>

                        <!-- Preferences Tab -->
                        <MudTabPanel Text='@L["Profile_Tab_Preferences"]' Icon="@Icons.Material.Filled.Settings">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudSwitch T="bool" @bind-Value="_profileModel.EmailNotificationsEnabled" Color="Color.Primary">
                                        @L["Profile_Label_EmailNotifications"]
                                    </MudSwitch>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @L["Profile_Helper_EmailNotifications"]
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12">
                                    <MudSwitch T="bool" @bind-Value="_profileModel.SMSNotificationsEnabled" Color="Color.Primary">
                                        @L["Profile_Label_SMSNotifications"]
                                    </MudSwitch>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @L["Profile_Helper_SMSNotifications"]
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12">
                                    <MudSelect T="string" @bind-Value="_profileModel.Theme" Label='@L["Profile_Label_Theme"]'
                                        Variant="Variant.Outlined">
                                        <MudSelectItem Value="@("light")">@L["Profile_Theme_Light"]</MudSelectItem>
                                        <MudSelectItem Value="@("dark")">@L["Profile_Theme_Dark"]</MudSelectItem>
                                        <MudSelectItem Value="@("auto")">@L["Profile_Theme_Auto"]</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" Class="flex justify-end">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                        StartIcon="@Icons.Material.Filled.Save" OnClick="SavePreferences"
                                        Class="btn-modern btn-primary" Disabled="_isSaving">
                                        @if (_isSaving)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                            <span>@L["Profile_Button_Saving"]</span>
                                        }
                                        else
                                        {
                                            <span>@L["Profile_Button_SavePreferences"]</span>
                                        }
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                    </MudTabs>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudStack>

@code {
    private UserDto? _currentUser;
    private UserReviewDetailsDto? _userDetails;
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isChangingPassword;

    private ProfileModel _profileModel = new();
    private PasswordModel _passwordModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        _isLoading = true;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdStr = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (Guid.TryParse(userIdStr, out var userId))
                {
                    _userDetails = await UserService.GetUserReviewDetailsAsync(userId);
                    _currentUser = _userDetails?.User;
                    
                    if (_currentUser != null)
                    {
                        _profileModel = new ProfileModel
                        {
                            FirstName = _currentUser.FirstName,
                            LastName = _currentUser.LastName,
                            Email = _currentUser.Email,
                            PhoneNumber = _currentUser.PhoneNumber,
                            City = _currentUser.City,
                            Country = _currentUser.Country,
                            Street = _currentUser.Street,
                            PostalCode = _currentUser.PostalCode,
                            PreferredLanguage = _currentUser.PreferredLanguage ?? "en",
                            Theme = _currentUser.Theme ?? "light",
                            EmailNotificationsEnabled = _currentUser.EmailNotificationsEnabled,
                            SMSNotificationsEnabled = _currentUser.SMSNotificationsEnabled
                        };
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Profile_Error_Load"], ex.Message), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveProfile()
    {
        _isSaving = true;
        try
        {
            if (_currentUser == null) return;

            var updateDto = new UpdateUserDto
            {
                Id = _currentUser.Id,
                FirstName = _profileModel.FirstName,
                LastName = _profileModel.LastName,
                PhoneNumber = _profileModel.PhoneNumber,
                City = _profileModel.City,
                Country = _profileModel.Country,
                Street = _profileModel.Street,
                PostalCode = _profileModel.PostalCode,
                PreferredLanguage = _profileModel.PreferredLanguage,
                Theme = _profileModel.Theme,
                EmailNotificationsEnabled = _profileModel.EmailNotificationsEnabled,
                SMSNotificationsEnabled = _profileModel.SMSNotificationsEnabled,
                ProfilePicture = _currentUser.ProfilePicture
            };

            var success = await UserService.UpdateUserAsync(_currentUser.Id, updateDto);
            
            if (success)
            {
                Snackbar.Add(L["Profile_Snackbar_UpdateSuccess"], Severity.Success);
                await LoadProfile();
            }
            else
            {
                Snackbar.Add(L["Profile_Snackbar_UpdateFailed"], Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task HandleAvatarUpload(IBrowserFile file)
    {
        if (file == null || _currentUser == null) return;

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 512000); // 500KB
            var path = await UserService.UpdateProfilePictureAsync(_currentUser.Id, stream, file.Name);
            
            if (path != null)
            {
                _currentUser.ProfilePicture = path;
                Snackbar.Add(L["Profile_Snackbar_UpdateSuccess"], Severity.Success);
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(L["Profile_Snackbar_UpdateFailed"], Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ChangePassword()
    {
        if (_passwordModel.NewPassword != _passwordModel.ConfirmPassword)
        {
            Snackbar.Add(L["Profile_Snackbar_PasswordMismatch"], Severity.Error);
            return;
        }

        _isChangingPassword = true;
        try
        {
            Snackbar.Add(L["Profile_Snackbar_PasswordChangeNotImplemented"], Severity.Info);
            _passwordModel = new PasswordModel();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isChangingPassword = false;
        }
    }

    private async Task SavePreferences()
    {
        await SaveProfile();
    }

    private Color GetRoleColor(string role) => role switch
    {
        "SuperRoot" => Color.Error,
        "Admin" => Color.Primary,
        "Manager" => Color.Info,
        "Student" => Color.Success,
        "CollegeRegistrar" => Color.Tertiary,
        _ => Color.Default
    };

    private class ProfileModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string? City { get; set; }
        public string? Country { get; set; }
        public string? Street { get; set; }
        public string? PostalCode { get; set; }
        public string? PreferredLanguage { get; set; }
        public string? Theme { get; set; }
        public bool EmailNotificationsEnabled { get; set; }
        public bool SMSNotificationsEnabled { get; set; }
    }

    private class PasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
