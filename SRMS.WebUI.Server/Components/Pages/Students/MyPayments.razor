@page "/student/payments"
@using SRMS.Application.Payments.Interfaces
@using SRMS.Application.Payments.DTOs
@using SRMS.Application.Identity.Interfaces
@using System.Security.Claims
@inject IPaymentService PaymentService
@inject IUserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Student")]
@rendermode InteractiveServer

<PageTitle>My Payments - SRMS</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="flex justify-between items-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="text-gradient">My Payments</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Track your payment history and pending dues</MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Payment"
            Class="btn-modern">
            Make Payment
        </MudButton>
    </div>

    <MudGrid>
        <MudItem xs="12" md="4">
            <MudPaper Class="glass-card p-4 text-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Color="Color.Warning" />
                <MudText Typo="Typo.h5" Class="mt-2">@_pendingAmount LYD</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Pending Dues</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="glass-card pa-4 text-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" />
                <MudText Typo="Typo.h5" Class="mt-2">@_totalPaidAmount LYD</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total Paid</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="glass-card pa-4 text-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Large" Color="Color.Info" />
                <MudText Typo="Typo.h5" Class="mt-2">@_payments.Count</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Transactions</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudTable Items="@_payments" Hover="true" Breakpoint="Breakpoint.Sm" Class="glass-card mt-4" Elevation="0">
        <HeaderContent>
            <MudTh>Date</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Action</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Date">@context.DueDate.ToShortDateString()</MudTd>
            <MudTd DataLabel="Description">@context.Description</MudTd>
            <MudTd DataLabel="Amount" Class="font-bold">@context.Amount @context.Currency</MudTd>
            <MudTd DataLabel="Status">
                @if (context.Status == SRMS.Domain.Payments.Enums.PaymentStatus.Paid)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">@context.Status.ToString()</MudChip>
                }
                else if (context.Status == SRMS.Domain.Payments.Enums.PaymentStatus.Overdue)
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small">@context.Status.ToString()</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">@context.Status.ToString()</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Action">
                <MudIconButton Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" Color="Color.Primary" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private List<PaymentDto> _payments = new();
    private decimal _pendingAmount = 0;
    private decimal _totalPaidAmount = 0;
    private Guid _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var email = user.Identity.Name;
            if (email != null)
            {
                var userDto = await UserService.GetUserByEmailAsync(email);
                if (userDto != null)
                {
                    _currentUserId = userDto.Id;
                    await LoadData();
                }
            }
        }
    }

    private async Task LoadData()
    {
        _payments = await PaymentService.GetStudentPaymentsAsync(_currentUserId);
        _pendingAmount = await PaymentService.GetPendingDuesAmountAsync(_currentUserId);
        _totalPaidAmount = await PaymentService.GetTotalPaidAmountAsync(_currentUserId);
    }
}
