@page "/payments"
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resource> L
@attribute [Authorize(Roles = "Manager,Admin,SuperRoot")]
@rendermode InteractiveServer

<PageTitle>@L["PaymentsManagement_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Payment" Class="mr-2" />
                    @L["PaymentsManagement_Header"]
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @L["PaymentsManagement_Subheader"]
                </MudText>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                OnClick="@RecordPayment">
                @L["PaymentsManagement_Button_RecordPayment"]
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Statistics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@L["PaymentsManagement_Stats_TotalRevenue"]</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">45,000 LYD</MudText>
                        </div>
                        <MudAvatar Color="Color.Success" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer" @onclick="@(() => FilterByStatus("Paid"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@L["PaymentsManagement_Stats_Paid"]</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Success">87</MudText>
                        </div>
                        <MudAvatar Color="Color.Success" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer" @onclick="@(() => FilterByStatus("Pending"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@L["PaymentsManagement_Stats_Pending"]</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Warning">23</MudText>
                        </div>
                        <MudAvatar Color="Color.Warning" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer" @onclick="@(() => FilterByStatus("Overdue"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@L["PaymentsManagement_Stats_Overdue"]</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Error">8</MudText>
                        </div>
                        <MudAvatar Color="Color.Error" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Filters -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="_searchString" Label='@L["PaymentsManagement_SearchPlaceholder"]' Variant="Variant.Outlined"
                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="_statusFilter" Label='@L["PaymentsManagement_Filter_Status"]' Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("Paid")">@L["PaymentsManagement_Stats_Paid"]</MudSelectItem>
                    <MudSelectItem Value="@("Pending")">@L["PaymentsManagement_Stats_Pending"]</MudSelectItem>
                    <MudSelectItem Value="@("Overdue")">@L["PaymentsManagement_Stats_Overdue"]</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="int?" @bind-Value="_monthFilter" Label='@L["PaymentsManagement_Filter_Month"]' Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    @for (int i = 1; i <= 12; i++)
                    {
                        var month = i;
                        <MudSelectItem Value="@month">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="int?" @bind-Value="_yearFilter" Label='@L["PaymentsManagement_Filter_Year"]' Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@(2024)">2024</MudSelectItem>
                    <MudSelectItem Value="@(2025)">2025</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Payments Table -->
    <MudPaper Elevation="4">
        <MudTable Items="@_payments" Hover="true" Striped="true" Dense="true" Loading="@_isLoading">
            <HeaderContent>
                <MudTh>@L["PaymentsManagement_Table_Header_PaymentID"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_Student"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_Description"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_Amount"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_Period"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_DueDate"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_Status"]</MudTh>
                <MudTh>@L["PaymentsManagement_Table_Header_PaidDate"]</MudTh>
                <MudTh Class="text-right">@L["PaymentsManagement_Table_Header_Actions"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">
                    <MudText Typo="Typo.caption">@context.Id.ToString().Substring(0, 8)...</MudText>
                </MudTd>
                <MudTd DataLabel="Student">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2"><strong>@context.StudentName</strong></MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@L["PaymentsManagement_Table_ReservationID"]
	                            @context.ReservationId.ToString().Substring(0, 8)...</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Description">
                    <MudText Typo="Typo.body2">@context.Description</MudText>
                </MudTd>
                <MudTd DataLabel="Amount">
                    <MudText Typo="Typo.body2"><strong>@context.Amount</strong></MudText>
                </MudTd>
                <MudTd DataLabel="Period">
                    <MudText Typo="Typo.body2">@context.Period</MudText>
                </MudTd>
                <MudTd DataLabel="Due Date">
                    <MudText Typo="Typo.caption">
                        @context.DueDate.ToString("MMM dd, yyyy")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)"
                        Icon="@GetStatusIcon(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Paid Date">
                    @if (context.PaidAt.HasValue)
                    {
                        <MudText Typo="Typo.caption">
                            @context.PaidAt.Value.ToString("MMM dd, yyyy")
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@L["PaymentsManagement_Table_NA"]</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Actions" Class="text-right">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" Href="@($"/payments/{context.Id}")">
                            @L["PaymentsManagement_Actions_ViewDetails"]
                        </MudMenuItem>
                        @if (context.Status == PaymentStatus.Pending || context.Status == PaymentStatus.Overdue)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success"
                                OnClick="@(() => MarkAsPaid(context.Id))">
                                @L["PaymentsManagement_Actions_MarkAsPaid"]
                            </MudMenuItem>
                        }
                        <MudMenuItem Icon="@Icons.Material.Filled.Receipt"
                            OnClick="@(() => GenerateReceipt(context.Id))">
                            @L["PaymentsManagement_Actions_GenerateReceipt"]
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditPayment(context.Id))">
                            @L["PaymentsManagement_Actions_Edit"]
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new[] { 10, 25, 50 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<PaymentDto> _payments = new();
    private bool _isLoading = true;

    private string _searchString = "";
    private string? _statusFilter;
    private int? _monthFilter;
    private int? _yearFilter;

    protected override async Task OnInitializedAsync()
    {
        await LoadPayments();
    }

    private async Task LoadPayments()
    {
        _isLoading = true;
        try
        {
            // TODO: Implement GetAllPaymentsQuery
            await Task.Delay(500);
            _payments = new List<PaymentDto>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterByStatus(string status)
    {
        _statusFilter = status;
        StateHasChanged();
    }

    private Color GetStatusColor(PaymentStatus status) => status switch
    {
        PaymentStatus.Paid => Color.Success,
        PaymentStatus.Pending => Color.Warning,
        PaymentStatus.Overdue => Color.Error,
        PaymentStatus.Cancelled => Color.Transparent,
        _ => Color.Default
    };

    private string GetStatusIcon(PaymentStatus status) => status switch
    {
        PaymentStatus.Paid => Icons.Material.Filled.CheckCircle,
        PaymentStatus.Pending => Icons.Material.Filled.HourglassEmpty,
        PaymentStatus.Overdue => Icons.Material.Filled.Warning,
        PaymentStatus.Cancelled => Icons.Material.Filled.Cancel,
        _ => Icons.Material.Filled.Payment
    };

    private void RecordPayment()
    {
        Snackbar.Add(L["PaymentsManagement_Snackbar_RecordPaymentComingSoon"].Value, Severity.Info);
    }

    private async Task MarkAsPaid(Guid paymentId)
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = L["PaymentsManagement_Snackbar_MarkAsPaidConfirm"].Value,
                ["ButtonText"] = L["PaymentsManagement_Snackbar_ConfirmPayment"].Value,
                ["Color"] = Color.Success
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Payment", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add(L["PaymentsManagement_Snackbar_PaymentMarkedAsPaid"].Value, Severity.Success);
            await LoadPayments();
        }
    }

    private void GenerateReceipt(Guid paymentId)
    {
        Snackbar.Add(L["PaymentsManagement_Snackbar_GeneratingReceipt"].Value, Severity.Info);
    }

    private void EditPayment(Guid paymentId)
    {
        Snackbar.Add(L["PaymentsManagement_Snackbar_EditPaymentComingSoon"].Value, Severity.Info);
    }
}
