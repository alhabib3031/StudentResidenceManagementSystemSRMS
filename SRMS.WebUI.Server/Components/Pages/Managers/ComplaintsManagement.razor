@page "/complaints"
@using Microsoft.Extensions.DependencyInjection
@using SRMS.Application.Complaints.AssignComplaint
@using SRMS.Application.Complaints.GetAllComplaints
@using SRMS.Application.Complaints.ResolveComplaint
@using Microsoft.Extensions.Localization
@using System.Security.Claims
@inject IServiceScopeFactory ScopeFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@inject IStringLocalizer<Resource> Localizer
@attribute [Authorize(Roles = "Manager,Admin,SuperRoot")]
@rendermode InteractiveServer

<PageTitle>@Localizer["ComplaintsManagement_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="p-4 md:p-6 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Class="text-2xl md:text-4xl font-bold flex items-center text-primary">
                    <MudIcon Icon="@Icons.Material.Filled.Report" Class="mr-2 text-3xl md:text-4xl" />
                    @Localizer["ComplaintsManagement_Header"]
                </MudText>
                <MudText Class="text-sm md:text-base text-secondary mt-1">
                    @Localizer["ComplaintsManagement_Subheader"]
                </MudText>
            </div>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Variant="Variant.Outlined" Color="Color.Primary"
                OnClick="@LoadComplaints" Class="rounded-xl border-2" />
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Statistics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer h-full"
            @onclick="@(() => FilterByStatus(ComplaintStatus.Open))">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["ComplaintsManagement_Stats_Open"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Color="Color.Warning" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-warning">@OpenCount</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer h-full"
            @onclick="@(() => FilterByStatus(ComplaintStatus.InProgress))">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["ComplaintsManagement_Stats_InProgress"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Autorenew" Color="Color.Info" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-info">@InProgressCount</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer h-full"
            @onclick="@(() => FilterByStatus(ComplaintStatus.Resolved))">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["ComplaintsManagement_Stats_Resolved"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success"
                                Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-success">@ResolvedCount</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer h-full" @onclick="@ClearFilters">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["ComplaintsManagement_Stats_Total"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Primary" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-primary">@_allComplaints.Count</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Filters -->
    <MudPaper Elevation="2" Class="p-4 mb-4 rounded-3xl">
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="_searchString" Label="@Localizer["ComplaintsManagement_SearchPlaceholder"]"
                    Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                    Margin="Margin.Dense" Immediate="true" DebounceInterval="300" />
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="ComplaintStatus?" @bind-Value="_statusFilter"
                    Label="@Localizer["ComplaintsManagement_Filter_Status"]" Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@((ComplaintStatus?)ComplaintStatus.Open)">
                        @Localizer["ComplaintsManagement_Stats_Open"]</MudSelectItem>
                    <MudSelectItem Value="@((ComplaintStatus?)ComplaintStatus.InProgress)">
                        @Localizer["ComplaintsManagement_Stats_InProgress"]</MudSelectItem>
                    <MudSelectItem Value="@((ComplaintStatus?)ComplaintStatus.Resolved)">
                        @Localizer["ComplaintsManagement_Stats_Resolved"]</MudSelectItem>
                    <MudSelectItem Value="@((ComplaintStatus?)ComplaintStatus.Closed)">@Localizer["Closed"]
                    </MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="ComplaintPriority?" @bind-Value="_priorityFilter"
                    Label="@Localizer["ComplaintsManagement_Filter_Priority"]" Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@((ComplaintPriority?)ComplaintPriority.Critical)">@Localizer["Critical"]
                    </MudSelectItem>
                    <MudSelectItem Value="@((ComplaintPriority?)ComplaintPriority.High)">@Localizer["High"]
                    </MudSelectItem>
                    <MudSelectItem Value="@((ComplaintPriority?)ComplaintPriority.Medium)">@Localizer["Medium"]
                    </MudSelectItem>
                    <MudSelectItem Value="@((ComplaintPriority?)ComplaintPriority.Low)">@Localizer["Low"]
                    </MudSelectItem>
                </MudSelect>
            </MudItem>


        </MudGrid>
    </MudPaper>

    <!-- Complaints Table -->
    <MudPaper Elevation="4" Class="rounded-3xl overflow-hidden shadow-lg">
        @if (!FilteredComplaints.Any() && !_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="p-8">
                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">@Localizer["ComplaintsManagement_NoComplaints_Header"]
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@Localizer["ComplaintsManagement_NoComplaints_Subheader"]
                </MudText>
            </MudStack>
        }
        else
        {
            <MudTable Items="@FilteredComplaints" Hover="true" Striped="true" Dense="true" Loading="@_isLoading"
                Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_ID"]</MudTh>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_Student"]</MudTh>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_Title"]</MudTh>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_Category"]</MudTh>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_Priority"]</MudTh>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_Status"]</MudTh>
                    <MudTh>@Localizer["ComplaintsManagement_Table_Header_Created"]</MudTh>
                    <MudTh Class="text-right">@Localizer["ComplaintsManagement_Table_Header_Actions"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_ID"]">
                        <MudText Typo="Typo.caption" Color="Color.Primary">@context.ComplaintNumber</MudText>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Student"]">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2"><strong>@context.StudentName</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @Localizer["ReservationID"]: @context.ReservationId.ToString().Substring(0, 8)...
                            </MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Title"]">
                        <MudText Typo="Typo.body2">@context.Title</MudText>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Category"]">
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">
                            @context.ComplaintType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Priority"]">
                        <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(context.Priority)">
                            @context.Priority
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Status"]">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Created"]">
                        <MudText Typo="Typo.caption">
                            @context.CreatedAt.ToString("MMM dd, yyyy")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="@Localizer["ComplaintsManagement_Table_Header_Actions"]" Class="text-right">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                            <MudMenuItem Icon="@Icons.Material.Filled.Visibility" Href="@($"/complaints/{context.Id}")">
                                @Localizer["ComplaintsManagement_Actions_ViewDetails"]
                            </MudMenuItem>
                            @if (context.Status == ComplaintStatus.Open)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.PersonAdd"
                                    OnClick="@(() => AssignComplaint(context.Id))">
                                    @Localizer["ComplaintsManagement_Actions_AssignToMe"]
                                </MudMenuItem>
                            }
                            @if (context.Status != ComplaintStatus.Resolved && context.Status != ComplaintStatus.Closed)
                            {
                                <MudDivider />
                                <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success"
                                    OnClick="@(() => ResolveComplaint(context.Id))">
                                    @Localizer["ComplaintsManagement_Actions_MarkAsResolved"]
                                </MudMenuItem>
                            }
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new[] { 10, 25, 50 }" />
                </PagerContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ComplaintDto> _allComplaints = new();
    private bool _isLoading = true;
    private Guid _currentUserId;

    private string _searchString = "";
    private ComplaintStatus? _statusFilter;
    private ComplaintPriority? _priorityFilter;


    private int OpenCount => _allComplaints.Count(c => c.Status == ComplaintStatus.Open);
    private int InProgressCount => _allComplaints.Count(c => c.Status == ComplaintStatus.InProgress);
    private int ResolvedCount => _allComplaints.Count(c => c.Status == ComplaintStatus.Resolved);

    private IEnumerable<ComplaintDto> FilteredComplaints => _allComplaints
    .Where(c => string.IsNullOrEmpty(_searchString) ||
    c.Title.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
    c.ComplaintNumber.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
    c.StudentName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
    .Where(c => _statusFilter == null || c.Status == _statusFilter)
    .Where(c => _priorityFilter == null || c.Priority == _priorityFilter);


    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserId();
        await LoadComplaints();
    }

    private async Task LoadCurrentUserId()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(userId, out var id))
            {
                _currentUserId = id;
            }
        }
    }

    private async Task LoadComplaints()
    {
        _isLoading = true;
        try
        {
            // ✅ Use ScopeFactory to create a fresh scope for this operation
            using var scope = ScopeFactory.CreateScope();
            var sender = scope.ServiceProvider.GetRequiredService<ISender>();

            _allComplaints = await sender.Send(new GetAllComplaintsQuery());
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Localizer["ErrorLoadingComplaints"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterByStatus(ComplaintStatus status)
    {
        _statusFilter = status;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        _searchString = "";
        _statusFilter = null;
        _priorityFilter = null;

        StateHasChanged();
    }

    private Color GetPriorityColor(ComplaintPriority priority) => priority switch
    {
        ComplaintPriority.Critical => Color.Error,
        ComplaintPriority.High => Color.Warning,
        ComplaintPriority.Medium => Color.Info,
        ComplaintPriority.Low => Color.Success,
        _ => Color.Default
    };

    private Color GetStatusColor(ComplaintStatus status) => status switch
    {
        ComplaintStatus.Open => Color.Warning,
        ComplaintStatus.InProgress => Color.Info,
        ComplaintStatus.Resolved => Color.Success,
        ComplaintStatus.Closed => Color.Transparent,
        _ => Color.Default
    };

    private async Task AssignComplaint(Guid complaintId)
    {
        try
        {
            // ✅ Use ScopeFactory for command execution
            using var scope = ScopeFactory.CreateScope();
            var sender = scope.ServiceProvider.GetRequiredService<ISender>();

            var command = new AssignComplaintCommand(complaintId, _currentUserId);
            await sender.Send(command);
            Snackbar.Add(Localizer["ComplaintsManagement_Snackbar_Assigned"], Severity.Success);
            await LoadComplaints();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Localizer["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task ResolveComplaint(Guid complaintId)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ResolveComplaintDialog>(Localizer["ResolveComplaintDialog_Title"], options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: string resolutionNotes })
        {
            try
            {
                // ✅ Use ScopeFactory for command execution
                using var scope = ScopeFactory.CreateScope();
                var sender = scope.ServiceProvider.GetRequiredService<ISender>();

                var command = new ResolveComplaintCommand(complaintId, resolutionNotes);
                await sender.Send(command);
                Snackbar.Add(Localizer["ComplaintsManagement_Snackbar_Resolved"], Severity.Success);
                await LoadComplaints();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"{Localizer["Error"]}: {ex.Message}", Severity.Error);
            }
        }
    }
}
