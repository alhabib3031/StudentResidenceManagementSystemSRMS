@page "/complaints"
@inject ISender Sender
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Manager,Admin,SuperRoot")]
@rendermode InteractiveServer

<PageTitle>Complaints Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Report" Class="mr-2" />
                    Complaints Management
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Track and resolve student complaints
                </MudText>
            </div>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Statistics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer" @onclick="@(() => FilterByStatus("Open"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Open</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Warning">12</MudText>
                        </div>
                        <MudAvatar Color="Color.Warning" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer" @onclick="@(() => FilterByStatus("InProgress"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">In Progress</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Info">8</MudText>
                        </div>
                        <MudAvatar Color="Color.Info" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Autorenew" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4" Class="cursor-pointer" @onclick="@(() => FilterByStatus("Resolved"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Resolved</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Success">45</MudText>
                        </div>
                        <MudAvatar Color="Color.Success" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Avg Resolution Time</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Primary">2.5<small>d</small></MudText>
                        </div>
                        <MudAvatar Color="Color.Primary" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Filters -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="_searchString" Label="Search" Variant="Variant.Outlined"
                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="_statusFilter" Label="Status" Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("Open")">Open</MudSelectItem>
                    <MudSelectItem Value="@("InProgress")">In Progress</MudSelectItem>
                    <MudSelectItem Value="@("Resolved")">Resolved</MudSelectItem>
                    <MudSelectItem Value="@("Closed")">Closed</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="_priorityFilter" Label="Priority" Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("Critical")">Critical</MudSelectItem>
                    <MudSelectItem Value="@("High")">High</MudSelectItem>
                    <MudSelectItem Value="@("Medium")">Medium</MudSelectItem>
                    <MudSelectItem Value="@("Low")">Low</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="_categoryFilter" Label="Category" Variant="Variant.Outlined"
                    Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("Maintenance")">Maintenance</MudSelectItem>
                    <MudSelectItem Value="@("Cleanliness")">Cleanliness</MudSelectItem>
                    <MudSelectItem Value="@("Noise")">Noise</MudSelectItem>
                    <MudSelectItem Value="@("Security")">Security</MudSelectItem>
                    <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Complaints Table -->
    <MudPaper Elevation="4">
        <MudTable Items="@_complaints" Hover="true" Striped="true" Dense="true" Loading="@_isLoading">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Student</MudTh>
                <MudTh>Title</MudTh>
                <MudTh>Category</MudTh>
                <MudTh>Priority</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Created</MudTh>
                <MudTh Class="text-right">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">
                    <MudText Typo="Typo.caption">@context.ComplaintNumber</MudText>
                </MudTd>
                <MudTd DataLabel="Student">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2"><strong>@context.StudentName</strong></MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">ID:
                            @context.StudentId.ToString().Substring(0, 8)...</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Title">
                    <MudText Typo="Typo.body2">@context.Title</MudText>
                </MudTd>
                <MudTd DataLabel="Category">
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">
                        @context.Category
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Priority">
                    <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(context.Priority)">
                        @context.Priority
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Created">
                    <MudText Typo="Typo.caption">
                        @context.CreatedAt.ToString("MMM dd, yyyy")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Actions" Class="text-right">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" Href="@($"/complaints/{context.Id}")">
                            View Details
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.PersonAdd"
                            OnClick="@(() => AssignComplaint(context.Id))">
                            Assign to Me
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success"
                            OnClick="@(() => ResolveComplaint(context.Id))">
                            Mark as Resolved
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new[] { 10, 25, 50 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<ComplaintDto> _complaints = new();
    private bool _isLoading = true;

    private string _searchString = "";
    private string? _statusFilter;
    private string? _priorityFilter;
    private string? _categoryFilter;

    protected override async Task OnInitializedAsync()
    {
        await LoadComplaints();
    }

    private async Task LoadComplaints()
    {
        _isLoading = true;
        try
        {
            // TODO: Implement GetAllComplaintsQuery
            await Task.Delay(500);
            _complaints = new List<ComplaintDto>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterByStatus(string status)
    {
        _statusFilter = status;
        StateHasChanged();
    }

    private Color GetPriorityColor(ComplaintPriority priority) => priority switch
    {
        ComplaintPriority.Critical => Color.Error,
        ComplaintPriority.High => Color.Warning,
        ComplaintPriority.Medium => Color.Info,
        ComplaintPriority.Low => Color.Success,
        _ => Color.Default
    };

    private Color GetStatusColor(ComplaintStatus status) => status switch
    {
        ComplaintStatus.Open => Color.Warning,
        ComplaintStatus.InProgress => Color.Info,
        ComplaintStatus.Resolved => Color.Success,
        ComplaintStatus.Closed => Color.Default,
        _ => Color.Default
    };

    private async Task AssignComplaint(Guid complaintId)
    {
        Snackbar.Add("Complaint assigned to you!", Severity.Success);
        await LoadComplaints();
    }

    private async Task ResolveComplaint(Guid complaintId)
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = "Mark this complaint as resolved? Please provide resolution details.",
                ["ButtonText"] = "Resolve",
                ["Color"] = Color.Success
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Resolve Complaint", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add("Complaint marked as resolved!", Severity.Success);
            await LoadComplaints();
        }
    }
}