@page "/forgot-password"
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject IAuthService AuthService
@* @inject NavigationManager Navigation *@
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["ForgotPassword_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="min-h-screen flex items-center justify-center">
    <MudPaper Elevation="8"
        Class="p-8 rounded-[20px] w-full bg-gradient-to-br from-[#667eea] to-[#764ba2] relative overflow-hidden">

        <!-- Decorative Elements -->
        <div class="absolute -top-[50px] -right-[50px] w-[200px] h-[200px] bg-white/10 rounded-full"></div>
        <div class="absolute -bottom-[30px] -left-[30px] w-[150px] h-[150px] bg-white/10 rounded-full"></div>

        <MudStack Class="relative z-10">
            <!-- Header -->
            <MudStack AlignItems="AlignItems.Center" Class="mb-6">
                <MudAvatar Size="Size.Large" Class="w-20 h-20 bg-white/20 mx-auto mb-5">
                    <MudIcon Icon="@Icons.Material.Filled.LockReset" Size="Size.Large" Class="text-white text-5xl" />
                </MudAvatar>
                <MudText Typo="Typo.h4" Class="text-white font-bold mb-2">@L["ForgotPassword_Header"]</MudText>
                <MudText Typo="Typo.body2" Class="text-white/90">
                    @L["ForgotPassword_Subheader"]
                </MudText>
            </MudStack>

            @if (!_emailSent)
            {
                <EditForm Model="@_model" OnValidSubmit="HandleForgotPassword" FormName="ForgotPasswordForm">
                    <DataAnnotationsValidator />

                    <MudCard Elevation="0" Class="bg-white rounded-2xl p-6">
                        <MudCardContent>
                            <MudTextField @bind-Value="_model.Email" Label='@L["ForgotPassword_Label_Email"]' Variant="Variant.Outlined"
                                InputType="InputType.Email" Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Email" AdornmentColor="Color.Primary"
                                For="@(() => _model.Email)" Required="true"
                                HelperText='@L["ForgotPassword_Helper_Email"]' Class="mb-4" />

                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                                FullWidth="true" Size="Size.Large" Disabled="@_isLoading"
                                Class="h-14 rounded-xl font-semibold normal-case text-base bg-gradient-to-br from-[#667eea] to-[#764ba2]">
                                @if (_isLoading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2 text-white" />
                                    <span>@L["ForgotPassword_Button_Sending"]</span>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Send" Class="mr-2" />
                                    <span>@L["ForgotPassword_Button_Send"]</span>
                                }
                            </MudButton>
                        </MudCardContent>
                    </MudCard>
                </EditForm>

                <!-- Back to Login -->
                <MudStack AlignItems="AlignItems.Center" Class="mt-4">
                    <MudButton Href="/login" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack"
                        Class="text-white normal-case font-medium">
                        @L["ForgotPassword_Button_BackToLogin"]
                    </MudButton>
                </MudStack>
            }
            else
            {
                <!-- Success Message -->
                <MudCard Elevation="0" Class="bg-white rounded-2xl p-8 text-center">
                    <MudCardContent>
                        <MudIcon Icon="@Icons.Material.Filled.MarkEmailRead" Size="Size.Large"
                            Class="text-emerald-500 text-[72px] mb-4" />
                        <MudText Typo="Typo.h5" Class="text-gray-800 font-semibold mb-3">
                            @L["ForgotPassword_Success_Header"]
                        </MudText>
                        <MudText Typo="Typo.body1" Class="text-gray-500 mb-6">
                            @((MarkupString)string.Format(L["ForgotPassword_Success_Subheader"], _model.Email))
                        </MudText>
                        <MudText Typo="Typo.body2" Class="text-gray-400 mb-6">
                            @L["ForgotPassword_Success_Spam"]
                        </MudText>

                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@ResetForm"
                            Class="rounded-xl normal-case font-medium mr-2">
                            @L["ForgotPassword_Button_TryAnotherEmail"]
                        </MudButton>

                        <MudButton Href="/login" Variant="Variant.Filled" Color="Color.Primary"
                            Class="rounded-xl normal-case font-medium bg-gradient-to-br from-[#667eea] to-[#764ba2]">
                            @L["ForgotPassword_Button_BackToLogin"]
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private ForgotPasswordDto _model = new();
    private bool _isLoading;
    private bool _emailSent;

    private async Task HandleForgotPassword()
    {
        _isLoading = true;

        try
        {
            var result = await AuthService.ForgotPasswordAsync(_model);

            if (result)
            {
                _emailSent = true;
                Snackbar.Add(
                L["ForgotPassword_Snackbar_Success"],
                Severity.Success,
                config =>
                {
                    config.VisibleStateDuration = 5000;
                    config.ShowCloseIcon = true;
                }
                );
            }
            else
            {
                Snackbar.Add(
                L["ForgotPassword_Snackbar_Failure"],
                Severity.Error,
                config => { config.ShowCloseIcon = true; }
                );
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(
            string.Format(L["ForgotPassword_Snackbar_Error"], ex.Message),
            Severity.Error,
            config => { config.ShowCloseIcon = true; }
            );
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ResetForm()
    {
        _emailSent = false;
        _model = new ForgotPasswordDto();
    }
}
