@page "/notifications"
@using Microsoft.Extensions.DependencyInjection
@using SRMS.Application.Notifications.Interfaces
@using SRMS.Application.Notifications.DTOs
@using SRMS.Domain.Notifications.Enums
@using System.Security.Claims
@using SRMS.Domain.Identity.Constants
@using SRMS.WebUI.Server.Components.Pages.Dialogs
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject NavigationManager Navigation
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IStringLocalizer<Resource> L
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>@L["Notifications_PageTitle"]</PageTitle>

<MudStack Class="animate-fade-in w-full modern-card">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
        <div class="flex flex-col">
            <MudText Class="text-3xl md:text-4xl font-bold text-gradient flex items-center">
                <MudIcon Icon="@Icons.Material.Filled.Notifications" Class="mr-2 text-4xl md:text-5xl" />
                @L["Notifications_Header"]
            </MudText>
            <MudText Class="text-sm md:text-base text-secondary mt-1">
                @L["Notifications_Subheader"]
            </MudText>
        </div>
        <div class="flex gap-2 self-end md:self-auto">
            @if (CanCreateNotification)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@OpenCreateDialog"
                    StartIcon="@Icons.Material.Filled.Add">
                    @L["Notifications_Button_Create"]
                </MudButton>
            }
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@MarkAllAsRead"
                StartIcon="@Icons.Material.Filled.DoneAll">
                @L["Notifications_Button_MarkAllRead"]
            </MudButton>
        </div>
    </div>

    <!-- Notification Filters -->
    <MudPaper Class="glass-card mb-4 p-4">
        <MudChipSet T="string" @bind-SelectedChip="_selectedFilter" Filter="true" Mandatory="true">
            <MudChip T="string" Text='@L["Notifications_Filter_All"]' Color="Color.Primary" Default="true">
                @L["Notifications_Filter_All"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_Unread"]' Color="Color.Error">
                @L["Notifications_Filter_Unread"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_Announcement"]' Color="Color.Secondary">
                @L["Notifications_Filter_Announcement"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_Info"]' Color="Color.Info">
                @L["Notifications_Filter_Info"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_Warning"]' Color="Color.Warning">
                @L["Notifications_Filter_Warning"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_System"]' Color="Color.Dark">
                @L["Notifications_Filter_System"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_Payments"]' Color="Color.Success">
                @L["Notifications_Filter_Payments"]</MudChip>
            <MudChip T="string" Text='@L["Notifications_Filter_Complaints"]' Color="Color.Surface">
                @L["Notifications_Filter_Complaints"]</MudChip>
        </MudChipSet>
    </MudPaper>

    <!-- Notifications List -->
    <MudPaper Class="glass-card p-4 mb-4">
        @if (_notifications.Any())
        {
            <MudList T="string" Clickable="true">
                @foreach (var notification in FilteredNotifications)
                {
                    <MudListItem T="string" Class="@GetNotificationClass(notification)"
                        OnClick="@(() => HandleNotificationClick(notification))">
                        <MudStack Row="true" AlignItems="AlignItems.Start">
                            <MudAvatar Color="@GetNotificationColor(notification)" Class="mr-3">
                                <MudIcon Icon="@GetNotificationIcon(notification)" />
                            </MudAvatar>
                            <MudStack Class="flex-grow-1" Spacing="1">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1"
                                            Class="@(notification.IsRead ? "font-normal" : "font-semibold")">
                                            @notification.Title
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @notification.Message
                                        </MudText>
                                    </MudStack>
                                    @if (!notification.IsRead)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Success" Size="Size.Small" />
                                    }
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Tertiary" Class="mt-2">
                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" />
                                    @notification.CreatedAt.ToString("MMM dd, yyyy - hh:mm tt")
                                </MudText>
                            </MudStack>
                        </MudStack>
                    </MudListItem>
                    <MudDivider />
                }
            </MudList>
        }
        else
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-8">
                <MudIcon Icon="@Icons.Material.Filled.NotificationsNone" Size="Size.Large" Color="Color.Secondary"
                    Class="text-[80px]" />
                <MudText Typo="Typo.h6" Class="mt-4">@L["Notifications_NoNotifications_Header"]</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @L["Notifications_NoNotifications_Subheader"]
                </MudText>
            </MudStack>
        }
    </MudPaper>
</MudStack>

@code {
    private MudChip<string>? _selectedFilter;
    private List<NotificationDto> _notifications = new();
    private string _currentUserRole;
    private Guid _currentUserId;

    private bool CanCreateNotification => _currentUserRole == Roles.SuperRoot || _currentUserRole == Roles.Admin ||
    _currentUserRole == Roles.Manager;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUserId = Guid.Parse(user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString());
            _currentUserRole = user.FindFirst(ClaimTypes.Role)?.Value ?? "";
            await LoadNotifications();
        }
    }

    private async Task LoadNotifications()
    {
        // Use ScopeFactory to avoid DbContext threading issues
        using var scope = ScopeFactory.CreateScope();
        var notificationService = scope.ServiceProvider.GetRequiredService<INotificationService>();

        _notifications = await notificationService.GetUserNotificationsAsync(_currentUserId, 0, 100);
    }

    private IEnumerable<NotificationDto> FilteredNotifications
    {
        get
        {
            if (_selectedFilter == null) return _notifications;

            return _selectedFilter.Text switch
            {
                "Unread" => _notifications.Where(n => !n.IsRead),
                "Announcement" => _notifications.Where(n => n.Type == NotificationType.Announcement),
                "Info" => _notifications.Where(n => n.Type == NotificationType.Info),
                "Warning" => _notifications.Where(n => n.Type == NotificationType.Warning),
                "System" => _notifications.Where(n => n.Type == NotificationType.System),
                "Payments" => _notifications.Where(n => n.Type == NotificationType.Payment),
                "Complaints" => _notifications.Where(n => n.Type == NotificationType.Complaint),
                _ => _notifications
            };
        }
    }

    private async Task HandleNotificationClick(NotificationDto notification)
    {
        if (!notification.IsRead)
        {
            using var scope = ScopeFactory.CreateScope();
            var notificationService = scope.ServiceProvider.GetRequiredService<INotificationService>();

            await notificationService.MarkAsReadAsync(notification.Id, _currentUserId);
            notification.IsRead = true;
            StateHasChanged();
        }
    }

    private async Task MarkAllAsRead()
    {
        using var scope = ScopeFactory.CreateScope();
        var notificationService = scope.ServiceProvider.GetRequiredService<INotificationService>();

        await notificationService.MarkAllAsReadAsync(_currentUserId);
        foreach (var notification in _notifications)
        {
            notification.IsRead = true;
        }
        StateHasChanged();
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters
        {
            { "CurrentUserRole", _currentUserRole }
        };

        var dialog = await DialogService.ShowAsync<CreateNotificationDialog>(L["Notifications_Button_Create"].Value, parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var data = (dynamic)result.Data;
            CreateNotificationDto notification = data.Notification;
            string audience = data.Audience;

            using var scope = ScopeFactory.CreateScope();
            var notificationService = scope.ServiceProvider.GetRequiredService<INotificationService>();

            bool success = false;
            if (audience == "All")
            {
                success = await notificationService.SendNotificationToAllAsync(notification);
            }
            else
            {
                success = await notificationService.SendNotificationToRoleAsync(audience, notification);
            }

            if (success)
            {
                Snackbar.Add(L["Notifications_Snackbar_SentSuccess"].Value, Severity.Success);
                await LoadNotifications(); // Refresh list if I sent it to myself too
            }
            else
            {
                Snackbar.Add(L["Notifications_Snackbar_SentFailed"].Value, Severity.Error);
            }
        }
    }

    private string GetNotificationClass(NotificationDto notification)
    {
        return notification.IsRead ? "py-3" : "py-3 modern-card hover-lift";
    }

    private Color GetNotificationColor(NotificationDto notification)
    {
        return notification.Type switch
        {
            NotificationType.System => Color.Info,
            NotificationType.Payment => Color.Success,
            NotificationType.Complaint => Color.Warning,
            _ => Color.Primary
        };
    }

    private string GetNotificationIcon(NotificationDto notification)
    {
        return notification.Type switch
        {
            NotificationType.System => Icons.Material.Filled.Info,
            NotificationType.Payment => Icons.Material.Filled.Payment,
            NotificationType.Complaint => Icons.Material.Filled.Report,
            _ => Icons.Material.Filled.Notifications
        };
    }
}
