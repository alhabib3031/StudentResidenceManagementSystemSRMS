@page "/reset-password"
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["ResetPassword_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="min-h-screen flex items-center justify-center modern-card">
    <MudPaper Elevation="8"
        Class="p-8 rounded-[20px] w-full bg-gradient-to-br from-[#f093fb] to-[#f5576c] relative overflow-hidden">

        <!-- Decorative Elements -->
        <div class="absolute -top-[50px] -right-[50px] w-[200px] h-[200px] bg-white/10 rounded-full"></div>
        <div class="absolute -bottom-[30px] -left-[30px] w-[150px] h-[150px] bg-white/10 rounded-full"></div>

        <MudStack Class="relative z-10">
            @if (!_isValidToken)
            {
                <!-- Invalid Token -->
                <MudStack AlignItems="AlignItems.Center" Class="mb-6">
                    <MudAvatar Size="Size.Large" Class="w-20 h-20 bg-white/20 mx-auto mb-5">
                        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Class="text-white text-5xl" />
                    </MudAvatar>
                    <MudText Typo="Typo.h4" Class="text-white font-bold mb-2">@L["ResetPassword_InvalidLink_Title"]</MudText>
                </MudStack>

                <MudCard Elevation="0" Class="bg-white rounded-2xl p-8 text-center">
                    <MudCardContent>
                        <MudText Typo="Typo.body1" Class="text-gray-500 mb-6">
                            @L["ResetPassword_InvalidLink_Message"]
                        </MudText>

                        <MudButton Href="/forgot-password" Variant="Variant.Filled" Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.LockReset"
                            Class="rounded-xl normal-case font-medium bg-gradient-to-br from-[#f093fb] to-[#f5576c]">
                            @L["ResetPassword_RequestNewLink"]
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            }
            else if (!_resetSuccess)
            {
                <!-- Reset Password Form -->
                <MudStack AlignItems="AlignItems.Center" Class="mb-6">
                    <MudAvatar Size="Size.Large" Class="w-20 h-20 bg-white/20 mx-auto mb-5">
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Class="text-white text-5xl" />
                    </MudAvatar>
                    <MudText Typo="Typo.h4" Class="text-white font-bold mb-2">@L["ResetPassword_Header_ResetYourPassword"]</MudText>
                    <MudText Typo="Typo.body2" Class="text-white/90">
                        @L["ResetPassword_EnterNewPassword"]
                    </MudText>
                </MudStack>

                <EditForm Model="@_model" OnValidSubmit="HandleResetPassword" FormName="ResetPasswordForm">
                    <DataAnnotationsValidator />

                    <MudCard Elevation="0" Class="bg-white rounded-2xl p-6">
                        <MudCardContent>
                            <!-- New Password -->
                            <MudTextField @bind-Value="_model.NewPassword" Label='@(L["ResetPassword_Label_NewPassword"])' Variant="Variant.Outlined"
                                InputType="@(_showPassword ? InputType.Text : InputType.Password)" Adornment="Adornment.End"
                                AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                OnAdornmentClick="TogglePasswordVisibility" AdornmentColor="Color.Primary"
                                For="@(() => _model.NewPassword)" Required="true"
                                HelperText='@(L["ResetPassword_Helper_PasswordRules"])' Class="mb-4" />

                            <!-- Confirm Password -->
                            <MudTextField @bind-Value="_model.ConfirmPassword" Label='@(L["ResetPassword_Label_ConfirmPassword"])'
                                Variant="Variant.Outlined"
                                InputType="@(_showPassword ? InputType.Text : InputType.Password)" Adornment="Adornment.End"
                                AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                OnAdornmentClick="TogglePasswordVisibility" AdornmentColor="Color.Primary"
                                For="@(() => _model.ConfirmPassword)" Required="true" Class="mb-4" />

                            <!-- Password Strength Indicator -->
                            <MudProgressLinear Color="@GetPasswordStrengthColor()" Value="@_passwordStrength"
                                Size="Size.Small" Class="mb-2 rounded" />
                            <MudText Typo="Typo.caption" Class="text-gray-500 mb-6 block">
                                @string.Format(L["ResetPassword_PasswordStrengthPrefix"].Value, GetPasswordStrengthText())
                            </MudText>

                            <!-- Submit Button -->
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                                FullWidth="true" Size="Size.Large" Disabled="@_isLoading"
                                Class="h-14 rounded-xl font-semibold normal-case text-base bg-gradient-to-br from-[#f093fb] to-[#f5576c]">
                                @if (_isLoading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2 text-white" />
                                    <span>@L["ResetPassword_Button_Resetting"]</span>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Class="mr-2" />
                                    <span>@L["ResetPassword_Button_ResetPassword"]</span>
                                }
                            </MudButton>
                        </MudCardContent>
                    </MudCard>
                </EditForm>

                <!-- Back to Login -->
                <MudStack AlignItems="AlignItems.Center" Class="mt-4">
                    <MudButton Href="/login" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack"
                        Class="text-white normal-case font-medium">
                        @L["ResetPassword_Button_BackToLogin"]
                    </MudButton>
                </MudStack>
            }
            else
            {
                <!-- Success Message -->
                <MudStack AlignItems="AlignItems.Center" Class="mb-6">
                    <MudAvatar Size="Size.Large" Class="w-20 h-20 bg-white/20 mx-auto mb-5">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Class="text-white text-5xl" />
                    </MudAvatar>
                    <MudText Typo="Typo.h4" Class="text-white font-bold mb-2">@L["ResetPassword_Success_Title"]</MudText>
                </MudStack>

                <MudCard Elevation="0" Class="bg-white rounded-2xl p-8 text-center">
                    <MudCardContent>
                        <MudIcon Icon="@Icons.Material.Filled.Celebration" Size="Size.Large"
                            Class="text-emerald-500 text-[72px] mb-4" />
                        <MudText Typo="Typo.h5" Class="text-gray-800 font-semibold mb-3">
                            @L["ResetPassword_Success_Title"]
                        </MudText>
                        <MudText Typo="Typo.body1" Class="text-gray-500 mb-6">
                            @L["ResetPassword_Success_Subtitle"]
                        </MudText>

                        <MudButton Href="/login" Variant="Variant.Filled" Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.Login"
                            Class="rounded-xl normal-case font-medium bg-gradient-to-br from-[#f093fb] to-[#f5576c]">
                            @L["ResetPassword_Button_GoToLogin"]
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private readonly ResetPasswordDto _model = new();
    private bool _showPassword;
    private bool _isLoading;
    private bool _resetSuccess;
    private bool _isValidToken = true;
    private int _passwordStrength;

    protected override void OnInitialized()
    {
        // Parse query parameters
        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        if (queryParams.TryGetValue("email", out var email) && queryParams.TryGetValue("token", out var token))
        {
            _model.Email = email!;
            // _model.Token = System.Net.WebUtility.UrlDecode(token);
            _model.Token = token!; // هنا لازم نحط شرط للتحقق من ان التوكن مش فارغ
            _isValidToken = true;
        }
        else
        {
            _isValidToken = false;
        }
    }

    protected override void OnParametersSet()
    {
        CalculatePasswordStrength();
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
    }

    private void CalculatePasswordStrength()
    {
        if (string.IsNullOrEmpty(_model.NewPassword))
        {
            _passwordStrength = 0;
            return;
        }

        var strength = 0;
        if (_model.NewPassword.Length >= 8) strength += 20;
        if (_model.NewPassword.Any(char.IsUpper)) strength += 20;
        if (_model.NewPassword.Any(char.IsLower)) strength += 20;
        if (_model.NewPassword.Any(char.IsDigit)) strength += 20;
        if (_model.NewPassword.Any(ch => !char.IsLetterOrDigit(ch))) strength += 20;

        _passwordStrength = strength;
    }

    private Color GetPasswordStrengthColor()
    {
        return _passwordStrength switch
        {
            <= 20 => Color.Error,
            <= 40 => Color.Warning,
            <= 60 => Color.Info,
            <= 80 => Color.Primary,
            _ => Color.Success
        };
    }

    private string GetPasswordStrengthText()
    {
        return _passwordStrength switch
        {
            <= 20 => L["ResetPassword_PasswordStrength_VeryWeak"],
            <= 40 => L["ResetPassword_PasswordStrength_Weak"],
            <= 60 => L["ResetPassword_PasswordStrength_Fair"],
            <= 80 => L["ResetPassword_PasswordStrength_Good"],
            _ => L["ResetPassword_PasswordStrength_Strong"]
        };
    }

    private async Task HandleResetPassword()
    {
        if (_model.NewPassword != _model.ConfirmPassword)
        {
            Snackbar.Add(L["ResetPassword_Error_PasswordsMismatch"].Value, Severity.Error);
            return;
        }

        _isLoading = true;

        try
        {
            var result = await AuthService.ResetPasswordAsync(_model);

            if (result)
            {
                _resetSuccess = true;
                Snackbar.Add(
                L["ResetPassword_Snackbar_ResetSuccess"].Value,
                Severity.Success,
                config =>
                {
                    config.VisibleStateDuration = 5000;
                    config.ShowCloseIcon = true;
                }
                );

                await Task.Delay(3000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                Snackbar.Add(
                L["ResetPassword_Error_FailedReset"].Value,
                Severity.Error,
                config => { config.ShowCloseIcon = true; }
                );
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(
            string.Format(L["ResetPassword_Error_GenericException"].Value, ex.Message),
            Severity.Error,
            config => { config.ShowCloseIcon = true; }
            );
        }
        finally
        {
            _isLoading = false;
        }
    }
}
