@using SRMS.Domain.Rooms.Enums
@using SRMS.Application.Rooms.CreateRoom
@using SRMS.Application.Rooms.Interfaces
@using SRMS.Application.Residences.DTOs
@using Microsoft.Extensions.Localization
@inject ISnackbar Snackbar
@inject ISender Sender
@inject IRoomService RoomService
@inject IStringLocalizer<Resource> L

<MudDialog>
    <TitleContent>
        <MudText Class="text-xl md:text-2xl font-bold flex items-center">
            <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Class="mr-2" />
            @L["CreateRoomDialog_Title"]
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_success">
            <MudGrid>
                <!-- Residence Selection -->
                <MudItem xs="12">
                     <MudSelect T="Guid" Label="@L["Room_Residence"]" @bind-Value="_model.ResidenceId" 
                                Required="true" RequiredError="@L["Room_Residence_Required"]"
                                Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter"
                                Disabled="@(_isResidencePreSelected)">
                        @if (_residences != null)
                        {
                            foreach (var residence in _residences)
                            {
                                <MudSelectItem Value="@residence.Id">@residence.Name</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.RoomNumber" Label='@L["Room_RoomNumber"]' 
                        Required="true" RequiredError='@L["Room_RoomNumber_Required"]' 
                        Variant="Variant.Outlined" />
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_model.Floor" Label='@L["Room_Floor"]' 
                        Min="0" Max="100" Required="true" Variant="Variant.Outlined" />
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_model.TotalBeds" Label='@L["Room_TotalBeds"]' 
                        Min="1" Max="10" Required="true" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_model.RoomType" Label='@L["Room_RoomType"]' 
                        Required="true" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        @foreach (RoomType type in Enum.GetValues(typeof(RoomType)))
                        {
                            <MudSelectItem Value="@type">@L[type.ToString()]</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_model.MonthlyRentAmount" Label='@L["Room_MonthlyRentAmount"]'
                                     Required="true" RequiredError='@L["Room_MonthlyRentAmount_Required"]'
                                     Variant="Variant.Outlined" Min="0" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_model.MonthlyRentCurrency" Label='@L["Room_MonthlyRentCurrency"]'
                               Required="true" RequiredError='@L["Room_MonthlyRentCurrency_Required"]'
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("USD")">@L["Currency_USD"]</MudSelectItem>
                        <MudSelectItem Value="@("LYD")">@L["Currency_LYD"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Class="text-base font-semibold mb-2">@L["Room_Amenities"]</MudText>
                    <MudStack Row="true" Wrap="Wrap.Wrap">
                        <MudCheckBox @bind-Value="@_model.HasPrivateBathroom" Label='@L["Amenity_Bathroom"]' Color="Color.Primary" />
                        <MudCheckBox @bind-Value="@_model.HasAirConditioning" Label='@L["Amenity_AC"]' Color="Color.Primary" />
                        <MudCheckBox @bind-Value="@_model.HasHeating" Label='@L["Amenity_Heating"]' Color="Color.Primary" />
                        <MudCheckBox @bind-Value="@_model.HasWifi" Label='@L["Amenity_WiFi"]' Color="Color.Primary" />
                        <MudCheckBox @bind-Value="@_model.HasDesk" Label='@L["Amenity_Desk"]' Color="Color.Primary" />
                        <MudCheckBox @bind-Value="@_model.HasWardrobe" Label='@L["Amenity_Wardrobe"]' Color="Color.Primary" />
                        <MudCheckBox @bind-Value="@_model.HasBalcony" Label='@L["Amenity_Balcony"]' Color="Color.Primary" />
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">@L["Common_Cancel"]</MudButton>
        <MudButton Color="Color.Primary" OnClick="@Submit" Disabled="@(!_success || _isSubmitting)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @L["Common_Create"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid ResidenceId { get; set; }

    private MudForm _form = null!;
    private bool _success;
    private bool _isSubmitting;
    private readonly CreateRoomDto _model = new();
    private List<ResidenceDto> _residences = new();
    private bool _isResidencePreSelected = false;

    protected override async Task OnInitializedAsync()
    {
        // Load all residences
        _residences = await RoomService.GetAllResidencesAsync();

        if (ResidenceId != Guid.Empty)
        {
            _model.ResidenceId = ResidenceId;
            _isResidencePreSelected = true;
        }
    }
    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        _isSubmitting = true;
        try
        {
            var command = new CreateRoomCommand { Room = _model };
            var result = await Sender.Send(command);

            Snackbar.Add(L["RoomManagement_Snackbar_Created"].Value, Severity.Success);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Common_Error_Exception"].Value, ex.Message), Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
