@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject IStringLocalizer<Resource> L
@using SRMS.Application.Identity.Interfaces
@inject IRoleService RoleService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="mr-2" />
            @L["CreateRoleDialog_Title"]
        </MudText>
    </TitleContent>
    
    <DialogContent>
        <MudStack Spacing="3">
            <MudAlert Severity="Severity.Info" Dense="true">
                @L["CreateRoleDialog_Description"]
            </MudAlert>

            <MudTextField 
                @bind-Value="_roleName"
                Label='@L["CreateRoleDialog_RoleName_Label"]'
                Variant="Variant.Outlined"
                Placeholder='@L["CreateRoleDialog_RoleName_Placeholder"]'
                HelperText='@L["CreateRoleDialog_RoleName_HelperText"]'
                Required="true"
                Immediate="true"
                OnKeyUp="ValidateRoleName" />

            <MudTextField 
                @bind-Value="_description"
                Label='@L["CreateRoleDialog_Description_Label"]'
                Variant="Variant.Outlined"
                Lines="3"
                Placeholder='@L["CreateRoleDialog_Description_Placeholder"]'
                HelperText='@L["CreateRoleDialog_Description_HelperText"]'
                MaxLength="500" />

            <!-- Role Preview -->
            @if (!string.IsNullOrWhiteSpace(_roleName))
            {
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@L["CreateRoleDialog_Preview"]</MudText>
                    <MudChip 
                        T="string"
                        Size="Size.Small" 
                        Color="Color.Primary" 
                        Icon="@Icons.Material.Filled.Badge">
                        @_roleName
                    </MudChip>
                </MudPaper>
            }

            <!-- Validation Message -->
            @if (_validationMessage != null)
            {
                <MudAlert Severity="@(_isValid ? Severity.Success : Severity.Error)" Dense="true">
                    @_validationMessage
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">
            @L["CreateRoleDialog_Button_Cancel"]
        </MudButton>
        <MudButton 
            Color="Color.Primary" 
            Variant="Variant.Filled"
            OnClick="HandleSubmit"
            Disabled="@(!_isValid || _isSubmitting || string.IsNullOrWhiteSpace(_roleName))"
            StartIcon="@Icons.Material.Filled.Add">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @L["CreateRoleDialog_Button_Create"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    private string _roleName = "";
    private string _description = "";
    private bool _isSubmitting = false;
    private bool _isValid = false;
    private string? _validationMessage = null;

    private void ValidateRoleName()
    {
        if (string.IsNullOrWhiteSpace(_roleName))
        {
            _isValid = false;
            _validationMessage = null;
            return;
        }

        // Check for spaces
        if (_roleName.Contains(" "))
        {
            _isValid = false;
            _validationMessage = L["CreateRoleDialog_Validation_NoSpaces"];
            return;
        }

        // Check for special characters
        if (!System.Text.RegularExpressions.Regex.IsMatch(_roleName, @"^[a-zA-Z0-9_]+$"))
        {
            _isValid = false;
            _validationMessage = L["CreateRoleDialog_Validation_InvalidChars"];
            return;
        }

        // Check length
        if (_roleName.Length < 3)
        {
            _isValid = false;
            _validationMessage = L["CreateRoleDialog_Validation_MinLength"];
            return;
        }

        if (_roleName.Length > 50)
        {
            _isValid = false;
            _validationMessage = L["CreateRoleDialog_Validation_MaxLength"];
            return;
        }

        _isValid = true;
        _validationMessage = L["CreateRoleDialog_Validation_Valid"];
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;

        try
        {
            // Check if role already exists
            var exists = await RoleService.RoleExistsAsync(_roleName);
            
            if (exists)
            {
                Snackbar.Add(string.Format(L["CreateRoleDialog_Snackbar_Exists"], _roleName), Severity.Warning);
                _isSubmitting = false;
                return;
            }

            // Create the role
            var result = await RoleService.CreateRoleAsync(_roleName, _description);

            if (result)
            {
                Snackbar.Add(string.Format(L["CreateRoleDialog_Snackbar_Success"], _roleName), Severity.Success);
                MudDialog.Close(DialogResult.Ok(_roleName));
            }
            else
            {
                Snackbar.Add(L["CreateRoleDialog_Snackbar_Failure"], Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
