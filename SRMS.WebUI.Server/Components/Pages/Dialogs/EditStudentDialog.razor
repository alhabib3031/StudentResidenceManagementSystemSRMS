@using Microsoft.Extensions.Localization
@inject ISender Sender
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> L

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            @L["EditStudent_Title"]
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </div>
        }
        else if (_model == null)
        {
            <MudAlert Severity="Severity.Error">@L["StudentNotFound"]</MudAlert>
        }
        else
        {
            <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudGrid>
                    <!-- Personal Info -->
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.FirstName" Label="@L["FirstName"]" Variant="Variant.Outlined"
                                      For="@(() => _model.FirstName)" Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.LastName" Label="@L["LastName"]" Variant="Variant.Outlined"
                                      For="@(() => _model.LastName)" Required="true" />
                    </MudItem>

                    <!-- Contact Info -->
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.Email" Label="@L["Email"]" Variant="Variant.Outlined"
                                      InputType="InputType.Email" For="@(() => _model.Email)" Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.PhoneNumber" Label="@L["PhoneNumber"]" Variant="Variant.Outlined"
                                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Phone"
                                      For="@(() => _model.PhoneNumber)" />
                    </MudItem>

                    <!-- Address Info -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_model.AddressStreet" Label="@L["StreetAddress"]" Variant="Variant.Outlined"
                                      For="@(() => _model.AddressStreet)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.AddressCity" Label="@L["City"]" Variant="Variant.Outlined"
                                      For="@(() => _model.AddressCity)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.AddressState" Label="@L["State"]" Variant="Variant.Outlined"
                                      For="@(() => _model.AddressState)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.AddressPostalCode" Label="@L["PostalCode"]" Variant="Variant.Outlined"
                                      For="@(() => _model.AddressPostalCode)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.AddressCountry" Label="@L["Country"]" Variant="Variant.Outlined"
                                      For="@(() => _model.AddressCountry)" />
                    </MudItem>
                </MudGrid>
            </EditForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="@Cancel">@L["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@HandleSubmit"
                   Disabled="_isSubmitting || _isLoading || _model == null">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @L["SaveChanges"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid StudentId { get; set; }

    private UpdateStudentDto? _model;
    private bool _isLoading = true;
    private bool _isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudentData();
    }

    private async Task LoadStudentData()
    {
        _isLoading = true;
        try
        {
            var query = new GetStudentByIdQuery { Id = StudentId };
            var student = await Sender.Send(query);

            _model = new UpdateStudentDto
            {
                Id = student.Id,
                FirstName = student.FirstName,
                LastName = student.LastName,
                Email = student.Email ?? "",
                PhoneNumber = student.PhoneNumber,
                AddressStreet = student.Address,
                AddressCity = null,
                AddressState = null,
                AddressPostalCode = null,
                AddressCountry = "Libya"
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["ErrorLoadingStudent"].Value, ex.Message), Severity.Error);
            MudDialog.Cancel();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (_model == null) return;
        
        _isSubmitting = true;

        try
        {
            var command = new UpdateStudentCommand { Student = _model };
            var result = await Sender.Send(command);

            if (result != null)
            {
                Snackbar.Add(L["StudentUpdatedSuccess"].Value, Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(L["StudentUpdateFailed"].Value, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
