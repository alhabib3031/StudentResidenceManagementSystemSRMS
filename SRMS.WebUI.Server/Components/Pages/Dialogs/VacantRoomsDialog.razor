@using SRMS.Application.Reservations.DTOs
@using SRMS.Application.Rooms.DTOs
@using SRMS.Domain.Rooms.Enums
@using SRMS.Application.Reservations.Interfaces
@using SRMS.Application.Identity.Interfaces
@using System.Security.Claims
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IReservationService ReservationService
@inject IUserService UserService
@inject IStringLocalizer<Resource> L


<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="flex justify-center items-center" style="min-height: 300px;">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            </div>
        }
        else if (_vacantRooms == null || !_vacantRooms.Any())
        {
            <MudAlert Severity="Severity.Info">
                <MudText>@L["VacantRooms_NoRooms"]</MudText>
            </MudAlert>
        }
        else
        {
            <MudGrid>
                @foreach (var room in _vacantRooms)
                {
                    var availableBeds = room.TotalBeds - room.OccupiedBeds;
                    var hasPrice = room.MonthlyRent != null && room.MonthlyRent.Amount > 0;

                    <MudItem xs="12" sm="6">
                        <MudCard Class="glass-card" Elevation="0">
                            <MudCardContent>
                                <div class="flex justify-between items-center mb-2">
                                    <MudText Class="text-lg font-bold">@L["VacantRooms_Room"] @room.RoomNumber</MudText>
                                    <MudChip T="string" Size="Size.Small"
                                        Color="@(room.Status == RoomStatus.Available ? Color.Success : Color.Warning)">
                                        @GetRoomStatusText(room.Status)
                                    </MudChip>
                                </div>

                                <MudDivider Class="my-2" />

                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Stairs" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Class="text-sm">@L["VacantRooms_Floor"]: <strong>@room.Floor</strong></MudText>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small"
                                            Color="Color.Primary" />
                                        <MudText Class="text-sm">@L["VacantRooms_Type"]: <strong>@GetRoomTypeText(room.RoomType)</strong>
                                        </MudText>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Class="text-sm">
                                            @L["VacantRooms_Beds"]: <strong style="color: var(--mud-palette-success);">@availableBeds /
                                                @room.TotalBeds</strong>
                                        </MudText>
                                    </div>

                                    @if (hasPrice)
                                    {
                                        <div class="flex items-center gap-2">
                                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small"
                                                Color="Color.Success" />
                                            <MudText Class="text-sm">
                                                @L["VacantRooms_Monthly"]:
                                                <strong style="color: var(--mud-palette-success); font-size: 1.1em;">
                                                    @room.MonthlyRent.Amount @room.MonthlyRent.Currency
                                                </strong>
                                            </MudText>
                                        </div>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Warning" Dense="true" Class="my-2">
                                            <MudText Class="text-xs">@L["Reservation_Error_RentNotAvailable"]</MudText>
                                        </MudAlert>
                                    }
                                </div>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                    Disabled="@(!hasPrice)" OnClick="@(() => SelectRoomForBooking(room))">
                                    @(hasPrice ? L["VacantRooms_Select"] : L["Reservation_Error_RentNotAvailable"])
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">@L["Common_Close"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid ResidenceId { get; set; }

    [Parameter]
    public string ResidenceName { get; set; } = string.Empty;

    private List<RoomAvailabilityDto>? _vacantRooms;
    private bool _isLoading = true;
    private Guid _studentId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudentId();
        await LoadVacantRooms();
    }

    private async Task LoadStudentId()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                // Try to get StudentId from claims first
                var studentIdClaim = user.FindFirst("StudentId");
                if (studentIdClaim != null && Guid.TryParse(studentIdClaim.Value, out var claimId))
                {
                    _studentId = claimId;
                }
                else
                {
                    // Fallback: Get User ID and look up student details via UserService
                    var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
                    if (Guid.TryParse(userIdClaim?.Value, out var userId))
                    {
                        var userDto = await UserService.GetUserByIdAsync(userId);
                        if (userDto?.StudentId != null)
                        {
                            _studentId = userDto.StudentId.Value;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading student ID: {ex.Message}");
        }
    }

    private async Task LoadVacantRooms()
    {
        _isLoading = true;
        try
        {
            var response = await ReservationService.GetVacantRoomsByResidenceAsync(ResidenceId);
            _vacantRooms = response?.Where(r => r.MonthlyRent != null && r.MonthlyRent.Amount > 0).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["VacantRooms_Loading"].Value}: {ex.Message}", Severity.Error);
            Console.WriteLine($"Error loading vacant rooms: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SelectRoomForBooking(RoomAvailabilityDto room)
    {
        if (_studentId == Guid.Empty)
        {
            Snackbar.Add(L["Reservation_Error_StudentIdMissingAction"].Value, Severity.Error);
            return;
        }

        var parameters = new DialogParameters
{
{ "ResidenceId", ResidenceId },
{ "ResidenceName", ResidenceName },
{ "Room", room },
{ "StudentId", _studentId }
};

        var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

        var dialog = await DialogService.ShowAsync<BookingConfirmationDialog>(L["ConfirmWithTextDialog_Title"].Value, parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Close this dialog and refresh parent
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private string GetRoomStatusText(RoomStatus status)
    {
        return status switch
        {
            RoomStatus.Available => L["Available"].Value,
            RoomStatus.Occupied => L["Occupied"].Value,
            RoomStatus.Maintenance => L["Maintenance"].Value,
            RoomStatus.Reserved => L["Reserved"].Value,
            _ => L["Unknown"].Value
        };
    }

    private string GetRoomTypeText(RoomType roomType)
    {
        return roomType switch
        {
            RoomType.Single => L["Single"].Value,
            RoomType.Double => L["Double"].Value,
            RoomType.Triple => L["Triple"].Value,
            RoomType.Quad => L["Quad"].Value,
            _ => L["Unknown"].Value
        };
    }

    [Inject]
    private IDialogService DialogService { get; set; } = null!;
}
