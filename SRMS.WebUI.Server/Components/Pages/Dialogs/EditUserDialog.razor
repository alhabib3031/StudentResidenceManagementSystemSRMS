@using Microsoft.Extensions.Localization
@inject IUserService UserService
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> L

<MudDialog>
    <TitleContent>
        <MudText Class="text-xl md:text-2xl font-bold flex items-center">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            @L["EditUserDialog_Title"]
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_isLoading)
        {
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudGrid>
                    <!-- Personal Info -->
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.FirstName" Label='@L["EditUserDialog_FirstName"]' Variant="Variant.Outlined"
                            For="@(() => _model.FirstName)" Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.LastName" Label='@L["EditUserDialog_LastName"]' Variant="Variant.Outlined"
                            For="@(() => _model.LastName)" Required="true" />
                    </MudItem>

                    <!-- Contact Info -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_model.PhoneNumber" Label='@L["EditUserDialog_PhoneNumber"]' Variant="Variant.Outlined"
                            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Phone"
                            For="@(() => _model.PhoneNumber)" Placeholder="+218 91 234 5678" />
                    </MudItem>

                    <!-- Address Info -->
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.City" Label='@L["EditUserDialog_City"]' Variant="Variant.Outlined"
                            For="@(() => _model.City)" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.Country" Label='@L["EditUserDialog_Country"]' Variant="Variant.Outlined"
                            For="@(() => _model.Country)" />
                    </MudItem>

                    <!-- Preferences -->
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string" Label='@L["EditUserDialog_Language"]' @bind-Value="_model.PreferredLanguage"
                            Variant="Variant.Outlined">
                            <MudSelectItem Value="@("ar-LY")">@L["EditUserDialog_Language_Arabic"]</MudSelectItem>
                            <MudSelectItem Value="@("en-US")">@L["EditUserDialog_Language_English"]</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="string" Label='@L["EditUserDialog_Theme"]' @bind-Value="_model.Theme" Variant="Variant.Outlined">
                            <MudSelectItem Value="@("Light")">@L["EditUserDialog_Theme_Light"]</MudSelectItem>
                            <MudSelectItem Value="@("Dark")">@L["EditUserDialog_Theme_Dark"]</MudSelectItem>
                            <MudSelectItem Value="@("System")">@L["EditUserDialog_Theme_System"]</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Notifications -->
                    <MudItem xs="12">
                        <MudSwitch @bind-Value="_model.EmailNotificationsEnabled" Color="Color.Primary"
                            Label='@L["EditUserDialog_EnableEmailNotifications"]' />
                    </MudItem>
                    <MudItem xs="12">
                        <MudSwitch @bind-Value="_model.SMSNotificationsEnabled" Color="Color.Primary"
                            Label='@L["EditUserDialog_EnableSMSNotifications"]' />
                    </MudItem>
                </MudGrid>
            </EditForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="@Cancel">@L["EditUserDialog_Button_Cancel"]</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@HandleSubmit"
            Disabled="_isSubmitting || _isLoading">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @L["EditUserDialog_Button_Save"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid UserId { get; set; }

    private UpdateUserDto _model = new();
    private bool _isLoading = true;
    private bool _isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        _isLoading = true;
        try
        {
            var user = await UserService.GetUserByIdAsync(UserId);
            if (user != null)
            {
                _model = new UpdateUserDto
                    {
                        Id = user.Id,
                        FirstName = user.FirstName,
                        LastName = user.LastName,
                        PhoneNumber = user.PhoneNumber,
                        City = user.City,
                        Country = user.Country,
                        PreferredLanguage = user.PreferredLanguage,
                        Theme = user.Theme,
                        EmailNotificationsEnabled = user.EmailNotificationsEnabled,
                        SMSNotificationsEnabled = user.SMSNotificationsEnabled
                        // Note: Street and PostalCode might be missing in UserDto, check if needed
                    };
            }
            else
            {
                Snackbar.Add(L["EditUserDialog_Snackbar_UserNotFound"].Value, Severity.Error);
                MudDialog.Cancel();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["EditUserDialog_Snackbar_LoadError"].Value, ex.Message), Severity.Error);
            MudDialog.Cancel();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;

        try
        {
            var success = await UserService.UpdateUserAsync(UserId, _model);

            if (success)
            {
                Snackbar.Add(L["EditUserDialog_Snackbar_UpdateSuccess"].Value, Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(L["EditUserDialog_Snackbar_UpdateFailed"].Value, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
