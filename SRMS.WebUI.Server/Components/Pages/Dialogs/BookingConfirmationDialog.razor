@using SRMS.Application.Reservations.DTOs
@using SRMS.Application.Rooms.DTOs
@using SRMS.Domain.Rooms.Enums
@using SRMS.Application.Reservations.Interfaces
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IReservationService ReservationService

<MudDialog>
    <DialogContent>
        <MudText Class="text-xl md:text-2xl font-bold mb-4 flex items-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</MudText>

        <MudPaper Class="glass-card pa-4 mb-4" Elevation="0">
            <MudText Class="text-base font-semibold text-primary mb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©</MudText>
            <MudDivider Class="mb-3" />

            <div class="flex flex-col gap-2">
                <div class="flex justify-between">
                    <MudText Class="text-sm text-secondary">Ø§Ù„Ø³ÙƒÙ†:</MudText>
                    <MudText Class="text-sm font-bold">@ResidenceName</MudText>
                </div>
                <div class="flex justify-between">
                    <MudText Class="text-sm text-secondary">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©:</MudText>
                    <MudText Class="text-sm font-bold">@Room.RoomNumber</MudText>
                </div>
                <div class="flex justify-between">
                    <MudText Class="text-sm text-secondary">Ø§Ù„Ø·Ø§Ø¨Ù‚:</MudText>
                    <MudText Class="text-sm font-bold">@Room.Floor</MudText>
                </div>
                <div class="flex justify-between">
                    <MudText Class="text-sm text-secondary">Ø§Ù„Ù†ÙˆØ¹:</MudText>
                    <MudText Class="text-sm font-bold">@GetRoomTypeText(Room.RoomType)</MudText>
                </div>
            </div>
        </MudPaper>

        <MudPaper Class="glass-card pa-4 mb-4" Elevation="0">
            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">ÙØªØ±Ø© Ø§Ù„Ø­Ø¬Ø²</MudText>
            <MudDivider Class="mb-3" />

            <MudDatePicker Label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" @bind-Date="_startDate" MinDate="DateTime.Today" Class="mb-3" />

            <MudDatePicker Label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" @bind-Date="_endDate" MinDate="_startDate?.AddDays(1)" Class="mb-3" />

            @if (DurationMonths > 0)
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudText Typo="Typo.body2">Ø§Ù„Ù…Ø¯Ø©: <strong>@DurationMonths Ø´Ù‡Ø± ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹</strong></MudText>
                </MudAlert>
            }
        </MudPaper>

        @if (!_showPayment)
        {
            <MudPaper Class="glass-card pa-4 mb-4" Elevation="0"
                Style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(139, 195, 74, 0.1) 100%);">
                <div class="flex justify-between items-center">
                    <MudText Class="text-lg font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº:</MudText>
                    <MudText Class="text-2xl font-bold text-success">
                        @TotalAmount @Room.MonthlyRent?.Currency
                    </MudText>
                </div>
                @if (DurationMonths > 0)
                {
                    <MudText Class="text-xs text-secondary">
                        (@Room.MonthlyRent?.Amount @Room.MonthlyRent?.Currency Ã— @DurationMonths Ø´Ù‡Ø±)
                    </MudText>
                }
            </MudPaper>
        }

        @if (_showPayment)
        {
            <MudPaper Class="glass-card pa-4 mb-4" Elevation="0">
                <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ (ÙˆÙ‡Ù…ÙŠ)</MudText>
                <MudDivider Class="mb-3" />

                <MudTextField @bind-Value="_cardNumber" Label="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" Variant="Variant.Outlined"
                    Mask="@(new PatternMask("0000 0000 0000 0000"))" Class="mb-3" Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.CreditCard" />

                <div class="flex gap-3">
                    <MudTextField @bind-Value="_expiryDate" Label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (MM/YY)" Variant="Variant.Outlined"
                        Mask="@(new PatternMask("00/00"))" Class="flex-1" />

                    <MudTextField @bind-Value="_cvv" Label="CVV" Variant="Variant.Outlined" Mask="@(new PatternMask("000"))"
                        InputType="InputType.Password" Class="flex-1" />
                </div>

                <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                    <MudText Typo="Typo.caption">Ù‡Ø°Ø§ Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·</MudText>
                </MudAlert>
            </MudPaper>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">@_errorMessage</MudAlert>
        }

        @if (_isProcessing)
        {
            <div class="flex flex-col items-center gap-3 py-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¬Ø²...</MudText>
            </div>
        }

        @if (_bookingSuccess)
        {
            <MudAlert Severity="Severity.Success" Class="mb-3">
                <MudText Typo="Typo.h6" Class="mb-2">ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</MudText>
                <MudText Typo="Typo.body2">Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²: <strong>@_reservationId</strong></MudText>
                <MudText Typo="Typo.body2">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹: <strong>@_paymentId</strong></MudText>
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        @if (!_bookingSuccess)
        {
            <MudButton OnClick="@Cancel" Disabled="_isProcessing">Ø¥Ù„ØºØ§Ø¡</MudButton>

            @if (!_showPayment)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@ProceedToPayment"
                    Disabled="_isProcessing || _startDate == null || _endDate == null || _endDate <= _startDate">
                    Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@ConfirmBooking"
                    Disabled="_isProcessing || string.IsNullOrWhiteSpace(_cardNumber) || string.IsNullOrWhiteSpace(_cvv)">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø¯ÙØ¹
                </MudButton>
            }
        }
        else
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CloseDialog">
                Ø¥ØºÙ„Ø§Ù‚
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid ResidenceId { get; set; }

    [Parameter]
    public string ResidenceName { get; set; } = string.Empty;

    [Parameter]
    public RoomAvailabilityDto Room { get; set; } = null!;

    [Parameter]
    public Guid StudentId { get; set; }

    private DateTime? _startDate = DateTime.Today;
    private DateTime? _endDate = DateTime.Today.AddMonths(1);
    private bool _showPayment = false;
    private bool _isProcessing = false;
    private bool _bookingSuccess = false;
    private string _errorMessage = string.Empty;
    private Guid _reservationId = Guid.Empty;
    private Guid _paymentId = Guid.Empty;

    // Payment fields
    private string _cardNumber = string.Empty;
    private string _expiryDate = string.Empty;
    private string _cvv = string.Empty;

    private int DurationMonths => _startDate.HasValue && _endDate.HasValue
    ? (int)Math.Ceiling((_endDate.Value - _startDate.Value).TotalDays / 30.0)
    : 0;

    private decimal TotalAmount => Room.MonthlyRent?.Amount * DurationMonths ?? 0;

    private void ProceedToPayment()
    {
        _errorMessage = string.Empty;

        if (_startDate == null || _endDate == null)
        {
            _errorMessage = "ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©";
            return;
        }

        if (_endDate <= _startDate)
        {
            _errorMessage = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©";
            return;
        }

        _showPayment = true;
    }

    private async Task ConfirmBooking()
    {
        _errorMessage = string.Empty;
        _isProcessing = true;

        try
        {
            if (string.IsNullOrWhiteSpace(_cardNumber) || string.IsNullOrWhiteSpace(_cvv))
            {
                _errorMessage = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©";
                return;
            }

            var request = new ReserveRoomRequest(
            StudentId,
            Room.Id,
            ResidenceId,
            _startDate!.Value,
            _endDate!.Value
            );

            // Use Service directly
            var result = await ReservationService.ReserveRoomAsync(request);

            _bookingSuccess = true;
            _reservationId = result.ReservationId;
            _paymentId = result.PaymentId;

            Snackbar.Add("ØªÙ… Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰", Severity.Success);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {ex.Message}";
            Console.WriteLine($"Booking error: {ex}");
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void CloseDialog()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    private string GetRoomTypeText(RoomType roomType)
    {
        return roomType switch
        {
            RoomType.Single => "ÙØ±Ø¯ÙŠØ©",
            RoomType.Double => "Ù…Ø²Ø¯ÙˆØ¬Ø©",
            RoomType.Triple => "Ø«Ù„Ø§Ø«ÙŠØ©",
            RoomType.Quad => "Ø±Ø¨Ø§Ø¹ÙŠØ©",
            _ => "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
        };
    }
}
