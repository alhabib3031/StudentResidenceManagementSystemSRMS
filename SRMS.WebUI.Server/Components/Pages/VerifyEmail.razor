@page "/verify-email"
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IServiceScopeFactory ScopeFactory
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["VerifyEmail_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="flex items-center justify-center min-h-screen p-5 modern-card">
    <MudPaper Elevation="0" Class="rounded-[20px] w-full bg-[#1e1b2e] p-10 relative overflow-hidden">

        <!-- Decorative Background Elements -->
        <div
            class="absolute -top-[100px] -right-[100px] w-[300px] h-[300px] bg-[radial-gradient(circle,rgba(103,58,183,0.2)_0%,transparent_70%)] rounded-full">
        </div>
        <div
            class="absolute -bottom-[80px] -left-[80px] w-[250px] h-[250px] bg-[radial-gradient(circle,rgba(233,30,99,0.2)_0%,transparent_70%)] rounded-full">
        </div>

        <MudStack Class="relative z-10">
            <!-- Header -->
            <MudStack AlignItems="AlignItems.Center" Class="mb-6">
                <MudText Typo="Typo.h3" Class="text-white font-bold mb-2">
                    @L["VerifyEmail_Header"]
                </MudText>
            </MudStack>

            @if (_isLoading)
            {
                <!-- Loading State -->
                <MudCard Elevation="4"
                    Class="bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 p-12 text-center animate-[fadeIn_0.5s_ease-out]">
                    <MudCardContent>
                        <MudProgressCircular Indeterminate="true" Size="Size.Large" Class="text-[#bb86fc] mb-6" />
                        <MudText Typo="Typo.h6" Class="text-white mb-2">
                            @L["VerifyEmail_VerifyingTitle"]
                        </MudText>

                        <MudText Typo="Typo.body2" Class="text-white/70">
                            @L["VerifyEmail_VerifyingMessage"]
                        </MudText>
                    </MudCardContent>
                </MudCard>
            }
            else if (_verificationSuccess)
            {
                <!-- Success State -->
                <MudCard Elevation="4"
                    Class="bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 p-12 text-center animate-[fadeIn_0.5s_ease-out]">
                    <MudCardContent>
                        <MudPaper Elevation="0"
                            Class="w-[100px] h-[100px] bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_10px_30px_rgba(16,185,129,0.3)]">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="text-white text-[60px]" />
                        </MudPaper>

                        <MudText Typo="Typo.h4" Class="text-white font-bold mb-3">
                            @L["VerifyEmail_Success_Title"]
                        </MudText>

                        <MudText Typo="Typo.body1" Class="text-white/80 mb-8 leading-relaxed">
                            @L["VerifyEmail_Success_Message"]
                        </MudText>

                        <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Large" OnClick="GoToLogin"
                            StartIcon="@Icons.Material.Filled.Login"
                            Class="rounded-xl normal-case font-semibold text-base px-8 py-3 bg-gradient-to-br from-emerald-500 to-emerald-600 shadow-[0_4px_15px_rgba(16,185,129,0.4)]">
                            @L["VerifyEmail_Button_LoginNow"]
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            }
            else
            {
                <!-- Error State -->
                <MudCard Elevation="4"
                    Class="bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 p-12 text-center animate-[fadeIn_0.5s_ease-out]">
                    <MudCardContent>
                        <!-- Error Alert Box -->
                        <MudAlert Severity="Severity.Error" Variant="Variant.Filled"
                            Icon="@Icons.Material.Filled.ErrorOutline"
                            Class="bg-red-500 rounded-xl mb-6 font-semibold text-base p-4">
                            @L["VerifyEmail_Error_AlertTitle"]
                        </MudAlert>

                        <!-- Error Message -->
                        <MudText Typo="Typo.body1" Class="text-red-500 mb-8 text-base leading-relaxed">
                            @_errorMessage
                        </MudText>

                        <!-- Try Again Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Large" FullWidth="true"
                            OnClick="GoToRegister"
                            Class="rounded-xl uppercase font-bold text-base p-4 bg-red-500 shadow-[0_4px_15px_rgba(239,68,68,0.4)] tracking-wide">
                            @L["VerifyEmail_Button_TryRegister"]
                        </MudButton>

                        <!-- Additional Help -->
                        <MudStack Class="mt-8 pt-6 border-t border-white/10">
                            <MudText Typo="Typo.body2" Class="text-white/60 mb-4">
                                @L["VerifyEmail_NeedHelp_Text"]
                            </MudText>

                            <MudStack Row="true" Justify="Justify.Center" Spacing="2">
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="GoToLogin"
                                    StartIcon="@Icons.Material.Filled.Login"
                                    Class="rounded-lg normal-case border-white/30 text-white">
                                    @L["VerifyEmail_Button_BackToLogin"]
                                </MudButton>

                                <MudButton Variant="Variant.Outlined" Color="Color.Default" Href="mailto:support@srms.com"
                                    StartIcon="@Icons.Material.Filled.Email"
                                    Class="rounded-lg normal-case border-white/30 text-white">
                                    @L["VerifyEmail_Button_ContactSupport"]
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private bool _isLoading = true;
    private bool _verificationSuccess = false;
    private string _errorMessage = "Email verification failed. The token might be invalid or expired.";

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        if (queryParams.TryGetValue("userId", out var userId) && queryParams.TryGetValue("code", out var code))
        {
            try
            {
                var decodedToken = System.Net.WebUtility.UrlDecode(code!);

                var dto = new VerifyEmailDto
                    {
                        UserId = Guid.Parse(userId!),
                        Token = decodedToken
                    };

                // Create a new scope for the authentication service to avoid threading issues
                using var scope = ScopeFactory.CreateScope();
                var authService = scope.ServiceProvider.GetRequiredService<IAuthService>();

                var result = await authService.VerifyEmailAsync(dto);

                if (result)
                {
                    _verificationSuccess = true;
                    Snackbar.Add(
                    L["VerifyEmail_Snackbar_Success"].Value,
                     Severity.Success,
                     config =>
                     {
                         config.VisibleStateDuration = 5000;
                         config.ShowCloseIcon = true;
                     }
                     );

                    // Auto-redirect after 5 seconds
                    _ = Task.Delay(5000).ContinueWith(_ =>
                    {
                        InvokeAsync(() => GoToLogin());
                    });
                }
                else
                {
                    _errorMessage = L["VerifyEmail_Error_DefaultMessage"].Value;
                }
            }
            catch (FormatException)
            {
                _errorMessage = L["VerifyEmail_Error_InvalidFormat"].Value;
            }
            catch (Exception ex)
            {
                _errorMessage = string.Format(L["VerifyEmail_Error_Exception"].Value, ex.Message);
            }
        }
        else
        {
            _errorMessage = L["VerifyEmail_Error_InvalidFormat"].Value;
        }

        _isLoading = false;
    }

    public void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public void GoToRegister()
    {
        Navigation.NavigateTo("/register");
    }
}
