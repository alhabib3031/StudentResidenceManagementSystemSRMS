@page "/superroot/audit"
@using Microsoft.Extensions.Localization
@using SRMS.Application.AuditLogs.Interfaces
@using SRMS.Domain.AuditLogs.Enums
@using SRMS.Domain.AuditLogs
@attribute [Authorize(Roles = "SuperRoot")]
@inject IUserService UserService
@inject IAuditService AuditService
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> Localizer
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>@Localizer["AuditLogs"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="p-6 md:p-8 mb-4 rounded-3xl glass-card">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Class="text-3xl md:text-5xl font-bold mb-2 text-gradient">
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-3 text-4xl md:text-5xl" />
                    @Localizer["AuditLogs"]
                </MudText>
                <MudText Class="text-base md:text-lg text-secondary pl-1">
                    @Localizer["TrackAllSystemActivitiesAndChanges"]
                </MudText>
            </div>
            <MudStack Row="true" Spacing="2">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Variant="Variant.Filled" Color="Color.Info"
                    OnClick="@LoadLogs" Disabled="@_isLoading" Class="rounded-xl shadow-md" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download"
                    OnClick="@ExportLogs" Disabled="@(_auditLog == null || !_auditLog.Any())"
                    Class="rounded-xl shadow-lg hidden md:flex">
                    @Localizer["ExportLogs"]
                </MudButton>
                <MudIconButton Icon="@Icons.Material.Filled.Download" Variant="Variant.Filled" Color="Color.Primary"
                    OnClick="@ExportLogs" Disabled="@(_auditLog == null || !_auditLog.Any())"
                    Class="flex md:hidden rounded-lg shadow-lg" />
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Statistics -->
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full glass-card rounded-2xl">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["TotalActions"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.TouchApp" Color="Color.Primary" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-primary">@_stats.TotalActions</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full glass-card rounded-2xl">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["Today"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Today" Color="Color.Success" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-success">@_stats.TodayActions</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full glass-card rounded-2xl">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["FailedActions"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-error">@_stats.FailedActions</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full glass-card rounded-2xl">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @Localizer["ActiveUsers"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Info" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-info">@_stats.activeUsers</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Filters -->
    <MudPaper Elevation="2" Class="p-4 md:p-6 mb-4 rounded-3xl glass-card">
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="_searchString" Label="@Localizer["Search"]" Variant="Variant.Outlined"
                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="_actionFilter" Label="@Localizer["ActionType"]"
                    Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("Create")">@Localizer["Create"]</MudSelectItem>
                    <MudSelectItem Value="@("Update")">@Localizer["Update"]</MudSelectItem>
                    <MudSelectItem Value="@("Delete")">@Localizer["Delete"]</MudSelectItem>
                    <MudSelectItem Value="@("Read User")">@Localizer["View"]</MudSelectItem>
                    <MudSelectItem Value="@("Login")">@Localizer["Login"]</MudSelectItem>
                    <MudSelectItem Value="@("Logout")">@Localizer["Logout"]</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="_entityFilter" Label="@Localizer["Entity"]"
                    Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("User")">@Localizer["User"]</MudSelectItem>
                    <MudSelectItem Value="@("Student")">@Localizer["Student"]</MudSelectItem>
                    <MudSelectItem Value="@("Manager")">@Localizer["Manager"]</MudSelectItem>
                    <MudSelectItem Value="@("Room")">@Localizer["Room"]</MudSelectItem>
                    <MudSelectItem Value="@("Payment")">@Localizer["Payment"]</MudSelectItem>
                    <MudSelectItem Value="@("Complaint")">@Localizer["Complaint"]</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudDateRangePicker @bind-DateRange="_dateRange" Label="@Localizer["DateRange"]"
                    Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Logs Table -->
    <MudPaper Elevation="4" Class="rounded-3xl overflow-hidden glass-card">
        <MudTable Items="@_auditLog" Hover="true" Striped="true" Dense="true" Loading="@_isLoading"
            Breakpoint="Breakpoint.Sm" Class="glass-table">
            <HeaderContent>
                <MudTh>@Localizer["Timestamp"]</MudTh>
                <MudTh>@Localizer["User"]</MudTh>
                <MudTh>@Localizer["Action"]</MudTh>
                <MudTh>@Localizer["Entity"]</MudTh>
                <MudTh>@Localizer["Details"]</MudTh>
                <MudTh>@Localizer["IpAddress"]</MudTh>
                <MudTh Class="text-right">@Localizer["Actions"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@Localizer["Timestamp"]">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@context.Timestamp.ToString("MMM dd, yyyy")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Timestamp.ToString("HH:mm:ss")
                        </MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="@Localizer["User"]">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2"><strong>@context.UserName</strong></MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.UserId</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="@Localizer["Action"]">
                    <MudChip T="string" Size="Size.Small" Color="@GetActionColor(context.Action)">
                        @context.Action
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="@Localizer["Entity"]">
                    <MudText Typo="Typo.body2">@context.EntityName</MudText>
                </MudTd>
                <MudTd DataLabel="@Localizer["AdditionalInfo"]">
                    <MudText Typo="Typo.caption" Class="max-w-[300px] overflow-hidden text-ellipsis">
                        @context.AdditionalInfo
                    </MudText>
                </MudTd>
                <MudTd DataLabel="@Localizer["IpAddress"]">
                    <MudText Typo="Typo.caption">@context.IpAddress</MudText>
                </MudTd>
                <MudTd DataLabel="@Localizer["Actions"]" Class="text-right">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small"
                        OnClick="@(() => ViewDetails(context))" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new[] { 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<AuditLog>? _auditLog = new();
    private (int TotalActions, int TodayActions, int FailedActions, int activeUsers) _stats = (0, 0, 0, 0);
    private bool _isLoading = true;
    private string _searchString = "";
    private string? _actionFilter;
    private string? _entityFilter;
    private DateRange? _dateRange;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        _isLoading = true;

        try
        {
            var activeUsers = (await UserService.GetActiveUsersAsync(log: false)).Count;
            _auditLog = (await AuditService.GetAllAsync()).ToList();

            var totalActions = _auditLog.Count;
            var todayActions = _auditLog.Count(log => log.Timestamp.Date == DateTime.UtcNow.Date);
            var failedActions = _auditLog.Count(log => log.AuditAction == AuditAction.Failure);

            _stats = (
            totalActions,
            todayActions,
            failedActions,
            activeUsers
            );

            Snackbar.Add(Localizer["LogsRefreshedSuccessfully"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Localizer["FailedToLoadLogs"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetActionColor(string action) => action switch
    {
        "Create" => Color.Success,
        "Update" => Color.Info,
        "Delete" => Color.Error,
        "View" => Color.Default,
        "Login" => Color.Primary,
        "Logout" => Color.Secondary,
        "Failure" => Color.Error,
        _ => Color.Default
    };

    private void ViewDetails(AuditLog log)
    {
        Snackbar.Add($"{Localizer["ViewingDetailsFor"]}: {log.AdditionalInfo}", Severity.Info);
    }

    private void ExportLogs()
    {
        NavigationManager.NavigateTo("api/export/audit-logs", forceLoad: true);
    }
}
