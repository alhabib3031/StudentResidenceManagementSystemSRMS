@page "/superroot/permissions"
@attribute [Authorize(Roles = "SuperRoot")]
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IRoleService RoleService
@inject NavigationManager NavigationManager
@using SRMS.Application.Identity.Constants
@rendermode InteractiveServer

<PageTitle>Permissions Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-2" />
                    Permissions Management
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Manage role-based permissions and access control
                </MudText>
            </div>
            <MudButton 
                Variant="Variant.Filled" 
                Color="Color.Primary"
                StartIcon="@Icons.Material.Filled.Add"
                OnClick="@CreatePermission">
                Create Permission
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Role Selector -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect 
                    T="string"
                    Value="_selectedRole"
                    ValueChanged="OnRoleChanged"
                    Label="Select Role to Manage"
                    Variant="Variant.Outlined"
                    Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Badge">
                    @foreach (var role in _allRoles)
                    {
                        <MudSelectItem Value="@role">
                            <div Class="flex items-center">
                                <MudIcon Icon="@GetRoleIcon(role)" Color="@GetRoleColor(role)" Class="mr-2" />
                                @role
                            </div>
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField 
                    @bind-Value="_searchString"
                    Label="Search Permissions"
                    Variant="Variant.Outlined"
                    Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Search"
                    Immediate="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect 
                    T="string"
                    @bind-Value="_categoryFilter"
                    Label="Filter by Category"
                    Variant="Variant.Outlined"
                    Clearable="true">
                    @foreach (var category in _categories.Select(c => c.Name))
                    {
                        <MudSelectItem Value="@category">@category</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Permission Categories -->
    <MudGrid>
        @foreach (var category in GetFilteredCategories())
        {
            <MudItem xs="12" md="6">
                <MudCard Elevation="4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@GetCategoryIcon(category.Name)" Class="mr-2" Size="Size.Small" />
                                @category.Name Permissions
                            </MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                @category.Permissions.Count(p => p.IsEnabled) / @category.Permissions.Count
                            </MudChip>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            @foreach (var permission in category.Permissions)
                            {
                                <MudListItem>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <div class="flex-1">
                                            <MudText Typo="Typo.body2"><strong>@permission.Name</strong></MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@permission.Description</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Tertiary" Class="font-mono">
                                                @permission.Key
                                            </MudText>
                                        </div>
                                        <MudSwitch 
                                            T="bool"
                                            @bind-Value="permission.IsEnabled"
                                            Color="Color.Success"
                                            Disabled="@IsSystemPermission(permission.Key)" />
                                    </MudStack>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton 
                            Size="Size.Small" 
                            Variant="Variant.Text" 
                            Color="Color.Primary"
                            OnClick="@(() => EnableAll(category))">
                            Enable All
                        </MudButton>
                        <MudButton 
                            Size="Size.Small" 
                            Variant="Variant.Text" 
                            Color="Color.Secondary"
                            OnClick="@(() => DisableAll(category))">
                            Disable All
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    <!-- Save Button -->
    <MudPaper Elevation="0" Class="pa-4 mt-4 text-center">
        <MudButton 
            Variant="Variant.Filled" 
            Color="Color.Primary"
            Size="Size.Large"
            StartIcon="@Icons.Material.Filled.Save"
            OnClick="@SavePermissions"
            Disabled="_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Saving Changes...</span>
            }
            else
            {
                <span>Save All Changes</span>
            }
        </MudButton>
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public string? Role { get; set; }

    private List<PermissionCategory> _categories = new();
    private List<string> _allRoles = new();
    private string _selectedRole = "Manager";
    private string _searchString = "";
    private string? _categoryFilter;
    private bool _isLoading = true;
    private bool _isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
        
        if (!string.IsNullOrEmpty(Role) && _allRoles.Contains(Role))
        {
            _selectedRole = Role;
        }
        
        await LoadPermissions();
    }

    private async Task LoadRoles()
    {
        try
        {
            _allRoles = await RoleService.GetAllRolesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading roles: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnRoleChanged(string role)
    {
        _selectedRole = role;
        await LoadPermissions();
    }

    private async Task LoadPermissions()
    {
        _isLoading = true;
        try
        {
            // Initialize default definitions
            InitializePermissionDefinitions();

            // Load enabled permissions for the selected role
            var rolePermissions = await RoleService.GetRolePermissionsAsync(_selectedRole);

            // Update IsEnabled state
            foreach (var category in _categories)
            {
                foreach (var permission in category.Permissions)
                {
                    permission.IsEnabled = rolePermissions.Contains(permission.Key);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading permissions: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void InitializePermissionDefinitions()
    {
        _categories = new List<PermissionCategory>
        {
            new()
            {
                Name = "Users",
                Permissions = new()
                {
                    new() { Key = Permissions.Users.View, Name = "View Users", Description = "View all users in the system" },
                    new() { Key = Permissions.Users.Create, Name = "Create Users", Description = "Create new user accounts" },
                    new() { Key = Permissions.Users.Edit, Name = "Edit Users", Description = "Modify user information" },
                    new() { Key = Permissions.Users.Delete, Name = "Delete Users", Description = "Delete user accounts" },
                    new() { Key = Permissions.Users.Manage, Name = "Manage Users", Description = "Full user management access" },
                    new() { Key = Permissions.Users.Activate, Name = "Activate Users", Description = "Activate suspended user accounts" },
                    new() { Key = Permissions.Users.Deactivate, Name = "Deactivate Users", Description = "Suspend user accounts" }
                }
            },
            new()
            {
                Name = "Students",
                Permissions = new()
                {
                    new() { Key = Permissions.Students.View, Name = "View Students", Description = "View student profiles" },
                    new() { Key = Permissions.Students.ViewOwn, Name = "View Own Profile", Description = "View own student profile" },
                    new() { Key = Permissions.Students.Edit, Name = "Edit Students", Description = "Modify student information" },
                    new() { Key = Permissions.Students.EditOwn, Name = "Edit Own Profile", Description = "Edit own student profile" },
                    new() { Key = Permissions.Students.Delete, Name = "Delete Students", Description = "Remove student records" },
                    new() { Key = Permissions.Students.Manage, Name = "Manage Students", Description = "Full student management" }
                }
            },
            new()
            {
                Name = "Managers",
                Permissions = new()
                {
                    new() { Key = Permissions.Managers.View, Name = "View Managers", Description = "View manager profiles" },
                    new() { Key = Permissions.Managers.Create, Name = "Create Managers", Description = "Create new managers" },
                    new() { Key = Permissions.Managers.Edit, Name = "Edit Managers", Description = "Modify manager information" },
                    new() { Key = Permissions.Managers.Delete, Name = "Delete Managers", Description = "Remove managers" },
                    new() { Key = Permissions.Managers.Manage, Name = "Manage Managers", Description = "Full manager management" }
                }
            },
            new()
            {
                Name = "Rooms",
                Permissions = new()
                {
                    new() { Key = Permissions.Rooms.View, Name = "View Rooms", Description = "View room information" },
                    new() { Key = Permissions.Rooms.Create, Name = "Create Rooms", Description = "Add new rooms" },
                    new() { Key = Permissions.Rooms.Edit, Name = "Edit Rooms", Description = "Modify room details" },
                    new() { Key = Permissions.Rooms.Delete, Name = "Delete Rooms", Description = "Remove rooms" },
                    new() { Key = Permissions.Rooms.Manage, Name = "Manage Rooms", Description = "Full room management" },
                    new() { Key = Permissions.Rooms.Assign, Name = "Assign Rooms", Description = "Assign students to rooms" }
                }
            },
            new()
            {
                Name = "Payments",
                Permissions = new()
                {
                    new() { Key = Permissions.Payments.View, Name = "View Payments", Description = "View payment records" },
                    new() { Key = Permissions.Payments.ViewOwn, Name = "View Own Payments", Description = "View own payment history" },
                    new() { Key = Permissions.Payments.ViewAll, Name = "View All Payments", Description = "View all payment records" },
                    new() { Key = Permissions.Payments.Create, Name = "Record Payments", Description = "Record new payments" },
                    new() { Key = Permissions.Payments.Edit, Name = "Edit Payments", Description = "Modify payment records" },
                    new() { Key = Permissions.Payments.Delete, Name = "Delete Payments", Description = "Remove payment records" }
                }
            },
            new()
            {
                Name = "Complaints",
                Permissions = new()
                {
                    new() { Key = Permissions.Complaints.View, Name = "View Complaints", Description = "View complaints" },
                    new() { Key = Permissions.Complaints.ViewOwn, Name = "View Own Complaints", Description = "View own complaints" },
                    new() { Key = Permissions.Complaints.Create, Name = "Submit Complaints", Description = "Create new complaints" },
                    new() { Key = Permissions.Complaints.Edit, Name = "Edit Complaints", Description = "Modify complaints" },
                    new() { Key = Permissions.Complaints.Delete, Name = "Delete Complaints", Description = "Remove complaints" },
                    new() { Key = Permissions.Complaints.Manage, Name = "Manage Complaints", Description = "Full complaint management" },
                    new() { Key = Permissions.Complaints.Resolve, Name = "Resolve Complaints", Description = "Mark complaints as resolved" }
                }
            },
            new()
            {
                Name = "Residences",
                Permissions = new()
                {
                    new() { Key = Permissions.Residences.View, Name = "View Residences", Description = "View residence information" },
                    new() { Key = Permissions.Residences.Create, Name = "Create Residences", Description = "Add new residences" },
                    new() { Key = Permissions.Residences.Edit, Name = "Edit Residences", Description = "Modify residence details" },
                    new() { Key = Permissions.Residences.Delete, Name = "Delete Residences", Description = "Remove residences" },
                    new() { Key = Permissions.Residences.Manage, Name = "Manage Residence", Description = "Manage assigned residence" },
                    new() { Key = Permissions.Residences.ManageAll, Name = "Manage All Residences", Description = "Full residence management" }
                }
            },
            new()
            {
                Name = "Assets",
                Permissions = new()
                {
                    new() { Key = Permissions.Assets.View, Name = "View Assets", Description = "View assets inventory" },
                    new() { Key = Permissions.Assets.Create, Name = "Create Assets", Description = "Add new assets" },
                    new() { Key = Permissions.Assets.Edit, Name = "Edit Assets", Description = "Modify asset details" },
                    new() { Key = Permissions.Assets.Delete, Name = "Delete Assets", Description = "Remove assets" },
                    new() { Key = Permissions.Assets.Manage, Name = "Manage Assets", Description = "Full assets management" }
                }
            },
            new()
            {
                Name = "System",
                Permissions = new()
                {
                    new() { Key = Permissions.System.ViewReports, Name = "View Reports", Description = "Access system reports" },
                    new() { Key = Permissions.System.Settings, Name = "System Settings", Description = "Modify system settings" },
                    new() { Key = Permissions.System.Audit, Name = "View Audit Logs", Description = "Access audit trail" },
                    new() { Key = Permissions.System.Configure, Name = "System Configuration", Description = "Configure system parameters" },
                    new() { Key = Permissions.Database.Manage, Name = "Database Management", Description = "Manage database operations" }
                }
            }
        };
    }

    private IEnumerable<PermissionCategory> GetFilteredCategories()
    {
        var filtered = _categories.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_categoryFilter))
        {
            filtered = filtered.Where(c => c.Name.Equals(_categoryFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            filtered = filtered.Where(c => 
                c.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                c.Permissions.Any(p => 
                    p.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                    p.Description.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                    p.Key.Contains(_searchString, StringComparison.OrdinalIgnoreCase)
                )
            );
        }

        return filtered;
    }

    private string GetCategoryIcon(string category) => category switch
    {
        "Users" => Icons.Material.Filled.People,
        "Students" => Icons.Material.Filled.School,
        "Managers" => Icons.Material.Filled.ManageAccounts,
        "Rooms" => Icons.Material.Filled.MeetingRoom,
        "Payments" => Icons.Material.Filled.Payment,
        "Complaints" => Icons.Material.Filled.Report,
        "Residences" => Icons.Material.Filled.Apartment,
        "Assets" => Icons.Material.Filled.Inventory,
        "System" => Icons.Material.Filled.Settings,
        _ => Icons.Material.Filled.Security
    };
    
    private string GetRoleIcon(string role) => role switch
    {
        "SuperRoot" => Icons.Material.Filled.Shield,
        "Admin" => Icons.Material.Filled.AdminPanelSettings,
        "Manager" => Icons.Material.Filled.ManageAccounts,
        "Student" => Icons.Material.Filled.School,
        _ => Icons.Material.Filled.Badge
    };

    private Color GetRoleColor(string role) => role switch
    {
        "SuperRoot" => Color.Error,
        "Admin" => Color.Primary,
        "Manager" => Color.Info,
        "Student" => Color.Success,
        _ => Color.Default
    };

    private bool IsSystemPermission(string key)
    {
        // Prevent disabling critical system permissions for SuperRoot if needed, 
        // but generally we want flexibility. 
        // Maybe prevent disabling "Permissions.System.Settings" for SuperRoot?
        return false; 
    }

    private void TogglePermission(Permission permission)
    {
        // Just UI toggle, save happens on "Save All Changes"
    }

    private void EnableAll(PermissionCategory category)
    {
        foreach (var permission in category.Permissions)
        {
            if (!IsSystemPermission(permission.Key))
            {
                permission.IsEnabled = true;
            }
        }
    }

    private void DisableAll(PermissionCategory category)
    {
        foreach (var permission in category.Permissions)
        {
            if (!IsSystemPermission(permission.Key))
            {
                permission.IsEnabled = false;
            }
        }
    }

    private async Task SavePermissions()
    {
        _isSaving = true;
        try
        {
            var permissionsToSave = new List<string>();
            foreach (var category in _categories)
            {
                permissionsToSave.AddRange(category.Permissions.Where(p => p.IsEnabled).Select(p => p.Key));
            }

            var success = await RoleService.UpdateRolePermissionsAsync(_selectedRole, permissionsToSave);

            if (success)
            {
                Snackbar.Add($"Permissions for {_selectedRole} role saved successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to save permissions.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void CreatePermission()
    {
        Snackbar.Add("Create custom permission - Coming soon!", Severity.Info);
    }

    public class PermissionCategory
    {
        public string Name { get; set; } = "";
        public List<Permission> Permissions { get; set; } = new();
    }

    public class Permission
    {
        public string Key { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public bool IsEnabled { get; set; }
    }
}