@using Microsoft.Extensions.Localization
@using SRMS.Application.AuditLogs.Interfaces
@using SRMS.Domain.AuditLogs
@using SRMS.Domain.AuditLogs.Enums
@inject IAuditService AuditService
@inject IStringLocalizer<Resource> Localizer

<!-- Recent Activity -->
<MudCard Elevation="4" Class="glass-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Class="text-lg font-bold flex items-center">
                <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2 text-xl" />
                @Localizer["RecentSystemActivity"]
            </MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="@OnInitializedAsync" />

            @* @if () // filtering superroot or not *@
            @* { *@
            @* <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Href="/superroot/audit"> *@
            @* @Localizer["ViewAll"] *@
            @* </MudButton> *@
            @* *@
            @* } *@
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent Class="max-h-[300px] overflow-y-auto">
        @if (RecentActivities != null && RecentActivities.Any())
        {
            <MudTimeline TimelineOrientation="TimelineOrientation.Vertical">
                @foreach (var activity in RecentActivities.Take(5))
                {
                    <MudTimelineItem Color="@GetActivityColor(activity.AuditAction)" Size="Size.Small">
                        <ItemContent>
                            <MudText Class="text-sm font-semibold">@activity.Action</MudText>
                            <MudText Class="text-xs text-secondary">
                                @GetTimeAgo(activity.Timestamp) • @activity.UserName
                            </MudText>
                        </ItemContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        }
        else
        {
            <MudText Class="text-sm text-center text-secondary mt-4">
                @Localizer["NoRecentActivity"]
            </MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [CascadingParameter]
    private List<AuditLog>? RecentActivities { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentActivity();
    }

    private async Task LoadRecentActivity()
    {
        try
        {
            RecentActivities = await AuditService.GetTodayLogsUtcAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading activity: {ex.Message}");
            RecentActivities = new List<AuditLog>();
        }
    }


    private Color GetActivityColor(AuditAction action)
    {
        return action switch
        {
            AuditAction.Create or AuditAction.StudentRegistered => Color.Success,
            AuditAction.Update => Color.Info,
            AuditAction.Delete => Color.Error,
            AuditAction.Login => Color.Primary,
            AuditAction.ComplaintSubmitted => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetTimeAgo(DateTime timestamp)
    {
        var span = DateTime.UtcNow - timestamp;

        if (span.TotalMinutes < 1) return Localizer["justNow"];
        if (span.TotalMinutes < 60) return string.Format(Localizer["minutesAgo"], (int)span.TotalMinutes);
        if (span.TotalHours < 24) return string.Format(Localizer["hoursAgo"], (int)span.TotalHours);
        return string.Format(Localizer["daysAgo"], (int)span.TotalDays);
    }
}
