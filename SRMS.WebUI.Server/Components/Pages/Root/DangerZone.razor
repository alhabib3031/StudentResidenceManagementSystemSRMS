@page "/superroot/danger-zone"
@using Microsoft.Extensions.Localization
@attribute [Authorize(Roles = "SuperRoot")]
@inject ISuperRootService SuperRootService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IStringLocalizer<Resource> Localizer
@rendermode InteractiveServer

<PageTitle>@Localizer["DangerZone_Title"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <!-- Warning Header -->
    <MudPaper Elevation="0" Class="p-6 md:p-8 mb-4 bg-gradient-to-br from-red-700 to-red-500 rounded-3xl shadow-2xl">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" Class="text-white text-6xl md:text-8xl" />
            <div>
                <MudText Class="text-3xl md:text-5xl font-bold text-white mb-2">
                    @Localizer["DangerZone_Header"]
                </MudText>
                <MudText Class="text-base md:text-xl text-white/90">
                    @Localizer["DangerZone_SubHeader"]
                </MudText>
            </div>
        </MudStack>
    </MudPaper>

    <MudAlert Severity="Severity.Error" Class="mb-4">
        <strong>@Localizer["DangerZone_CriticalWarning"]</strong> @Localizer["DangerZone_CriticalWarningMessage"]
    </MudAlert>

    <MudGrid>
        <!-- Clear All Cache -->
        <MudItem xs="12">
            <MudCard Elevation="4" Class="border-2 border-[var(--mud-palette-warning)]">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Warning">
                            <MudIcon Icon="@Icons.Material.Filled.CleaningServices" Class="mr-2" />
                            @Localizer["ClearAllCache"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">@Localizer["ModerateRisk"]</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @Localizer["ClearAllCache_Description"]
                    </MudText>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Delete"
                        OnClick="@ClearCache">
                        @Localizer["ClearCache"]
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Delete Audit Logs -->
        <MudItem xs="12">
            <MudCard Elevation="4" Class="border-2 border-[var(--mud-palette-warning)]">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Warning">
                            <MudIcon Icon="@Icons.Material.Filled.DeleteSweep" Class="mr-2" />
                            @Localizer["DeleteOldAuditLogs"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">@Localizer["ModerateRisk"]</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        @Localizer["DeleteOldAuditLogs_Description"]
                    </MudText>
                    <MudSelect T="int" @bind-Value="_deleteLogsOlderThan" Label="@Localizer["DeleteLogsOlderThan"]"
                        Variant="Variant.Outlined">
                        <MudSelectItem Value="30">@Localizer["30days"]</MudSelectItem>
                        <MudSelectItem Value="60">@Localizer["60days"]</MudSelectItem>
                        <MudSelectItem Value="90">@Localizer["90days"]</MudSelectItem>
                        <MudSelectItem Value="180">@Localizer["6months"]</MudSelectItem>
                        <MudSelectItem Value="365">@Localizer["1year"]</MudSelectItem>
                    </MudSelect>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Warning"
                        StartIcon="@Icons.Material.Filled.DeleteForever" OnClick="@DeleteOldLogs">
                        @Localizer["DeleteOldLogs"]
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Generate Test Data -->
        <MudItem xs="12">
            <MudCard Elevation="4" Class="border-2 border-[var(--mud-palette-info)]">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Info">
                            <MudIcon Icon="@Icons.Material.Filled.Science" Class="mr-2" />
                            @Localizer["GenerateTestData"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@Localizer["LowRisk"]</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        @Localizer["GenerateTestData_Description"]
                    </MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudNumericField @bind-Value="_testUsersCount" Label="@Localizer["NumberOfUsers"]"
                                Variant="Variant.Outlined" Min="1" Max="1000" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudNumericField @bind-Value="_testStudentsCount" Label="@Localizer["NumberOfStudents"]"
                                Variant="Variant.Outlined" Min="1" Max="1000" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Add"
                        OnClick="@GenerateTestData" Disabled="_isGenerating">
                        @if (_isGenerating)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Localizer["Generating"]</span>
                        }
                        else
                        {
                            <span>@Localizer["GenerateTestData"]</span>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Reset Database -->
        <MudItem xs="12">
            <MudCard Elevation="4" Class="border-2 border-[var(--mud-palette-error)]">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Error">
                            <MudIcon Icon="@Icons.Material.Filled.RestartAlt" Class="mr-2" />
                            @Localizer["ResetDatabaseToDefaults"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">@Localizer["HighRisk"]</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudAlert Severity="Severity.Error" Dense="true" Class="mb-3">
                        <strong>@Localizer["ExtremeCaution"]</strong> @Localizer["ResetDatabase_Warning"]
                    </MudAlert>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @Localizer["ResetDatabase_Description"]
                    </MudText>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Warning"
                        OnClick="@ResetDatabase" Disabled="_isResetting">
                        @if (_isResetting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Localizer["Resetting"]</span>
                        }
                        else
                        {
                            <span>@Localizer["ResetDatabase"]</span>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Delete All Data -->
        <MudItem xs="12">
            <MudCard Elevation="4" Class="border-[3px] border-[var(--mud-palette-error)] bg-[rgba(211,47,47,0.05)]">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Error">
                            <MudIcon Icon="@Icons.Material.Filled.DeleteForever" Class="mr-2" />
                            @Localizer["DeleteAllData_Header"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">@Localizer["CriticalRisk"]</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudAlert Severity="Severity.Error" Class="mb-3">
                        <strong>@Localizer["NuclearOption"]</strong><br />
                        @Localizer["MostDestructiveAction"]<br />
                        @Localizer["PermanentlyDeleteEverything"]<br />
                        • @Localizer["AllUsersExceptSuperRoot"]<br />
                        • @Localizer["AllStudentsAndManagers"]<br />
                        • @Localizer["AllResidencesAndRooms"]<br />
                        • @Localizer["AllPaymentsAndComplaints"]<br />
                        • @Localizer["AllAuditLogs"]<br />
                        <br />
                        <strong>@Localizer["ActionCannotBeUndone"]</strong>
                    </MudAlert>
                    <MudText Typo="Typo.body1" Color="Color.Error" Class="mb-3">
                        <strong>@Localizer["MustTypeConfirmation"]</strong>
                    </MudText>
                    <MudTextField @bind-Value="_deleteConfirmation"
                        Label="@Localizer["DeleteAllData_ConfirmationLabel"]" Variant="Variant.Outlined"
                        Error="@(_showDeleteError)" ErrorText="@Localizer["ConfirmationCodeMismatch"]"
                        HelperText="@Localizer["ConfirmationCodeHelper"]" />
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Error"
                        StartIcon="@Icons.Material.Filled.DeleteForever" OnClick="@DeleteAllData"
                        Disabled="@(_deleteConfirmation != "DELETE_ALL_DATA_PERMANENTLY" || _isDeleting)">
                        @if (_isDeleting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Localizer["DeletingEverything"]</span>
                        }
                        else
                        {
                            <span>@Localizer["DeleteEverythingButton"]</span>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int _deleteLogsOlderThan = 90;
    private int _testUsersCount = 10;
    private int _testStudentsCount = 50;
    private string _deleteConfirmation = "";
    private bool _showDeleteError;
    private bool _isGenerating;
    private bool _isResetting;
    private bool _isDeleting;

    private async Task ClearCache()
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = Localizer["ClearCache_Confirmation"].Value,
                ["ButtonText"] = Localizer["ClearCache"].Value,
                ["Color"] = Color.Warning
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(Localizer["ClearCache"], parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            try
            {
                var success = await SuperRootService.ClearAllCacheAsync();
                if (success)
                {
                    Snackbar.Add(Localizer["CacheClearedSuccessfully"].Value, Severity.Success);
                }
                else
                {
                    Snackbar.Add(Localizer["FailedToClearCache"].Value, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"{Localizer["Error"].Value}: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteOldLogs()
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = string.Format(Localizer["DeleteOldLogs_Confirmation"].Value, _deleteLogsOlderThan),
                ["ButtonText"] = Localizer["DeleteLogs"].Value,
                ["Color"] = Color.Warning
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(Localizer["DeleteOldLogs"].Value, parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add(string.Format(Localizer["LogsDeletedSuccessfully"].Value, _deleteLogsOlderThan), Severity.Success);
        }
    }

    private async Task GenerateTestData()
    {
        _isGenerating = true;
        try
        {
            var success = await SuperRootService.GenerateTestDataAsync(_testUsersCount, _testStudentsCount);
            if (success)
            {
                Snackbar.Add(string.Format(Localizer["TestDataGenerated"].Value, _testUsersCount, _testStudentsCount),
                Severity.Success);
            }
            else
            {
                Snackbar.Add(Localizer["FailedToGenerateTestData"].Value, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Localizer["Error"].Value}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task ResetDatabase()
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = Localizer["ResetDatabase_Confirmation"],
                ["ExpectedText"] = "RESET",
                ["ButtonText"] = Localizer["ResetDatabase"],
                ["ButtonColor"] = Color.Error
            };

        var dialog = await DialogService.ShowAsync<ConfirmWithTextDialog>(Localizer["ResetDatabase_Title"], parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false } && result.Data?.ToString() == "RESET")
        {
            _isResetting = true;
            try
            {
                var success = await SuperRootService.ResetDatabaseAsync();
                if (success)
                {
                    Snackbar.Add(Localizer["DatabaseResetSuccessfully"], Severity.Success);
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/login", forceLoad: true);
                }
                else
                {
                    Snackbar.Add(Localizer["FailedToResetDatabase"], Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"{Localizer["Error"]}: {ex.Message}", Severity.Error);
            }
            finally
            {
                _isResetting = false;
            }
        }
    }

    private async Task DeleteAllData()
    {
        if (_deleteConfirmation != "DELETE_ALL_DATA_PERMANENTLY")
        {
            _showDeleteError = true;
            Snackbar.Add(Localizer["ConfirmationCodeMismatch"], Severity.Error);
            return;
        }

        var parameters = new DialogParameters
            {
                ["ContentText"] = Localizer["DeleteAllData_FinalWarning"],
                ["ExpectedText"] = "DELETE",
                ["ButtonText"] = Localizer["DeleteEverythingButton_Final"],
                ["ButtonColor"] = Color.Error
            };

        var dialog = await DialogService.ShowAsync<ConfirmWithTextDialog>(Localizer["FinalWarning_Title"], parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false } && result.Data?.ToString() == "DELETE")
        {
            _isDeleting = true;
            try
            {
                var success = await SuperRootService.DeleteAllDataAsync("DELETE_ALL_DATA_PERMANENTLY");
                if (success)
                {
                    Snackbar.Add(Localizer["AllDataDeleted"], Severity.Success);
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/login", forceLoad: true);
                }
                else
                {
                    Snackbar.Add(Localizer["FailedToDeleteData"], Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"{Localizer["Error"]}: {ex.Message}", Severity.Error);
            }
            finally
            {
                _isDeleting = false;
            }
        }
    }
}
