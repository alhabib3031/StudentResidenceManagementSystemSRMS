@page "/superroot/settings"
@attribute [Authorize(Roles = "SuperRoot")]
@inject ISnackbar Snackbar
@using SRMS.WebUI.Server.Resources
@using System.Globalization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["SystemSettings_Title"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <!-- Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4 glass-card">
        <MudText Typo="Typo.h4" Color="Color.Primary">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
            @L["SystemSettings_Header"]
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @L["SystemSettings_Description"]
        </MudText>
    </MudPaper>

    <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" PanelClass="p-6" Class="glass-card">
        <!-- General Settings -->
        <MudTabPanel Text="@L["Tab_General"]" Icon="@Icons.Material.Filled.Tune">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">@L["GeneralSettings_Header"]</MudText>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SystemName" Label="@L["SystemName"]" Variant="Variant.Outlined"
                                  HelperText="@L["SystemName_Helper"]" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SystemEmail" Label="@L["SystemEmail"]" Variant="Variant.Outlined"
                                  InputType="InputType.Email" HelperText="@L["SystemEmail_Helper"]" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SystemPhone" Label="@L["SystemPhone"]" Variant="Variant.Outlined"
                                  HelperText="@L["SystemPhone_Helper"]" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" @bind-Value="_settings.DefaultLanguage" Label="@L["DefaultLanguage"]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("en")">@L["English"]</MudSelectItem>
                        <MudSelectItem Value="@("ar")">@L["Arabic"]</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" @bind-Value="_settings.DefaultCurrency" Label="@L["DefaultCurrency"]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("LYD")">@L["Currency_LYD"]</MudSelectItem>
                        <MudSelectItem Value="@("USD")">@L["Currency_USD"]</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" @bind-Value="_settings.DateFormat" Label="@L["DateFormat"]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("MM/dd/yyyy")">@L["MMDDYYYY"]</MudSelectItem>
                        <MudSelectItem Value="@("dd/MM/yyyy")">@L["DDMMYYYY"]</MudSelectItem>
                        <MudSelectItem Value="@("yyyy-MM-dd")">@L["YYYYMMDD"]</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@SaveSettings" Class="btn-modern h-12 rounded-xl font-semibold">
                        @L["SaveChanges"]
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Email Settings -->
        <MudTabPanel Text="@L["Tab_Email"]" Icon="@Icons.Material.Filled.Email">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">@L["EmailConfiguration_Header"]</MudText>
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                        @L["EmailConfiguration_Alert"]
                    </MudAlert>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SmtpHost" Label="@L["SmtpHost"]" Variant="Variant.Outlined"
                                  Placeholder="smtp.gmail.com" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.SmtpPort" Label="@L["SmtpPort"]" Variant="Variant.Outlined"
                                     Placeholder="587" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SmtpUsername" Label="@L["Username"]" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SmtpPassword" Label="@L["Password"]" Variant="Variant.Outlined"
                                  InputType="InputType.Password" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.EnableSsl" Label="@L["EnableSsl"]" Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveSettings" Class="btn-modern h-12 rounded-xl font-semibold">
                            @L["SaveEmailSettings"]
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Send"
                                   OnClick="@TestEmail" Class="btn-modern h-12 rounded-xl font-semibold">
                            @L["SendTestEmail"]
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- SMS Settings -->
        <MudTabPanel Text="@L["Tab_SMS"]" Icon="@Icons.Material.Filled.Sms">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">@L["SMSConfiguration_Header"]</MudText>
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                        @L["SMSConfiguration_Alert"]
                    </MudAlert>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" @bind-Value="_settings.SmsProvider" Label="@L["SmsProvider"]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("Libyana")">Libyana</MudSelectItem>
                        <MudSelectItem Value="@("Almadar")">Almadar</MudSelectItem>
                        <MudSelectItem Value="@("LibyaTelecom")">LibyaTelecom</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SmsApiKey" Label="@L["ApiKey"]" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SmsApiSecret" Label="@L["ApiSecret"]" Variant="Variant.Outlined"
                                  InputType="InputType.Password" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.SmsSenderName" Label="@L["SenderName"]" Variant="Variant.Outlined"
                                  Placeholder="SRMS" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.EnableSmsNotifications" Label="@L["EnableSmsNotifications"]"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveSettings" Class="btn-modern h-12 rounded-xl font-semibold">
                            @L["SaveSmsSettings"]
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Send"
                                   OnClick="@TestSms" Class="btn-modern h-12 rounded-xl font-semibold">
                            @L["SendTestSms"]
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Security Settings -->
        <MudTabPanel Text="@L["Tab_Security"]" Icon="@Icons.Material.Filled.Security">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">@L["SecuritySettings_Header"]</MudText>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.PasswordMinLength" Label="@L["PasswordMinLength"]"
                                     Variant="Variant.Outlined" Min="6" Max="20" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.SessionTimeout" Label="@L["SessionTimeout"]"
                                     Variant="Variant.Outlined" Min="5" Max="1440" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.MaxLoginAttempts" Label="@L["MaxLoginAttempts"]"
                                     Variant="Variant.Outlined" Min="3" Max="10" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.LockoutDuration" Label="@L["LockoutDuration"]"
                                     Variant="Variant.Outlined" Min="5" Max="60" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.RequireEmailConfirmation" Label="@L["RequireEmailConfirmation"]"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.EnableTwoFactorAuth" Label="@L["EnableTwoFactorAuth"]"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.LogAllUserActions" Label="@L["LogAllUserActions"]"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@SaveSettings" Class="btn-modern h-12 rounded-xl font-semibold">
                        @L["SaveSecuritySettings"]
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Payment Settings -->
        <MudTabPanel Text="@L["Tab_Payment"]" Icon="@Icons.Material.Filled.Payment">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">@L["PaymentSettings_Header"]</MudText>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.DefaultMonthlyRent" Label="@L["DefaultMonthlyRent"]"
                                     Variant="Variant.Outlined" Format="N2" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.LateFeePercentage" Label="@L["LateFeePercentage"]"
                                     Variant="Variant.Outlined" Min="0" Max="100" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.PaymentDueDays" Label="@L["PaymentDueDays"]"
                                     Variant="Variant.Outlined" Min="1" Max="31" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_settings.PaymentReminderDays" Label="@L["PaymentReminderDays"]"
                                     Variant="Variant.Outlined" Min="1" Max="15" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.AllowOnlinePayment" Label="@L["AllowOnlinePayment"]"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_settings.AutoGenerateInvoices" Label="@L["AutoGenerateInvoices"]"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@SaveSettings" Class="btn-modern h-12 rounded-xl font-semibold">
                        @L["SavePaymentSettings"]
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Maintenance Mode -->
        <MudTabPanel Text="@L["Tab_Maintenance"]" Icon="@Icons.Material.Filled.Build">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">@L["MaintenanceMode_Header"]</MudText>
                    <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-4">
                        @((MarkupString)L["MaintenanceMode_Alert"].Value)
                    </MudAlert>
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_settings.MaintenanceMode" Label="@L["EnableMaintenanceMode"]"
                               Color="Color.Warning" Size="Size.Large" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_settings.MaintenanceMessage" Label="@L["MaintenanceMessage"]"
                                  Variant="Variant.Outlined" Lines="3"
                                  Placeholder="@L["MaintenanceMessage_Placeholder"]" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled"
                               Color="@(_settings.MaintenanceMode ? Color.Error : Color.Primary)"
                               StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveSettings"
                               Class="btn-modern h-12 rounded-xl font-semibold">
                        @(_settings.MaintenanceMode ? L["EnableMaintenanceMode"] : L["SaveSettings_Button"])
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private SystemSettings _settings = new();

    protected override void OnInitialized()
    {
        LoadSettings();
    }

    private void LoadSettings()
    {
        // TODO: Load from database
        _settings = new SystemSettings
            {
                SystemName = "SRMS",
                SystemEmail = "admin@srms.edu.ly",
                SystemPhone = "+218 91 234 5678",
                DefaultLanguage = "en",
                DefaultCurrency = "LYD",
                DateFormat = "dd/MM/yyyy",
                SmtpHost = "smtp.gmail.com",
                SmtpPort = 587,
                EnableSsl = true,
                PasswordMinLength = 8,
                SessionTimeout = 30,
                MaxLoginAttempts = 5,
                LockoutDuration = 15,
                RequireEmailConfirmation = true,
                DefaultMonthlyRent = 500,
                LateFeePercentage = 5,
                PaymentDueDays = 15,
                PaymentReminderDays = 3
            };
    }

    private void SaveSettings()
    {
        // TODO: Save to database
        Snackbar.Add(L["SettingsSavedSuccessfully"].Value, Severity.Success);
    }

    private void TestEmail()
    {
        Snackbar.Add(L["SendingTestEmail"].Value, Severity.Info);
    }

    private void TestSms()
    {
        Snackbar.Add(L["SendingTestSms"].Value, Severity.Info);
    }

    public class SystemSettings
    {
        public string SystemName { get; set; } = "SRMS";
        public string SystemEmail { get; set; } = "";
        public string? SystemPhone { get; set; }
        public string DefaultLanguage { get; set; } = "en";
        public string DefaultCurrency { get; set; } = "LYD";
        public string DateFormat { get; set; } = "dd/MM/yyyy";

        public string? SmtpHost { get; set; }
        public int SmtpPort { get; set; }
        public string? SmtpUsername { get; set; }
        public string? SmtpPassword { get; set; }
        public bool EnableSsl { get; set; }

        public string? SmsProvider { get; set; }
        public string? SmsApiKey { get; set; }
        public string? SmsApiSecret { get; set; }
        public string? SmsSenderName { get; set; }
        public bool EnableSmsNotifications { get; set; }

        public int PasswordMinLength { get; set; } = 8;
        public int SessionTimeout { get; set; } = 30;
        public int MaxLoginAttempts { get; set; } = 5;
        public int LockoutDuration { get; set; } = 15;
        public bool RequireEmailConfirmation { get; set; }
        public bool EnableTwoFactorAuth { get; set; }
        public bool LogAllUserActions { get; set; }

        public decimal DefaultMonthlyRent { get; set; }
        public decimal LateFeePercentage { get; set; }
        public int PaymentDueDays { get; set; }
        public int PaymentReminderDays { get; set; }
        public bool AllowOnlinePayment { get; set; }
        public bool AutoGenerateInvoices { get; set; }

        public bool MaintenanceMode { get; set; }
        public string MaintenanceMessage { get; set; } = "";
    }
}