@page "/superroot/email-config"
@using Microsoft.Extensions.Localization
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IStringLocalizer<Resource> Localizer
@attribute [Authorize(Roles = "SuperRoot")]
@rendermode InteractiveServer

<PageTitle>@Localizer["EmailConfiguration"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <!-- Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary">
            <MudIcon Icon="@Icons.Material.Filled.Email" Class="mr-2" />
            @Localizer["EmailConfiguration"]
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @Localizer["ConfigureSmtpSettings"]
        </MudText>
    </MudPaper>

    <MudGrid>
        <!-- SMTP Settings Card -->
        <MudItem xs="12" md="8">
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" Size="Size.Small" />
                            @Localizer["SmtpServerSettings"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Size="Size.Small" Color="@(_isConnected ? Color.Success : Color.Error)"
                                 Icon="@(_isConnected ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
                            @(_isConnected ? Localizer["Connected"] : Localizer["NotConnected"])
                        </MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                                @Localizer["ConfigureSmtpToSendeEmails"]
                            </MudAlert>
                        </MudItem>

                        <MudItem xs="12" sm="8">
                            <MudTextField @bind-Value="_config.SmtpHost" Label="@Localizer["SmtpHost"]" Variant="Variant.Outlined"
                                          Placeholder="smtp.gmail.com" HelperText="@Localizer["EnterSmtpServerAddress"]" />
                        </MudItem>

                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_config.SmtpPort" Label="@Localizer["SmtpPort"]" Variant="Variant.Outlined"
                                             Min="1" Max="65535" HelperText="@Localizer["Usually587or465"]" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_config.Username" Label="@Localizer["Username"]" Variant="Variant.Outlined"
                                          Placeholder="your-email@example.com" Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Person" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_config.Password" Label="@Localizer["Password"]" Variant="Variant.Outlined"
                                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                          OnAdornmentClick="@(() => _showPassword = !_showPassword)" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_config.FromEmail" Label="@Localizer["FromEmail"]" Variant="Variant.Outlined"
                                          Placeholder="noreply@srms.edu.ly" HelperText="@Localizer["EmailAddressAsSender"]" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_config.FromName" Label="@Localizer["FromName"]" Variant="Variant.Outlined"
                                          Placeholder="SRMS System" HelperText="@Localizer["NameAsSender"]" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudCheckBox @bind-Value="_config.EnableSsl" Label="@Localizer["EnableSslTls"]"
                                         Color="Color.Primary" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudCheckBox @bind-Value="_config.UseDefaultCredentials" Label="@Localizer["UseDefaultCredentials"]"
                                         Color="Color.Primary" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@SaveConfiguration" Disabled="_isSaving">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Localizer["Saving"]</span>
                        }
                        else
                        {
                            <span>@Localizer["SaveConfiguration"]</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Send"
                               OnClick="@TestConnection" Disabled="_isTesting">
                        @if (_isTesting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Localizer["Testing"]</span>
                        }
                        else
                        {
                            <span>@Localizer["TestConnection"]</span>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Sidebar -->
        <MudItem xs="12" md="4">
            <!-- Email Templates -->
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" Size="Size.Small" />
                            @Localizer["EmailTemplates"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudList T="string" Dense="true">
                        <MudListItem Icon="@Icons.Material.Filled.MarkEmailRead"
                                     OnClick="@(() => EditTemplate("welcome"))">
                            @Localizer["WelcomeEmail"]
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.LockReset" OnClick="@(() => EditTemplate("reset"))">
                            @Localizer["PasswordReset"]
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.VerifiedUser"
                                     OnClick="@(() => EditTemplate("verify"))">
                            @Localizer["EmailVerification"]
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Payment" OnClick="@(() => EditTemplate("payment"))">
                            @Localizer["PaymentReceipt"]
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Notifications"
                                     OnClick="@(() => EditTemplate("notification"))">
                            @Localizer["NotificationEmail"]
                        </MudListItem>
                    </MudList>
                </MudCardContent>
            </MudCard>

            <!-- Statistics -->
            <MudCard Elevation="4" Class="mt-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="mr-2" Size="Size.Small" />
                            @Localizer["EmailStatistics"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="3">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["Today"]</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">243</MudText>
                            <MudText Typo="Typo.caption">@Localizer["emailsSent"]</MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["ThisMonth"]</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Info">5,847</MudText>
                            <MudText Typo="Typo.caption">@Localizer["emailsSent"]</MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["Failed"]</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Error">12</MudText>
                            <MudText Typo="Typo.caption">@Localizer["deliveryFailures"]</MudText>
                        </div>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Recent Emails Log -->
        <MudItem xs="12">
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" Size="Size.Small" />
                            @Localizer["RecentEmailActivity"]
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Refresh" OnClick="@LoadLogs">
                            @Localizer["Refresh"]
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@_recentEmails" Hover="true" Dense="true" Striped="true">
                        <HeaderContent>
                            <MudTh>@Localizer["Time"]</MudTh>
                            <MudTh>@Localizer["To"]</MudTh>
                            <MudTh>@Localizer["Subject"]</MudTh>
                            <MudTh>@Localizer["Status"]</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="@Localizer["Time"]">
                                <MudText Typo="Typo.caption">@context.Timestamp.ToString("HH:mm:ss")</MudText>
                            </MudTd>
                            <MudTd DataLabel="@Localizer["To"]">@context.To</MudTd>
                            <MudTd DataLabel="@Localizer["Subject"]">@context.Subject</MudTd>
                            <MudTd DataLabel="@Localizer["Status"]">
                                <MudChip T="string" Size="Size.Small"
                                         Color="@(context.Success ? Color.Success : Color.Error)">
                                    @(context.Success ? Localizer["Sent"] : Localizer["Failed"])
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private EmailConfig _config = new();
    private bool _showPassword = false;
    private bool _isSaving = false;
    private bool _isTesting = false;
    private bool _isConnected = false;
    private List<EmailLog> _recentEmails = new();

    protected override void OnInitialized()
    {
        LoadConfiguration();
        LoadLogs();
    }

    private void LoadConfiguration()
    {
        // TODO: Load from database or configuration
        _config = new EmailConfig
            {
                SmtpHost = "smtp.gmail.com",
                SmtpPort = 587,
                Username = "itstd.5377@uob.edu.ly",
                FromEmail = "itstd.5377@uob.edu.ly",
                FromName = "SRMS System",
                EnableSsl = true
            };
    }

    private void LoadLogs()
    {
        // TODO: Load real logs from database
        _recentEmails = new List<EmailLog>
{
new() { Timestamp = DateTime.Now.AddMinutes(-5), To = "student@example.com", Subject = "Welcome to SRMS", Success =
true},
new() { Timestamp = DateTime.Now.AddMinutes(-12), To = "manager@example.com", Subject = "Password Reset Request",
Success = true },
new() { Timestamp = DateTime.Now.AddMinutes(-25), To = "admin@example.com", Subject = "Monthly Report", Success =
false},
new() { Timestamp = DateTime.Now.AddHours(-1), To = "user@example.com", Subject = "Payment Receipt", Success = true }
};
    }

    private async Task SaveConfiguration()
    {
        _isSaving = true;
        try
        {
            await Task.Delay(1000); // Simulate API call
                                    // TODO: Save to database
            Snackbar.Add(Localizer["EmailConfigurationSaved"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Localizer["Error"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task TestConnection()
    {
        _isTesting = true;
        try
        {
            await Task.Delay(2000); // Simulate connection test
            _isConnected = true;
            Snackbar.Add(Localizer["SmtpConnectionSuccessful"], Severity.Success);
        }
        catch (Exception ex)
        {
            _isConnected = false;
            Snackbar.Add($"{Localizer["ConnectionFailed"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isTesting = false;
        }
    }

    private void EditTemplate(string templateName)
    {
        Snackbar.Add(string.Format(Localizer["EditTemplateComingSoon"], templateName), Severity.Info);
    }

    public class EmailConfig
    {
        public string SmtpHost { get; set; } = "";
        public int SmtpPort { get; set; } = 587;
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
        public string FromEmail { get; set; } = "";
        public string FromName { get; set; } = "";
        public bool EnableSsl { get; set; } = true;
        public bool UseDefaultCredentials { get; set; } = false;
    }

    public class EmailLog
    {
        public DateTime Timestamp { get; set; }
        public string To { get; set; } = "";
        public string Subject { get; set; } = "";
        public bool Success { get; set; }
    }
}
