@page "/rooms"
@inject ISender Sender
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resource> L
@attribute [Authorize(Roles = "Manager,Admin,SuperRoot")]
@rendermode InteractiveServer

<PageTitle>@L["RoomsManagement_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="p-4 md:p-6 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Class="text-2xl md:text-4xl font-bold flex items-center text-primary">
                    <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Class="mr-2 text-3xl md:text-4xl" />
                    @L["RoomsManagement_Header"]
                </MudText>
                <MudText Class="text-sm md:text-base text-secondary mt-1">
                    @L["RoomsManagement_Subheader"]
                </MudText>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                OnClick="@CreateRoom" Class="hidden md:flex rounded-xl shadow-lg">
                @L["RoomsManagement_Button_Add"]
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Filled"
                OnClick="@CreateRoom" Class="flex md:hidden rounded-lg shadow-lg" />
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Statistics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["RoomsManagement_Stats_Total"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Color="Color.Primary"
                                Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-primary">@_rooms.Count</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["RoomsManagement_Stats_Available"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success"
                                Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-success">@_rooms.Count(r => !r.IsFull)
                        </MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["RoomsManagement_Stats_TotalBeds"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Hotel" Color="Color.Info" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-info">@_rooms.Sum(r => r.TotalBeds)</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="4" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["RoomsManagement_Stats_OccupancyRate"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Warning" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-3xl font-bold text-warning">@GetOccupancyRate()%</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Rooms Grid/List Toggle -->
    <MudPaper Elevation="2" Class="pa-3 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="_searchString" Label='@L["RoomsManagement_SearchPlaceholder"]'
                Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                Margin="Margin.Dense" Class="max-w-[300px]" />

            <MudButtonGroup Variant="Variant.Outlined">
                <MudButton Color="@(_viewMode == "grid" ? Color.Primary : Color.Default)"
                    OnClick="@(() => _viewMode = "grid")" StartIcon="@Icons.Material.Filled.GridView">
                    @L["RoomsManagement_View_Grid"]
                </MudButton>
                <MudButton Color="@(_viewMode == "list" ? Color.Primary : Color.Default)"
                    OnClick="@(() => _viewMode = "list")" StartIcon="@Icons.Material.Filled.ViewList">
                    @L["RoomsManagement_View_List"]
                </MudButton>
            </MudButtonGroup>
        </MudStack>
    </MudPaper>

    @if (_viewMode == "grid")
    {
        <!-- Grid View -->
        <MudGrid>
            @foreach (var room in FilteredRooms)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="4" Class="room-card">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Size="Size.Small" Class="mr-2" />
                                    @string.Format(L["RoomsManagement_Card_Room"], room.RoomNumber)
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @string.Format(L["RoomsManagement_Card_Floor"], room.Floor) | @room.RoomType
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="bool" Size="Size.Small" Color="@(room.IsFull ? Color.Error : Color.Success)">
                                    @(room.IsFull ? L["RoomsManagement_Card_Status_Full"] :
                                        L["RoomsManagement_Card_Status_Available"])
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>

                        <MudCardContent>
                            <!-- Beds Info -->
                            <MudStack Spacing="2">
                                <MudProgressLinear Value="@GetOccupancyPercentage(room)" Color="@GetOccupancyColor(room)"
                                    Size="Size.Medium" Class="mb-2" />

                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Hotel" Size="Size.Small" Class="mr-1" />
                                    <strong>@room.OccupiedBeds/@room.TotalBeds</strong> @L["RoomsManagement_Card_BedsOccupied",
                            room.OccupiedBeds, room.TotalBeds]
                                </MudText>

                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" Class="mr-1" />
                                    @room.ResidenceName
                                </MudText>
                            </MudStack>
                        </MudCardContent>

                        <MudCardActions>
                            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                Href="@($"/rooms/{room.Id}")">
                                @L["RoomsManagement_Card_ViewDetails"]
                            </MudButton>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditRoom(room.Id))">
                                    @L["RoomsManagement_Card_Edit"]
                                </MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error"
                                    OnClick="@(() => DeleteRoom(room.Id))">
                                    @L["RoomsManagement_Card_Delete"]
                                </MudMenuItem>
                            </MudMenu>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <!-- List View -->
        <MudPaper Elevation="4" Class="rounded-3xl overflow-hidden glass-card">
            <MudTable Items="@FilteredRooms" Hover="true" Striped="true" Dense="true" Breakpoint="Breakpoint.Sm"
                Class="glass-table">
                <HeaderContent>
                    <MudTh>@L["RoomsManagement_Table_Header_Room"]</MudTh>
                    <MudTh>@L["RoomsManagement_Table_Header_Residence"]</MudTh>
                    <MudTh>@L["RoomsManagement_Table_Header_Type"]</MudTh>
                    <MudTh>@L["RoomsManagement_Table_Header_Beds"]</MudTh>
                    <MudTh>@L["RoomsManagement_Table_Header_Occupancy"]</MudTh>
                    <MudTh>@L["RoomsManagement_Table_Header_Status"]</MudTh>
                    <MudTh Class="text-right">@L["RoomsManagement_Table_Header_Actions"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Room">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2"><strong>@string.Format(L["RoomsManagement_Card_Room"],
                                context.RoomNumber)</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @string.Format(L["RoomsManagement_Card_Floor"], context.Floor)</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Residence">@context.ResidenceName</MudTd>
                    <MudTd DataLabel="Type">@context.RoomType</MudTd>
                    <MudTd DataLabel="Beds">@context.OccupiedBeds/@context.TotalBeds</MudTd>
                    <MudTd DataLabel="Occupancy">
                        <MudProgressLinear Value="@GetOccupancyPercentage(context)" Color="@GetOccupancyColor(context)"
                            Size="Size.Small" />
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="bool" Size="Size.Small" Color="@(context.IsFull ? Color.Error : Color.Success)">
                            @(context.IsFull ? L["RoomsManagement_Card_Status_Full"] :
                            L["RoomsManagement_Card_Status_Available"])
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Actions" Class="text-right">
                        <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small"
                                Href="@($"/rooms/{context.Id}")" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small"
                                OnClick="@(() => EditRoom(context.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                OnClick="@(() => DeleteRoom(context.Id))" />
                        </MudButtonGroup>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private List<RoomDto> _rooms = new();
    private IEnumerable<RoomDto> FilteredRooms => _rooms.Where(r =>
    string.IsNullOrWhiteSpace(_searchString) ||
    r.RoomNumber.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
    r.ResidenceName.Contains(_searchString, StringComparison.OrdinalIgnoreCase));

    private bool _isLoading = true;
    private string _searchString = "";
    private string _viewMode = "grid";

    protected override async Task OnInitializedAsync()
    {
        await LoadRooms();
    }

    private async Task LoadRooms()
    {
        _isLoading = true;
        try
        {
            _rooms = await Sender.Send(new Application.Rooms.GetAllRooms.GetAllRoomsQuery());
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading rooms: {ex.Message}", Severity.Error);
            _rooms = new List<RoomDto>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CreateRoom()
    {
        var dialog = await DialogService.ShowAsync<Dialogs.CreateRoomDialog>(L["RoomsManagement_Button_Add"]);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add(L["RoomsManagement_Snackbar_Created"], Severity.Success);
            await LoadRooms();
        }
    }

    private void EditRoom(Guid roomId)
    {
        Snackbar.Add(L["RoomsManagement_Snackbar_EditNotImplemented"], Severity.Info);
    }

    private async Task DeleteRoom(Guid roomId)
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = L["RoomsManagement_Dialog_ConfirmDelete_Content"],
                ["ButtonText"] = L["RoomsManagement_Dialog_ConfirmDelete_Button"],
                ["Color"] = Color.Error
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(L["RoomsManagement_Dialog_ConfirmDelete_Title"], parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add(L["RoomsManagement_Snackbar_Deleted"], Severity.Success);
            await LoadRooms();
        }
    }

    private double GetOccupancyPercentage(RoomDto room)
    {
        if (room.TotalBeds == 0) return 0;
        return (double)room.OccupiedBeds / room.TotalBeds * 100;
    }

    private Color GetOccupancyColor(RoomDto room)
    {
        var percentage = GetOccupancyPercentage(room);
        if (percentage >= 100) return Color.Error;
        if (percentage >= 75) return Color.Warning;
        if (percentage >= 50) return Color.Info;
        return Color.Success;
    }

    private int GetOccupancyRate()
    {
        var totalBeds = _rooms.Sum(r => r.TotalBeds);
        var occupiedBeds = _rooms.Sum(r => r.OccupiedBeds);
        if (totalBeds == 0) return 0;
        return (int)((double)occupiedBeds / totalBeds * 100);
    }
}
