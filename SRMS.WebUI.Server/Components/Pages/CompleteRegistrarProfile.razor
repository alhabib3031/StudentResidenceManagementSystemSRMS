@page "/complete-registrar-profile"
@using SRMS.Application.Identity.DTOs
@using SRMS.Application.Identity.Interfaces
@using SRMS.Application.Colleges
@using SRMS.Domain.Colleges
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject IUserService UserService
@inject ICollegeService CollegeService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> L
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.Small" Class="my-10 md:my-20">
    <MudPaper Elevation="4" Class="p-6 md:p-10 rounded-3xl glass-card">
        <MudStack Spacing="6">
            <MudText Class="text-2xl md:text-3xl font-bold text-gradient text-center">
                @L["ProfileCompletion_Registrar_Title"]
            </MudText>

            <EditForm Model="@_model" OnValidSubmit="SubmitProfile">
                <MudStack Spacing="4">
                    <MudTextField @bind-Value="_model.EmployeeNumber" Label='@L["ProfileCompletion_EmployeeNumber"]'
                        Variant="Variant.Outlined" Required="true"
                        HelperText="Your official employee identification number" />

                    <MudSelect T="Guid" @bind-Value="_model.CollegeId" Label='@L["ProfileCompletion_College"]'
                        Variant="Variant.Outlined" Required="true">
                        @if (!_colleges.Any())
                        {
                            <MudSelectItem Value="Guid.Empty" Disabled="true">No Colleges Available</MudSelectItem>
                        }
                        @foreach (var college in _colleges)
                        {
                            <MudSelectItem Value="@college.Id">@college.Name</MudSelectItem>
                        }
                    </MudSelect>

                    <MudTextField @bind-Value="_model.PhoneNumber" Label='@L["PhoneNumber"]' Variant="Variant.Outlined"
                        Required="true" />

                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Info"
                        Class="py-3 font-bold rounded-xl mt-4"
                        Disabled='_isSubmitting || _model.CollegeId == Guid.Empty'>
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        @L["ProfileCompletion_Submit"]
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private readonly CompleteRegistrarProfileDto _model = new();
    private List<College> _colleges = new();
    private bool _isSubmitting;
    private Guid _userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (Guid.TryParse(userIdClaim, out var id))
        {
            _userId = id;
        }

        _colleges = await CollegeService.GetAllCollegesAsync();
    }

    private async Task SubmitProfile()
    {
        if (_model.CollegeId == Guid.Empty)
        {
            Snackbar.Add("Please select a college.", Severity.Warning);
            return;
        }

        _isSubmitting = true;
        try
        {
            var success = await UserService.CompleteRegistrarProfileAsync(_userId, _model);
            if (success)
            {
                Snackbar.Add(L["ProfileCompletion_Success"].Value, Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                Snackbar.Add(L["ProfileCompletion_Error"].Value, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
