@page "/students"
@using Microsoft.Extensions.DependencyInjection
@using SRMS.WebUI.Server.Components.Pages.Dialogs
@using SRMS.Application.Identity.Interfaces
@using SRMS.Domain.Students.Enums
@using Microsoft.Extensions.Localization
@inject IServiceScopeFactory ScopeFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IUserService UserService
@inject IStringLocalizer<Students> L
@rendermode InteractiveServer

<PageTitle>@L["Students"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudPaper Elevation="3" Class="p-6 md:p-8 rounded-3xl glass-card">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <MudText Class="text-3xl md:text-4xl font-bold text-gradient">@L["Student Management"]</MudText>
            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="OpenBulkUpdateDialog"
                    StartIcon="@Icons.Material.Filled.Checklist" Class="rounded-xl shadow-lg">
                    @L["Bulk Update Status"]
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/students/create"
                    StartIcon="@Icons.Material.Filled.Add" Class="rounded-xl shadow-lg">
                    @L["Add New Student"]
                </MudButton>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="flex justify-center p-8">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (!_students.Any())
        {
            <MudAlert Severity="Severity.Info">@L["No students found. Create your first student!"]</MudAlert>
        }
        else
        {
            <MudTable Items="_students" Hover="true" Striped="true" Dense="true" Elevation="0" @ref="_table"
                Breakpoint="Breakpoint.Sm" Class="glass-table">
                <HeaderContent>
                    <MudTh>@L["ID"]</MudTh>
                    <MudTh>@L["Full Name"]</MudTh>
                    <MudTh>@L["Email"]</MudTh>
                    <MudTh>@L["Phone"]</MudTh>
                    <MudTh>@L["Status"]</MudTh>
                    <MudTh>@L["Created At"]</MudTh>
                    <MudTh Class="text-center">@L["Actions"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@L["ID"]">
                        <MudText Typo="Typo.caption">@context.Id.ToString().Substring(0, 8)...</MudText>
                    </MudTd>
                    <MudTd DataLabel="@L["Full Name"]">
                        <MudText Typo="Typo.body2">@context.FullName</MudText>
                    </MudTd>
                    <MudTd DataLabel="@L["Email"]">
                        <MudText Typo="Typo.body2">@(context.Email)</MudText>
                        </MudTd>
                        <MudTd DataLabel="@L["Phone"]">
                            <MudText Typo="Typo.body2">@(context.PhoneNumber)</MudText>
                        </MudTd>
                        <MudTd DataLabel="@L["Status"]">
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)"
                                Variant="Variant.Text">
                                @context.Status.ToString()
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="@L["Created At"]">
                            <MudText Typo="Typo.caption">
                                @context.CreatedAt.ToString("MMM dd, yyyy")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="@L["Actions"]" Class="text-center">
                            <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small"
                                    OnClick="@(() => ViewStudent(context.Id))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small"
                                    OnClick="@(() => EditStudent(context.Id))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                    OnClick="@(() => DeleteStudent(context.Id))" />
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new[] { 10, 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<StudentDto> _students = new();
    private bool _isLoading = true;
    private MudTable<StudentDto> _table = null!;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudents();
    }

    private async Task LoadStudents()
    {
        _isLoading = true;
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var sender = scope.ServiceProvider.GetRequiredService<ISender>();

            var query = new GetStudentQuery();
            var result = await sender.Send(query);
            _students = result.ToList();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ViewStudent(Guid studentId)
    {
        var parameters = new DialogParameters { ["StudentId"] = studentId };
        await DialogService.ShowAsync<StudentDetailsDialog>("Student Details", parameters);
    }

    private async Task EditStudent(Guid studentId)
    {
        var parameters = new DialogParameters { ["StudentId"] = studentId };
        var dialog = await DialogService.ShowAsync<EditStudentDialog>("Edit Student", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await _table.ReloadServerData();
            await LoadStudents(); // ensure refresh
        }
    }

    private async Task DeleteStudent(Guid id)
    {
        var parameters = new DialogParameters
{
{ "ContentText", "Are you sure you want to delete this student? This action cannot be undone." },
{ "ButtonText", "Delete" },
{ "Color", Color.Error }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Student", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            try
            {
                using var scope = ScopeFactory.CreateScope();
                var sender = scope.ServiceProvider.GetRequiredService<ISender>();

                var command = new DeleteStudentCommand { Id = id };
                var success = await sender.Send(command);
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomCenter;

                if (success)
                {
                    Snackbar.Add("Student deleted successfully!", Severity.Success);
                    await LoadStudents();
                }
                else
                {
                    Snackbar.Add("Failed to delete student!", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenBulkUpdateDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<BulkUpdateStatusDialog>("Bulk Update Status", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is BulkUpdateStatusDialog.BulkUpdateResult data)
        {
            _isLoading = true;
            try
            {
                var count = await UserService.BulkUpdateStudentStatusByCollegeAsync(data.CollegeId, data.Status);
                Snackbar.Add($"Updated {count} students successfully.", Severity.Success);
                await LoadStudents();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating students: {ex.Message}", Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private Color GetStatusColor(StudentStatus status) => status switch
    {
        StudentStatus.Active => Color.Success,
        StudentStatus.ManagerApprovalPending => Color.Warning,
        StudentStatus.ProfileCompletionPending => Color.Info,
        StudentStatus.EmailVerificationPending => Color.Info,
        StudentStatus.Suspended => Color.Warning,
        StudentStatus.Rejected => Color.Error,
        StudentStatus.Expelled => Color.Error,
        StudentStatus.Withdrawn => Color.Dark,
        StudentStatus.Graduated => Color.Success,
        _ => Color.Default
    };
}
