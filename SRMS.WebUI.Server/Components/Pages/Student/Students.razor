@page "/students"
@using SRMS.Application.Students.DTOs.StudentDTOs
@rendermode InteractiveServer
@inject ISender Sender
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Students</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-4">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h4">Student Management</MudText>
            <MudButton 
                Variant="Variant.Filled" 
                Color="Color.Primary"
                Href="/students/create"
                StartIcon="@Icons.Material.Filled.Add">
                Add New Student
            </MudButton>
        </div>

        @if (_isLoading)
        {
            <div class="d-flex justify-center pa-8">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (!_students.Any())
        {
            <MudAlert Severity="Severity.Info">No students found. Create your first student!</MudAlert>
        }
        else
        {
            <MudTable 
                Items="_students" 
                Hover="true" 
                Striped="true"
                Dense="true"
                Elevation="0">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Full Name</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Phone</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh Style="text-align: center">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">
                        <MudText Typo="Typo.caption">@context.Id.ToString().Substring(0, 8)...</MudText>
                    </MudTd>
                    <MudTd DataLabel="Full Name">
                        <MudText Typo="Typo.body2">@context.FullName</MudText>
                    </MudTd>
                    <MudTd DataLabel="Email">
                        <MudText Typo="Typo.body2">@(context.Email)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Phone">
                        <MudText Typo="Typo.body2">@(context.PhoneNumber)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip
                            T="bool"
                            Size="Size.Small" 
                            Color="@(context.IsActive ? Color.Success : Color.Default)">
                            @(context.IsActive ? "Active" : "Inactive")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Created At">
                        <MudText Typo="Typo.caption">
                            @context.CreatedAt.ToString("MMM dd, yyyy")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align: center">
                        <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                            <MudIconButton 
                                Icon="@Icons.Material.Filled.Visibility"
                                Color="Color.Info"
                                Size="Size.Small"
                                Href="@($"/students/{context.Id}")" />
                            <MudIconButton 
                                Icon="@Icons.Material.Filled.Edit"
                                Color="Color.Warning"
                                Size="Size.Small"
                                Href="@($"/students/edit/{context.Id}")" />
                            <MudIconButton 
                                Icon="@Icons.Material.Filled.Delete"
                                Color="Color.Error"
                                Size="Size.Small"
                                OnClick="@(() => DeleteStudent(context.Id))" />
                        </MudButtonGroup>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<StudentDto> _students = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudents();
    }

    private async Task LoadStudents()
    {
        _isLoading = true;
        try
        {
            var query = new GetStudentQuery();
            var result = await Sender.Send(query);
            _students = result.ToList();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task DeleteStudent(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Are you sure you want to delete this student? This action cannot be undone." },
            { "ButtonText", "Delete" },
            { "Color", Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Student", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            try
            {
                var command = new DeleteStudentCommand { Id = id };
                var success = await Sender.Send(command);
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomCenter;

                if (success)
                {
                    Snackbar.Add("Student deleted successfully!", Severity.Success);
                    await LoadStudents();
                }
                else
                {
                    Snackbar.Add("Failed to delete student!", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}