@page "/student/reserve-room/{ResidenceId:guid}/{RoomId:guid}"
@attribute [Authorize(Roles = "Student")]
@using SRMS.Application.Reservations.DTOs
@using SRMS.Domain.Rooms.Enums
@using SRMS.Application.Rooms.DTOs
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resource> L

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    @if (room == null || studentId == Guid.Empty)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-20">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Class="mt-4 text-secondary">@L["Reservation_LoadingRoom"]</MudText>
        </MudStack>
    }
    else
    {
        <MudGrid>
            <!-- Room Details Card -->
            <MudItem xs="12" md="8">
                <MudPaper Elevation="0" Class="p-6 md:p-8 rounded-3xl glass-card h-full">
                    <MudText Class="text-2xl md:text-3xl font-bold text-gradient mb-6">
                        @L["ReservationDetails"]
                    </MudText>

                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudText Class="text-sm text-secondary font-bold uppercase mb-1">@L["Residence"]</MudText>
                            <MudText Class="text-lg font-semibold flex items-center">
                                <MudIcon Icon="@Icons.Material.Filled.Apartment" Size="Size.Small"
                                    Class="mr-2 text-primary" />
                                @room.ResidenceName
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Class="text-sm text-secondary font-bold uppercase mb-1">@L["RoomNumber"]</MudText>
                            <MudText Class="text-lg font-semibold flex items-center">
                                <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Size="Size.Small"
                                    Class="mr-2 text-primary" />
                                @room.RoomNumber
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Class="text-sm text-secondary font-bold uppercase mb-1">@L["Floor"]</MudText>
                            <MudText Class="text-lg font-semibold">@room.Floor</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Class="text-sm text-secondary font-bold uppercase mb-1">@L["Type"]</MudText>
                            <MudText Class="text-lg font-semibold">@room.RoomType</MudText>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-6" />

                    <MudText Class="text-lg font-bold mb-4">@L["Amenities"]</MudText>
                    <div class="flex flex-wrap gap-2">
                        @if (room.HasPrivateBathroom)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.Bathtub">Private Bathroom</MudChip>
                        }
                        @if (room.HasAirConditioning)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.AcUnit">AC</MudChip>
                        }
                        @if (room.HasHeating)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.Thermostat">Heating</MudChip>
                        }
                        @if (room.HasWifi)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.Wifi">Wi-Fi</MudChip>
                        }
                        @if (room.HasDesk)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.Desk">Desk</MudChip>
                        }
                        @if (room.HasWardrobe)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.Checkroom">Wardrobe</MudChip>
                        }
                        @if (room.HasBalcony)
                        {
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                                Icon="@Icons.Material.Filled.Balcony">Balcony</MudChip>
                        }
                    </div>
                </MudPaper>
            </MudItem>

            <!-- Booking Form -->
            <MudItem xs="12" md="4">
                <MudPaper Elevation="4" Class="p-6 rounded-3xl bg-surface relative">
                    <MudText Class="text-xl font-bold mb-4">@L["BookThisRoom"]</MudText>

                    <MudStack Spacing="4">
                        <MudDatePicker Label="@L["StartDate"]" @bind-Date="startDate" MinDate="DateTime.Today"
                            Variant="Variant.Outlined" Color="Color.Primary" />
                        <MudDatePicker Label="@L["EndDate"]" @bind-Date="endDate" MinDate="startDate"
                            Variant="Variant.Outlined" Color="Color.Primary" />

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="rounded-lg">@errorMessage
                            </MudAlert>
                        }

                        @if (showPaymentConfirmation)
                        {
                            <MudPaper Class="p-4 bg-primary-50 rounded-xl" Elevation="0">
                                <MudText Typo="Typo.subtitle2" Class="mb-2 font-bold text-primary">@L["PaymentConfirmation"]
                                </MudText>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Total Fee:</MudText>
                                    <MudText Class="font-bold">@calculatedFeeAmount @calculatedFeeCurrency</MudText>
                                </MudStack>
                                <MudDivider Class="my-2" />
                                <MudStack Row="true" Spacing="2">
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                        OnClick="@ProcessReservation" DisableElevation="true">
                                        @L["PayNow"]
                                    </MudButton>
                                    <MudButton Variant="Variant.Text" Color="Color.Secondary"
                                        OnClick="@(() => showPaymentConfirmation = false)">
                                        @L["Cancel"]
                                    </MudButton>
                                </MudStack>
                            </MudPaper>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true"
                                OnClick="@CalculateFeeAndShowPayment"
                                Class="rounded-xl py-3 font-bold shadow-lg shadow-primary/30">
                                @L["ConfirmAndPay"]
                            </MudButton>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            @if (reservationResponse != null)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="rounded-2xl"
                        Icon="@Icons.Material.Filled.CheckCircle">
                        <MudText Typo="Typo.h6" Class="font-bold">@L["ReservationSuccess"]</MudText>
                        <MudText>@L["ReservationId"]: @reservationResponse.ReservationId</MudText>
                        <MudText>@L["AmountPaid"]: @reservationResponse.AmountPaid.Amount
                            @reservationResponse.AmountPaid.Currency</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Href="/student/residences"
                            Class="mt-2 font-bold underline">@L["BackToResidences"]</MudButton>
                    </MudAlert>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid ResidenceId { get; set; }

    [Parameter]
    public Guid RoomId { get; set; }

    private RoomDto? room; // Using RoomDto to display details
    private Guid studentId = Guid.Empty; // Placeholder for authenticated student ID
    private DateTime? startDate = DateTime.Today;
    private DateTime? endDate = DateTime.Today.AddMonths(1);
    private bool showPaymentConfirmation = false;
    private decimal calculatedFeeAmount;
    private string calculatedFeeCurrency = "LYD";
    private string errorMessage = string.Empty;
    private ReserveRoomResponse? reservationResponse;

    protected override async Task OnInitializedAsync()
    {
        // In a real application, retrieve the student ID from the authenticated user's context.
        // For demonstration, we'll try to get it from AuthenticationState.
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            // Assuming StudentId is stored as a claim, e.g., "sub" or a custom claim
            var studentIdClaim = user.FindFirst("StudentId") ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (Guid.TryParse(studentIdClaim?.Value, out var parsedStudentId))
            {
                studentId = parsedStudentId;
            }
            else
            {
                errorMessage = L["Reservation_Error_StudentIdMissing"].Value;
                return;
            }
        }
        else
        {
            errorMessage = L["Reservation_Error_NotAuthenticated"].Value;
            return;
        }

        try
        {
            // Fetch room details for display
            room = await Http.GetFromJsonAsync<RoomDto>($"api/admin/AdminRooms/{RoomId}");
            if (room != null && room.ResidenceId != ResidenceId)
            {
                errorMessage = L["Reservation_Error_RoomMismatch"].Value;
                room = null; // Invalidate room if mismatch
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = string.Format(L["Reservation_Error_FetchRoom"].Value, ex.Message);
            Console.WriteLine(errorMessage);
        }
    }

    private Task CalculateFeeAndShowPayment()
    {
        errorMessage = string.Empty; // Clear previous errors

        if (startDate == null || endDate == null)
        {
            errorMessage = L["Reservation_Error_SelectDates"].Value;
            return Task.CompletedTask;
        }

        if (startDate >= endDate)
        {
            errorMessage = L["Reservation_Error_EndDateBeforeStartDate"].Value;
            return Task.CompletedTask;
        }

        // To get the calculated fee without making a full reservation,
        // we ideally need a separate endpoint for fee calculation.
        // For simplicity in this dummy setup, we will attempt a reservation,
        // but first, we'll create a temporary ReserveRoomRequest
        // and send it to the backend to get the calculated fee from the response.
        // This is a simplification; a dedicated GET endpoint for fee estimation would be better.

        // We can't actually just "calculate" the fee from the backend without initiating payment.
        // The ReserveRoomAsync on the backend integrates fee calculation and payment.
        // So, we'll present a generic "Confirm & Pay" which then calls the actual reservation endpoint.
        // The fee will be part of the successful reservation response.

        // The user experience expects to see the fee *before* confirming payment.
        // Since our backend ReserveRoomAsync integrates calculation AND payment,
        // I will first call the backend to get the RoomDetailsDto for the student to get the adjusted price.
        // This requires a new endpoint or modifying an existing one to just get the details.

        // For now, I will simulate getting a calculated fee by just showing a dummy amount
        // or by making an early call to the full reservation endpoint and catching errors.
        // A dedicated API endpoint to calculate *just* the fee would be ideal.

        // Simulating fee calculation by directly calling an API that might return a fee
        // Or, more accurately, we know the fee is handled server-side, so we just
        // show the payment confirmation and the fee will be in the final success message.
        // For a true "show calculated fee before pay" flow, the backend would need a separate endpoint.
        // Given the prompt, I'll proceed with a dummy payment screen shown after "Confirm & Pay".
        // The actual fee will be in the reservationResponse.

        // For this frontend, let's just use the room's base monthly rent for display
        // as a placeholder, then the actual calculated fee will come from the backend.
        if (room?.MonthlyRentAmount != null)
        {
            calculatedFeeAmount = room.MonthlyRentAmount.Value;
            calculatedFeeCurrency = room.MonthlyRentCurrency ?? "LYD";
            showPaymentConfirmation = true;
        }
        else
        {
            errorMessage = L["Reservation_Error_RentNotAvailable"].Value;
        }

        return Task.CompletedTask;
    }


    private async Task ProcessReservation()
    {
        errorMessage = string.Empty; // Clear previous errors
        showPaymentConfirmation = false; // Hide payment confirmation UI

        if (studentId == Guid.Empty)
        {
            errorMessage = L["Reservation_Error_StudentIdMissingAction"].Value;
            return;
        }
        if (room == null)
        {
            errorMessage = L["Reservation_Error_RoomDetailsMissing"].Value;
            return;
        }
        if (startDate == null || endDate == null)
        {
            errorMessage = L["Reservation_Error_InvalidDates"].Value;
            return;
        }

        var request = new ReservationRequestDto
            {
                StudentId = studentId,
                RoomId = RoomId,
                StartDate = DateOnly.FromDateTime(startDate.Value),
                EndDate = DateOnly.FromDateTime(endDate.Value)
            };

        try
        {
            var response = await Http.PostAsJsonAsync("api/student/StudentReservations/reserve-room", request);
            if (!response.IsSuccessStatusCode) // Throws HttpRequestException for 4xx/5xx errors
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = error;
                return;
            }

            reservationResponse = await response.Content.ReadFromJsonAsync<ReserveRoomResponse>();
            // Update UI to show success
        }
        catch (HttpRequestException ex)
        {
            var errorContent = await Extensions.HttpRequestExceptionExtensions.GetContentAs<dynamic>(ex);
            errorMessage = errorContent?.message ?? L["Reservation_Error_Unknown"].Value;
            Console.WriteLine($"Error during reservation: {ex.Message}. Details: {errorContent?.message}");
        }
        catch (Exception ex)
        {
            errorMessage = string.Format(L["Reservation_Error_Unexpected"].Value, ex.Message);
            Console.WriteLine(errorMessage);
        }
    }
}
