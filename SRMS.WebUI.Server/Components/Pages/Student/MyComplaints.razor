@page "/student/complaints"
@using Microsoft.EntityFrameworkCore
@using SRMS.Application.Complaints.CreateComplaint
@using SRMS.Domain.Students.Enums
@using SRMS.Domain.ValueObjects
@using SRMS.Infrastructure
@using System.Security.Claims
@using Microsoft.Extensions.Localization
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@inject IServiceScopeFactory ScopeFactory
@inject IStringLocalizer<Resource> L
@attribute [Authorize(Roles = "Student")]
@rendermode InteractiveServer

<PageTitle>@L["MyComplaints_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    @* Header Section *@
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <div class="flex items-center gap-2">
                <MudIcon Icon="@Icons.Material.Filled.ReportProblem" Class="text-4xl md:text-5xl text-primary" />
                <MudText Class="text-3xl md:text-4xl font-bold text-gradient">@L["MyComplaints_Header"]</MudText>
            </div>
            <MudText Class="text-sm md:text-base text-secondary mt-1">@L["MyComplaints_Subtitle"]
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Add"
            Class="btn-modern w-full md:w-auto" OnClick="@OpenNewComplaintDialog" Size="Size.Large">
            @L["MyComplaints_NewComplaint"]
        </MudButton>
    </div>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    @* Statistics Cards *@
    <MudGrid Spacing="4" Class="mb-6">
        <MudItem xs="6" sm="6" md="3">
            <MudPaper Class="glass-card p-4 text-center rounded-2xl" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mb-2 text-4xl md:text-5xl"
                    Style="color: #9c7cf4;" />
                <MudText Class="text-2xl md:text-4xl font-bold text-white">@_complaints.Count</MudText>
                <MudText Class="text-sm md:text-base text-[#9c7cf4]">@L["MyComplaints_Stat_Total"]</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="glass-card pa-4 text-center" Elevation="0" Style="border-radius: 16px;">
                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large"
                    Style="color: #f4a62a; font-size: 2.5rem;" Class="mb-2" />
                <MudText Typo="Typo.h3" Style="color: white; font-weight: 600;">@OpenCount</MudText>
                <MudText Typo="Typo.body2" Style="color: #f4a62a;">@L["MyComplaints_Stat_Open"]</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="glass-card pa-4 text-center" Elevation="0" Style="border-radius: 16px;">
                <MudIcon Icon="@Icons.Material.Filled.Autorenew" Size="Size.Large"
                    Style="color: #64b5f6; font-size: 2.5rem;" Class="mb-2" />
                <MudText Typo="Typo.h3" Style="color: white; font-weight: 600;">@InProgressCount</MudText>
                <MudText Typo="Typo.body2" Style="color: #64b5f6;">@L["MyComplaints_Stat_InProgress"]</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="glass-card pa-4 text-center" Elevation="0" Style="border-radius: 16px;">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large"
                    Style="color: #4caf50; font-size: 2.5rem;" Class="mb-2" />
                <MudText Typo="Typo.h3" Style="color: white; font-weight: 600;">@ResolvedCount</MudText>
                <MudText Typo="Typo.body2" Style="color: #4caf50;">@L["MyComplaints_Stat_Resolved"]</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @* Complaints Table *@
    <MudPaper Class="glass-card" Elevation="0" Style="border-radius: 16px;">
        @if (!_complaints.Any() && !_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="pa-12">
                <MudIcon Icon="@Icons.Material.Outlined.Inbox" Size="Size.Large" Style="color: #64b5f6; font-size: 4rem;"
                    Class="mb-4" />
                <MudText Typo="Typo.h5" Style="color: white;">@L["MyComplaints_NoComplaints"]</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @L["MyComplaints_NoComplaintsSub"]
                </MudText>
            </MudStack>
        }
        else
        {
            <MudTable Items="@_complaints" Hover="true" Breakpoint="Breakpoint.Sm" Class="glass-table" Elevation="0"
                Loading="@_isLoading">
                <HeaderContent>
                    <MudTh>@L["MyComplaints_Table_ID"]</MudTh>
                    <MudTh>@L["MyComplaints_Table_Subject"]</MudTh>
                    <MudTh>@L["MyComplaints_Table_Category"]</MudTh>
                    <MudTh>@L["MyComplaints_Table_Date"]</MudTh>
                    <MudTh>@L["MyComplaints_Table_Status"]</MudTh>
                    <MudTh>@L["MyComplaints_Table_Priority"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@L["MyComplaints_Table_ID"]">
                        <MudText Typo="Typo.caption" Color="Color.Primary">@context.ComplaintNumber</MudText>
                    </MudTd>
                    <MudTd DataLabel="@L["MyComplaints_Table_Subject"]">@context.Title</MudTd>
                    <MudTd DataLabel="@L["MyComplaints_Table_Category"]">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.ComplaintType</MudChip>
                    </MudTd>
                    <MudTd DataLabel="@L["MyComplaints_Table_Date"]">@context.CreatedAt.ToShortDateString()</MudTd>
                    <MudTd DataLabel="@L["MyComplaints_Table_Status"]">
                        <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="@L["MyComplaints_Table_Priority"]">
                        <MudChip T="string" Color="@GetPriorityColor(context.Priority)" Size="Size.Small"
                            Variant="Variant.Outlined">@context.Priority</MudChip>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ComplaintDto> _complaints = new();
    private bool _isLoading = true;
    private Guid _currentStudentId;

    private int OpenCount => _complaints.Count(c => c.Status == ComplaintStatus.Open);
    private int InProgressCount => _complaints.Count(c => c.Status == ComplaintStatus.InProgress);
    private int ResolvedCount => _complaints.Count(c => c.Status == ComplaintStatus.Resolved);

    protected override async Task OnInitializedAsync()
    {
        await LoadOrCreateStudent();
        await LoadComplaints();
    }

    private async Task LoadOrCreateStudent()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated != true)
            {
                Snackbar.Add(L["MyComplaints_LoginRequired"].Value, Severity.Warning);
                return;
            }

            // Get email from claims
            var email = user.FindFirst(ClaimTypes.Email)?.Value
            ?? user.FindFirst("email")?.Value;

            if (string.IsNullOrEmpty(email))
            {
                Snackbar.Add(L["Error_EmailNotFound"].Value, Severity.Error);
                return;
            }

            // Use scoped DbContext to avoid threading issues
            using var scope = ScopeFactory.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();

            // Try to find student by email
            var student = await context.Students
            .FirstOrDefaultAsync(s => s.Email != null && s.Email.Value == email);

            if (student != null)
            {
                _currentStudentId = student.Id;
                return;
            }

            // Student not found - create one automatically
            var appUser = await userManager.FindByEmailAsync(email);
            if (appUser == null)
            {
                Snackbar.Add(L["MyComplaints_UserAccountNotFound"].Value, Severity.Error);
                return;
            }

            // Create new student record linked to the user
            var newStudent = new Student
                {
                    Id = Guid.NewGuid(),
                    FirstName = appUser.FirstName ?? "Unknown",
                    LastName = appUser.LastName ?? "User",
                    Email = Email.Create(email),
                    PhoneNumber = !string.IsNullOrEmpty(appUser.PhoneNumber) ? PhoneNumber.Create(appUser.PhoneNumber) : null,
                    NationalId = appUser.NationalId,
                    DateOfBirth = appUser.DateOfBirth,
                    Gender = Gender.Male, // Default
                    Status = StudentStatus.Active,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow,
                    IsActive = true,
                    IsDeleted = false
                };

            context.Students.Add(newStudent);
            await context.SaveChangesAsync();
            _currentStudentId = newStudent.Id;

            Snackbar.Add(L["MyComplaints_ProfileCreated"].Value, Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Error_LoadingStudentData"].Value, ex.Message), Severity.Error);
        }
    }

    private async Task LoadComplaints()
    {
        if (_currentStudentId == Guid.Empty)
        {
            _isLoading = false;
            return;
        }

        _isLoading = true;
        try
        {
            // Use scoped DbContext to avoid threading issues
            using var scope = ScopeFactory.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

            var complaints = await context.Complaints
                .Where(c => c.Reservation.StudentId == _currentStudentId && !c.IsDeleted)
                .OrderByDescending(c => c.CreatedAt).Include(complaint => complaint.ComplaintType)
                .ToListAsync();

            var student = await context.Students.FindAsync(_currentStudentId);
            var studentName = student?.FullName ?? "Unknown";

            _complaints = complaints.Select(c => new ComplaintDto
                {
                    Id = c.Id,
                    ComplaintNumber = c.ComplaintNumber,
                    Title = c.Title,
                    ComplaintType = c.ComplaintType.Name,
                    Priority = c.Priority,
                    Status = c.Status,
                    ReservationId = c.ReservationId,
                    StudentName = studentName,
                    CreatedAt = c.CreatedAt,
                    IsResolved = c.Status == ComplaintStatus.Resolved
                }).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Error_LoadingComplaints"].Value, ex.Message), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenNewComplaintDialog()
    {
        if (_currentStudentId == Guid.Empty)
        {
            Snackbar.Add(L["MyComplaints_UnableToIdentifyStudent"].Value, Severity.Warning);
            return;
        }

        // Fetch the current active reservation ID for the student
        Guid reservationId;
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
            var reservation = await context.Reservations
            .Where(r => r.StudentId == _currentStudentId && r.Status == Domain.Reservations.Enums.ReservationStatus.Confirmed)
            .OrderByDescending(r => r.CreatedAt)
            .FirstOrDefaultAsync();

            if (reservation == null)
            {
                Snackbar.Add(L["MyComplaints_NoActiveReservation"].Value, Severity.Warning);
                return;
            }
            reservationId = reservation.Id;
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["MyComplaints_CheckReservationError"].Value, ex.Message), Severity.Error);
            return;
        }

        var parameters = new DialogParameters<CreateComplaintDialog>
{
{ x => x.ReservationId, reservationId }
};

        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true
            };

        var dialog = await DialogService.ShowAsync<CreateComplaintDialog>("New Complaint", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: CreateComplaintDto complaintDto })
        {
            try
            {
                // Use scoped services to avoid threading issues
                using var scope = ScopeFactory.CreateScope();
                var sender = scope.ServiceProvider.GetRequiredService<ISender>();

                var command = new CreateComplaintCommand(complaintDto);
                await sender.Send(command);
                Snackbar.Add(L["MyComplaints_SubmitSuccess"].Value, Severity.Success);
                await LoadComplaints();
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(L["MyComplaints_SubmitError"].Value, ex.Message), Severity.Error);
            }
        }
    }

    private Color GetPriorityColor(ComplaintPriority priority) => priority switch
    {
        ComplaintPriority.Critical => Color.Error,
        ComplaintPriority.High => Color.Warning,
        ComplaintPriority.Medium => Color.Info,
        ComplaintPriority.Low => Color.Success,
        _ => Color.Default
    };

    private Color GetStatusColor(ComplaintStatus status) => status switch
    {
        ComplaintStatus.Open => Color.Warning,
        ComplaintStatus.InProgress => Color.Info,
        ComplaintStatus.Resolved => Color.Success,
        ComplaintStatus.Closed => Color.Default,
        _ => Color.Default
    };
}
