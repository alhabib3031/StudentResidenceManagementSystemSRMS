@page "/student/residences"
@attribute [Authorize(Roles = "Student")]
@using SRMS.Application.Reservations.Interfaces
@using SRMS.Application.Residences.DTOs
@using Microsoft.Extensions.Localization
@inject IReservationService ReservationService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IStringLocalizer<StudentResidences> L
@rendermode InteractiveServer

<PageTitle>@L["Available Residences"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8 mb-12">
    <MudPaper Elevation="0" Class="pa-8 rounded-3xl bg-gradient-to-r from-purple-600 to-indigo-700 relative overflow-hidden mb-8">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="relative z-10">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h3" Class="text-white font-bold">@L["Available Residences"]</MudText>
                <MudText Typo="Typo.h6" Class="text-white/80">@L["Browse and book your accommodation"]</MudText>
            </MudStack>
            <MudAvatar Size="Size.Large" Color="Color.Surface" Style="height:80px; width:80px;" Class="shadow-xl">
                <MudIcon Icon="@Icons.Material.Filled.Apartment" Size="Size.Large" />
            </MudAvatar>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 50vh;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (_residences == null || !_residences.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="rounded-xl">
            @L["No residences currently available."]
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var residence in _residences)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4" Class="rounded-3xl hover-lift h-100">
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.h5" Class="font-bold">@residence.Name</MudText>
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">
                                        @L["Available"]
                                    </MudChip>
                                </div>
                                
                                <MudDivider />
                                
                                <MudStack Spacing="2">
                                    @if (!string.IsNullOrEmpty(residence.Description))
                                    {
                                        <div class="d-flex align-center gap-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Primary" />
                                            <MudText Typo="Typo.body2">@residence.Description</MudText>
                                        </div>
                                    }
                                    
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Typo="Typo.body2">@L["Total Capacity"]: @residence.TotalCapacity</MudText>
                                    </div>
                                    
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                                        <MudText Typo="Typo.body2">@L["Available"]: @residence.AvailableCapacity</MudText>
                                    </div>
                                    
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Hotel" Size="Size.Small" Color="Color.Info" />
                                        <MudText Typo="Typo.body2">@L["Rooms"]: @residence.CurrentRoomsCount / @residence.MaxRoomsCount</MudText>
                                    </div>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Visibility"
                                       OnClick="@(() => ShowVacantRooms(residence.Id, residence.Name))"
                                       Class="rounded-xl">
                                @L["View Vacant Rooms"]
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hover-lift:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
</style>

@code {
    private IEnumerable<ResidenceDto>? _residences;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadResidences();
    }

    private async Task LoadResidences()
    {
        _isLoading = true;
        try
        {
            _residences = await ReservationService.GetAvailableResidencesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{@L["Error loading residences"]}: {ex.Message}", Severity.Error);
            Console.WriteLine($"Error fetching residences: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ShowVacantRooms(Guid residenceId, string residenceName)
    {
        var parameters = new DialogParameters
        {
            { "ResidenceId", residenceId },
            { "ResidenceName", residenceName }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<VacantRoomsDialog>($"{@L["Vacant Rooms in"]} {residenceName}", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Refresh if booking was made
            await LoadResidences();
        }
    }
}
