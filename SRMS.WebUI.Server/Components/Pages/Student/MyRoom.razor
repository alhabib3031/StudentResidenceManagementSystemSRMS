@page "/my-room"
@using Microsoft.AspNetCore.Authorization
@using SRMS.Application.Reservations.Interfaces
@using SRMS.Application.Rooms.Interfaces
@using SRMS.Application.Rooms.DTOs
@using SRMS.Domain.Reservations.Enums
@using System.Security.Claims
@using Microsoft.Extensions.Localization
@inject IReservationService ReservationService
@inject IRoomService RoomService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IStringLocalizer<MyRoom> L
@attribute [Authorize(Roles = "Student")]

<PageTitle>@L["My Room"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @if (_isLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 50vh;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (_roomDetails == null)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="rounded-xl">
            @L["You do not have an active room reservation at this time."]
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <!-- Room Info Card -->
            <MudItem xs="12" md="8">
                <MudCard Elevation="3" Class="rounded-xl overflow-hidden glass-effect">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5" Color="Color.Primary" Class="fw-bold">@L["My Room"]
                                @_roomDetails.RoomNumber</MudText>
                            <MudText Typo="Typo.subtitle1">@_roomDetails.ResidenceName - @L["Floor"] @_roomDetails.Floor
                            </MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">
                                @L["Occupied"]</MudChip>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Class="text-muted">@L["Room Type"]</MudText>
                                <MudText Typo="Typo.body1">@_roomDetails.RoomType</MudText>
                            </MudItem>
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Class="text-muted">@L["Monthly Rent"]</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Secondary">
                                    @_roomDetails.AdjustedMonthlyRent.ToString("C")</MudText>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-4" />

                        <MudText Typo="Typo.h6" Class="mb-3">@L["Features & Amenities"]</MudText>
                        <div class="d-flex flex-wrap gap-2">
                            @if (_roomDetails.HasWifi)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Wifi"
                                    Color="Color.Primary" Variant="Variant.Outlined">@L["Wi-Fi"]</MudChip>
                            }
                            @if (_roomDetails.HasPrivateBathroom)
                            {
                                <MudChip T="string"
                                    Icon="@Icons.Material.Filled.Bathtub" Color="Color.Info" Variant="Variant.Outlined">
                                    @L["Private Bathroom"]</MudChip>
                            }
                            @if (_roomDetails.HasAirConditioning)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.AcUnit"
                                    Color="Color.Info" Variant="Variant.Outlined">@L["Air Conditioning"]</MudChip>
                            }
                            @if (_roomDetails.HasHeating)
                            {
                                <MudChip T="string"
                                    Icon="@Icons.Material.Filled.LocalFireDepartment" Color="Color.Warning"
                                    Variant="Variant.Outlined">@L["Heating"]</MudChip>
                            }
                            @if (_roomDetails.HasDesk)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Desk"
                                    Color="Color.Default" Variant="Variant.Outlined">@L["Desk"]</MudChip>
                            }
                            @if (_roomDetails.HasWardrobe)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Checkroom"
                                    Color="Color.Default" Variant="Variant.Outlined">@L["Wardrobe"]</MudChip>
                            }
                            @if (_roomDetails.HasBalcony)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Balcony"
                                    Color="Color.Success" Variant="Variant.Outlined">@L["Balcony"]</MudChip>
                            }
                        </div>

                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Roommates Card -->
            <MudItem xs="12" md="4">
                <MudCard Elevation="3" Class="rounded-xl glass-effect h-100">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["My Roommates"]</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Primary" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_roomDetails.Roommates.Any())
                        {
                            <MudList T="string" Dense="true">
                                @foreach (var roommate in _roomDetails.Roommates)
                                {
                                    <MudListItem Icon="@Icons.Material.Filled.Person">
                                        <MudText>@roommate</MudText>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-muted text-center py-4">@L["You have no roommates yet."]
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .glass-effect {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .mud-theme-dark .glass-effect {
        background: rgba(30, 30, 30, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
</style>

@code {
    private RoomDetailsDto? _roomDetails;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var studentIdClaim = user.FindFirst("StudentId");
                if (studentIdClaim != null && Guid.TryParse(studentIdClaim.Value, out var studentId))
                {
                    // Find active reservation
                    var reservations = await ReservationService.GetStudentReservationsAsync(studentId);
                    var activeReservation = reservations.FirstOrDefault(r =>
                    r.Status == ReservationStatus.Confirmed &&
                    r.EndDate >= DateOnly.FromDateTime(DateTime.UtcNow));

                    if (activeReservation != null)
                    {
                        _roomDetails = await RoomService.GetRoomDetailsForStudentAsync(activeReservation.RoomId, studentId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Error loading room details"], Severity.Error);
            Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
