@page "/student"
@using Microsoft.Extensions.Localization
@using SRMS.Application.Identity.Interfaces
@using SRMS.Application.Identity.DTOs
@using SRMS.WebUI.Server.Resources
@attribute [Authorize(Roles = "Student")]
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserService UserService
@inject IDashboardStatisticsService DashboardService
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> L
@using SRMS.Application.Dashboards.Interfaces
@using SRMS.Application.Dashboards.DTOs
@rendermode InteractiveServer

<PageTitle>@L["MyDashboard"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-6 mb-12">
    <!-- Welcome Header -->
    <MudPaper Elevation="0"
        Class="pa-8 rounded-3xl bg-gradient-to-br from-primary to-secondary relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="relative z-10">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h3" Class="text-white font-bold">
                    @L["WelcomeBack"], @_user?.FirstName!
                </MudText>
                <MudText Typo="Typo.h6" Class="text-white/80">
                    <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" Class="mr-1" />
                    @_studentDetails?.CollegeName | @_studentDetails?.Major
                </MudText>
            </MudStack>
            <MudAvatar Size="Size.Large" Color="Color.Surface" Style="height:100px; width:100px;" Class="shadow-xl">
                @if (!string.IsNullOrEmpty(_user?.ProfilePicture))
                {
                    <MudImage Src="@_user.ProfilePicture" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                }
            </MudAvatar>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="my-6 rounded-full" />
    }

    <MudGrid Class="mt-4">
        <!-- Quick Stats -->
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="4" Class="pa-6 rounded-3xl hover-lift">
                <MudStack Row="true" Justify="Justify.SpaceBetween">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Class="opacity-60 font-bold uppercase">@L["MyRoom"]</MudText>
                        <MudText Typo="Typo.h5" Class="font-bold">@(_roomNumber ?? "Not Assigned")</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="rounded-2xl">
                            <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" />
                        </MudAvatar>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6 rounded-3xl hover-lift">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="opacity-60 font-bold uppercase">@L["DueAmount"]</MudText>
                            <MudText Typo="Typo.h5" Class="font-bold text-error">@_dueAmount LYD</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Error" Variant="Variant.Filled" Class="rounded-2xl">
                            <MudIcon Icon="@Icons.Material.Filled.Payment" />
                        </MudAvatar>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6 rounded-3xl hover-lift">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="opacity-60 font-bold uppercase">@L["ActiveComplaints"]
                            </MudText>
                            <MudText Typo="Typo.h5" Class="font-bold">@_activeComplaints</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Warning" Variant="Variant.Filled" Class="rounded-2xl">
                            <MudIcon Icon="@Icons.Material.Filled.Report" />
                        </MudAvatar>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6 rounded-3xl hover-lift">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="opacity-60 font-bold uppercase">@L["StudentStatus"]
                            </MudText>
                            <MudChip T="string" Color="@GetStatusColor(_dashboardData?.Status)" Size="Size.Small" Class="mt-1">
                                @(_dashboardData?.Status.ToString() ?? "N/A")
                            </MudChip>
                        </MudStack>
                        <MudAvatar Color="@GetStatusColor(_dashboardData?.Status)" Variant="Variant.Filled" Class="rounded-2xl">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                        </MudAvatar>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Main Content -->
            <MudItem xs="12" md="8">
                <MudStack Spacing="6">
                    <!-- Academic Details Section -->
                    <MudPaper Elevation="4" Class="pa-6 rounded-3xl">
                        <MudText Typo="Typo.h6" Class="font-bold mb-4">@L["ProfileCompletion_Step_Academic"]</MudText>
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.caption" Class="opacity-50">@L["ProfileCompletion_University"]</MudText>
                                <MudText Typo="Typo.body1">@_studentDetails?.UniversityName</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.caption" Class="opacity-50">@L["ProfileCompletion_StudentNumber"]
                                </MudText>
                                <MudText Typo="Typo.body1">@_studentDetails?.StudentNumber</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.caption" Class="opacity-50">@L["ProfileCompletion_AcademicYear"]
                                </MudText>
                                <MudText Typo="Typo.body1">@_studentDetails?.AcademicYear</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.caption" Class="opacity-50">@L["ProfileCompletion_Step_AcademicTerm"]
                                </MudText>
                                <MudText Typo="Typo.body1">@_studentDetails?.AcademicTerm</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    <!-- Quick Actions -->
                    <MudPaper Elevation="4" Class="pa-6 rounded-3xl">
                        <MudText Typo="Typo.h6" Class="font-bold mb-4">@L["QuickActions"]</MudText>
                        <MudGrid Spacing="4">
                            <MudItem xs="6" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                    Class="pa-8 w-full rounded-2xl flex-col" Href="/student/complaints/create">
                                    <MudIcon Icon="@Icons.Material.Filled.AddComment" Size="Size.Large" Class="mb-2" />
                                    @L["SubmitComplaint"]
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Success"
                                    Class="pa-8 w-full rounded-2xl flex-col" Href="/student/payments">
                                    <MudIcon Icon="@Icons.Material.Filled.Wallet" Size="Size.Large" Class="mb-2" />
                                    @L["MakePayment"]
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Info"
                                    Class="pa-8 w-full rounded-2xl flex-col" Href="/student/profile">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Class="mb-2" />
                                    @L["MyProfile"]
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                    Class="pa-8 w-full rounded-2xl flex-col" Href="/student/room">
                                    <MudIcon Icon="@Icons.Material.Filled.House" Size="Size.Large" Class="mb-2" />
                                    @L["ViewRoom"]
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudStack>
            </MudItem>

            <!-- Side Content: Notifications/Announcements -->
            <MudItem xs="12" md="4">
                <MudStack Spacing="6">
                    <MudPaper Elevation="4" Class="pa-6 rounded-3xl">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Campaign" Color="Color.Warning" />
                            <MudText Typo="Typo.h6" Class="font-bold">@L["ImportantAnnouncements"]</MudText>
                        </MudStack>
                        <MudStack Spacing="3">
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="rounded-xl">@L["PaymentReminder"]
                            </MudAlert>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="rounded-xl">@L["BuildingAMaintenance"]
                            </MudAlert>
                        </MudStack>
                    </MudPaper>

                    <MudPaper Elevation="4" Class="pa-6 rounded-3xl">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Notifications" Color="Color.Error" />
                            <MudText Typo="Typo.h6" Class="font-bold">@L["RecentActivity"]</MudText>
                        </MudStack>
                        <MudList T="string">
                            @if (_dashboardData?.RecentActivities.Any() == true)
                            {
                                @foreach (var activity in _dashboardData.RecentActivities)
                                {
                                    <MudListItem Icon="@GetActivityIcon(activity.Type)">
                                        <MudText Typo="Typo.body2">@activity.Title</MudText>
                                        <MudText Typo="Typo.caption" Class="opacity-50">@activity.Timestamp.ToLocalTime().ToString("g")</MudText>
                                    </MudListItem>
                                }
                            }
                            else
                            {
                                <MudListItem>
                                    <MudText Typo="Typo.body2" Class="opacity-50">No recent activity</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudContainer>

    <style>
        .hover-lift {
            transition: transform 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-8px);
        }
    </style>

    @code {
    private UserDto? _user;
    private StudentReviewDto? _studentDetails;
    private StudentDashboardDataDto? _dashboardData;
    private bool _isLoading = true;
    private string? _roomNumber => _dashboardData?.RoomNumber;
    private decimal _dueAmount => _dashboardData?.DueAmount ?? 0;
    private int _activeComplaints => _dashboardData?.ActiveComplaintsCount ?? 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var email = user.Identity.Name;
            if (email != null)
            {
                _user = await UserService.GetUserByEmailAsync(email);
                if (_user != null)
                {
                    var reviewDetails = await UserService.GetUserReviewDetailsAsync(_user.Id);
                    _studentDetails = reviewDetails?.StudentDetails;
                }
            }
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        if (_user == null) return;
        
        _isLoading = true;
        try
        {
            _dashboardData = await DashboardService.GetStudentDashboardDataAsync(_user.Id);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetStatusColor(SRMS.Domain.Students.Enums.StudentStatus? status) => status switch
    {
        SRMS.Domain.Students.Enums.StudentStatus.Active => Color.Success,
        SRMS.Domain.Students.Enums.StudentStatus.ManagerApprovalPending => Color.Warning,
        SRMS.Domain.Students.Enums.StudentStatus.Suspended => Color.Error,
        _ => Color.Default
    };

    private string GetActivityIcon(string type) => type switch
    {
        "Notification" => Icons.Material.Filled.Notifications,
        "Payment" => Icons.Material.Filled.Payment,
        "Complaint" => Icons.Material.Filled.Report,
        _ => Icons.Material.Filled.History
    };
}
