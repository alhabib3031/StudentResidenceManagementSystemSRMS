@page "/admin/residences"
@using SRMS.Domain.Repositories
@using SRMS.Domain.Residences
@attribute [Authorize(Roles = "Admin,SuperRoot")]
@inject IRepositories<Residence> ResidenceRepo
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Residences Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4">
                    <MudIcon Icon="@Icons.Material.Filled.Apartment" Class="mr-2" />
                    Residences Management
                </MudText>
                <MudBreadcrumbs Items="_breadcrumbs" Class="mt-2" />
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                Href="/admin/residences/create">
                Add New Residence
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Statistics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Residences</MudText>
                            <MudText Typo="Typo.h4">@_residences.Count()</MudText>
                        </div>
                        <MudAvatar Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Apartment" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Capacity</MudText>
                            <MudText Typo="Typo.h4">@_residences.Sum(r => r.TotalCapacity)</MudText>
                        </div>
                        <MudAvatar Color="Color.Info">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Available Space</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Success">@_residences.Sum(r => r.AvailableCapacity)
                            </MudText>
                        </div>
                        <MudAvatar Color="Color.Success">
                            <MudIcon Icon="@Icons.Material.Filled.EventAvailable" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Avg Occupancy</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Warning">
                                @(GetAverageOccupancy().ToString("F0"))%
                            </MudText>
                        </div>
                        <MudAvatar Color="Color.Warning">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Search and Filter -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_searchString" Placeholder="Search residences..." Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Immediate="true" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect @bind-Value="_filterStatus" Label="Status" Variant="Variant.Outlined"
                    AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("all")">All Status</MudSelectItem>
                    <MudSelectItem Value="@("active")">Active</MudSelectItem>
                    <MudSelectItem Value="@("full")">Full</MudSelectItem>
                    <MudSelectItem Value="@("available")">Available</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                    StartIcon="@Icons.Material.Filled.FilterAltOff" OnClick="ClearFilters">
                    Clear Filters
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Residences Table -->
    <MudPaper Elevation="2">
        <MudTable Items="@GetFilteredResidences()" Hover="true" Striped="true" Loading="@_isLoading"
            LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Location</MudTh>
                <MudTh>Manager</MudTh>
                <MudTh>Capacity</MudTh>
                <MudTh>Occupancy</MudTh>
                <MudTh>Monthly Rent</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        @if (!string.IsNullOrEmpty(context.ImagePath))
                        {
                            <MudAvatar Image="@context.ImagePath" Size="Size.Small" />
                        }
                        else
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                <MudIcon Icon="@Icons.Material.Filled.Apartment" />
                            </MudAvatar>
                        }
                        <div>
                            <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                            @if (!string.IsNullOrEmpty(context.Description))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @(context.Description.Length > 50 ? context.Description.Substring(0, 50) + "..." :
                                        context.Description)
                                </MudText>
                            }
                        </div>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Location">
                    <MudText Typo="Typo.body2">
                        @if (context.Address != null)
                        {
                            <span>
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                @context.Address.City
                            </span>
                        }
                        else
                        {
                            <span class="mud-text-secondary">-</span>
                        }
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Manager">
                    @if (context.Manager != null)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">
                            @context.Manager.FullName
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                            Unassigned
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Capacity">
                    <MudText Typo="Typo.body2">
                        @context.AvailableCapacity / @context.TotalCapacity
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Occupancy">
                    @{
                        var occupancy = GetOccupancyRate(context);
                        var color = occupancy >= 90 ? Color.Error : occupancy >= 70 ? Color.Warning : Color.Success;
                    }
                    <MudProgressLinear Value="@occupancy" Color="@color" Size="Size.Large" Rounded="true">
                        <MudText Typo="Typo.caption" Color="Color.Surface">
                            @occupancy.ToString("F0")%
                        </MudText>
                    </MudProgressLinear>
                </MudTd>
                <MudTd DataLabel="Monthly Rent">
                    <MudText Typo="Typo.body2">
                        @(context.MonthlyRent?.ToString() ?? "N/A")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Status">
                    @if (context.IsFull)
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small">Full</MudChip>
                    }
                    else if (context.IsActive)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="@(() => ViewDetails(context))">
                            View Details
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditResidence(context))">
                            Edit
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.MeetingRoom" OnClick="@(() => ManageRooms(context))">
                            Manage Rooms
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error"
                            OnClick="@(() => DeleteResidence(context))">
                            Delete
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<Residence> _residences = new();
    private bool _isLoading = true;
    private string _searchString = "";
    private string _filterStatus = "all";

    private List<BreadcrumbItem> _breadcrumbs = new()
{
new BreadcrumbItem("Admin", href: "/admin", icon: Icons.Material.Filled.Home),
new BreadcrumbItem("Residences", href: null, disabled: true)
};

    protected override async Task OnInitializedAsync()
    {
        await LoadResidences();
    }

    private async Task LoadResidences()
    {
        _isLoading = true;

        try
        {
            var residences = await ResidenceRepo.GetAllAsync();
            _residences = residences.ToList();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private IEnumerable<Residence> GetFilteredResidences()
    {
        var filtered = _residences.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            filtered = filtered.Where(r =>
            r.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            (r.Address?.City?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (r.Manager?.FullName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Status filter
        filtered = _filterStatus switch
        {
            "active" => filtered.Where(r => r.IsActive && !r.IsFull),
            "full" => filtered.Where(r => r.IsFull),
            "available" => filtered.Where(r => !r.IsFull && r.AvailableCapacity > 0),
            _ => filtered
        };

        return filtered;
    }

    private void ClearFilters()
    {
        _searchString = "";
        _filterStatus = "all";
    }

    private double GetOccupancyRate(Residence residence)
    {
        if (residence.TotalCapacity == 0) return 0;
        return ((double)(residence.TotalCapacity - residence.AvailableCapacity) / residence.TotalCapacity) * 100;
    }

    private double GetAverageOccupancy()
    {
        if (!_residences.Any() || _residences.Sum(r => r.TotalCapacity) == 0) return 0;

        var totalOccupied = _residences.Sum(r => r.TotalCapacity - r.AvailableCapacity);
        var totalCapacity = _residences.Sum(r => r.TotalCapacity);

        return ((double)totalOccupied / totalCapacity) * 100;
    }

    private void ViewDetails(Residence residence)
    {
        Navigation.NavigateTo($"/admin/residences/{residence.Id}");
    }

    private void EditResidence(Residence residence)
    {
        Navigation.NavigateTo($"/admin/residences/edit/{residence.Id}");
    }

    private void ManageRooms(Residence residence)
    {
        Navigation.NavigateTo($"/admin/residences/{residence.Id}/rooms");
    }

    private async Task DeleteResidence(Residence residence)
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = $"Are you sure you want to delete '{residence.Name}'? This action cannot be undone.",
                ["ButtonText"] = "Delete",
                ["Color"] = Color.Error
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Delete", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            try
            {
                await ResidenceRepo.DeleteAsync(residence.Id);
                Snackbar.Add($"Residence '{residence.Name}' deleted successfully", Severity.Success);
                await LoadResidences();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}