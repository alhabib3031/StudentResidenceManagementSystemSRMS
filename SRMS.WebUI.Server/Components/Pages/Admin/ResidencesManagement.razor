@page "/admin/residences"
@using Microsoft.EntityFrameworkCore
@using SRMS.Domain.Residences
@using SRMS.Infrastructure
@using Microsoft.Extensions.Localization
@attribute [Authorize(Roles = "Admin,SuperRoot")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["ResidencesManagement_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="p-4 md:p-6 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Class="text-2xl md:text-4xl font-bold flex items-center">
                    <MudIcon Icon="@Icons.Material.Filled.Apartment" Class="mr-2 text-3xl md:text-4xl" />
                    @L["ResidencesManagement_Header"]
                </MudText>
                <MudBreadcrumbs Items="_breadcrumbs" Class="mt-2" />
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                OnClick="@OpenCreateDialog" Class="hidden md:flex">
                @L["ResidencesManagement_Button_Add"]
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Filled"
                OnClick="@OpenCreateDialog" Class="flex md:hidden" />
        </MudStack>
    </MudPaper>

    <!-- Statistics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="2" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["ResidencesManagement_Stats_Total"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Apartment" Color="Color.Primary" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-4xl font-bold">@_residences.Count()</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="2" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["ResidencesManagement_Stats_Capacity"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Color="Color.Info" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-4xl font-bold">@_residences.Sum(r => r.TotalCapacity)</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="2" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["ResidencesManagement_Stats_Available"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.EventAvailable" Color="Color.Success"
                                Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-4xl font-bold text-success">@_residences.Sum(r =>
                            r.AvailableCapacity)</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="6" sm="6" md="3">
            <MudCard Elevation="2" Class="h-full">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <div class="flex justify-between items-start">
                            <MudText Class="text-xs md:text-caption font-bold text-secondary uppercase">
                                @L["ResidencesManagement_Stats_AvgOccupancy"]</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Warning" Size="Size.Small" />
                        </div>
                        <MudText Class="text-xl md:text-4xl font-bold text-warning">
                            @(GetAverageOccupancy().ToString("F0"))%</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Search and Filter -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_searchString" Placeholder='@L["ResidencesManagement_SearchPlaceholder"]'
                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined"
                    Immediate="true" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect @bind-Value="_filterStatus" Label='@L["ResidencesManagement_Filter_Status"]'
                    Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("all")">@L["ResidencesManagement_Filter_AllStatuses"]</MudSelectItem>
                    <MudSelectItem Value="@("active")">@L["ResidencesManagement_Filter_Active"]</MudSelectItem>
                    <MudSelectItem Value="@("full")">@L["ResidencesManagement_Filter_Full"]</MudSelectItem>
                    <MudSelectItem Value="@("available")">@L["ResidencesManagement_Filter_Available"]</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                    StartIcon="@Icons.Material.Filled.FilterAltOff" OnClick="@ClearFilters">
                    @L["ResidencesManagement_Button_ClearFilters"]
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Residences Table -->
    <MudPaper Elevation="2" Class="mt-4">
        <MudTable Items="@GetFilteredResidences()" Hover="true" Striped="true" Loading="@_isLoading"
            LoadingProgressColor="Color.Primary" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>@L["ResidencesManagement_Table_Header_Name"]</MudTh>
                <MudTh>@L["ResidencesManagement_Table_Header_Location"]</MudTh>

                <MudTh>@L["ResidencesManagement_Table_Header_Capacity"]</MudTh>
                <MudTh>@L["ResidencesManagement_Table_Header_Occupancy"]</MudTh>

                <MudTh>@L["ResidencesManagement_Table_Header_Status"]</MudTh>
                <MudTh>@L["ResidencesManagement_Table_Header_Actions"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        @if (!string.IsNullOrEmpty(context.ImagePath))
                        {
                            <MudAvatar Image="@context.ImagePath" Size="Size.Small" />
                        }
                        else
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                <MudIcon Icon="@Icons.Material.Filled.Apartment" />
                            </MudAvatar>
                        }
                        <div>
                            <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                            @if (!string.IsNullOrEmpty(context.Description))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @(context.Description.Length > 50 ? context.Description.Substring(0, 50) + "..." :
                                        context.Description)
                                </MudText>
                            }
                        </div>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Location">
                    <MudText Typo="Typo.body2">
                        @if (context.Address != null)
                        {
                            <span>
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                @context.Address.City
                            </span>
                        }
                        else
                        {
                            <span class="mud-text-secondary">-</span>
                        }
                    </MudText>
                </MudTd>

                <MudTd DataLabel="Capacity">
                    <MudText Typo="Typo.body2">
                        @context.Rooms.Count() / @context.TotalCapacity
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Occupancy">
                    @{
                        var occupancy = GetOccupancyRate(context);
                        var color = occupancy >= 90 ? Color.Error : occupancy >= 70 ? Color.Warning : Color.Success;
                    }
                    <MudProgressLinear Value="@occupancy" Color="@color" Size="Size.Large" Rounded="true">
                        <MudText Typo="Typo.caption" Color="Color.Surface">
                            @occupancy.ToString("F0")%
                        </MudText>
                    </MudProgressLinear>
                </MudTd>

                <MudTd DataLabel="Status">
                    @if (context.IsFull)
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small">
                            @L["ResidencesManagement_Table_Status_Full"]</MudChip>
                    }
                    else if (context.IsActive)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">
                            @L["ResidencesManagement_Table_Status_Active"]</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Default" Size="Size.Small">
                            @L["ResidencesManagement_Table_Status_Inactive"]</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="@(() => ViewDetails(context))">
                            @L["ResidencesManagement_Actions_ViewDetails"]
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditResidence(context))">
                            @L["ResidencesManagement_Actions_Edit"]
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.MeetingRoom" OnClick="@(() => ManageRooms(context))">
                            @L["ResidencesManagement_Actions_ManageRooms"]
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error"
                            OnClick="@(() => DeleteResidence(context))">
                            @L["ResidencesManagement_Actions_Delete"]
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<Residence> _residences = new();
    private bool _isLoading = true;
    private string _searchString = "";
    private string _filterStatus = "all";

    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
    new("Admin", href: "/admin", icon: Icons.Material.Filled.Home),
    new("Residences", href: null, disabled: true)
    ];

    protected override async Task OnInitializedAsync()
    {
        await LoadResidences();
    }

    private async Task LoadResidences()
    {
        _isLoading = true;

        try
        {
            // Create a fresh DbContext for this operation using Factory
            await using var context = await DbFactory.CreateDbContextAsync();

            // Fetch residences
            _residences = await context.Residences
            .Include(r => r.Rooms) // Eagerly load rooms
            .Where(r => !r.IsDeleted)
            .ToListAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateResidenceDialog>(L["ResidencesManagement_Button_Add"]);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add(L["ResidencesManagement_Snackbar_Created"], Severity.Success);
            await LoadResidences();
        }
    }

    private IEnumerable<Residence> GetFilteredResidences()
    {
        var filtered = _residences.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            filtered = filtered.Where(r =>
            r.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            (r.Address?.City.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Status filter
        filtered = _filterStatus switch
        {
            "active" => filtered.Where(r => r is { IsActive: true, IsFull: false }),
            "full" => filtered.Where(r => r.IsFull),
            "available" => filtered.Where(r => r is { IsFull: false, AvailableCapacity: > 0 }),
            _ => filtered
        };

        return filtered;
    }

    private void ClearFilters()
    {
        _searchString = "";
        _filterStatus = "all";
    }

    private double GetOccupancyRate(Residence residence)
    {
        if (residence.TotalCapacity == 0) return 0;
        return ((double)(residence.TotalCapacity - residence.AvailableCapacity) / residence.TotalCapacity) * 100;
    }

    private double GetAverageOccupancy()
    {
        if (!_residences.Any() || _residences.Sum(r => r.TotalCapacity) == 0) return 0;

        var totalOccupied = _residences.Sum(r => r.TotalCapacity - r.AvailableCapacity);
        var totalCapacity = _residences.Sum(r => r.TotalCapacity);

        return ((double)totalOccupied / totalCapacity) * 100;
    }

    private async Task ViewDetails(Residence residence)
    {
        var parameters = new DialogParameters { ["Residence"] = residence };
        await DialogService.ShowAsync<ResidenceDetailsDialog>(L["ResidenceDetailsDialog_Title"].Value, parameters);
    }

    private async Task EditResidence(Residence residence)
    {
        var parameters = new DialogParameters { ["ResidenceToEdit"] = residence };
        var dialog = await DialogService.ShowAsync<EditResidenceDialog>(L["EditResidenceDialog_Title"].Value, parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadResidences();
        }
    }

    private void ManageRooms(Residence residence)
    {
        Navigation.NavigateTo($"/admin/residences/{residence.Id}/rooms");
    }

    private async Task DeleteResidence(Residence residence)
    {
        var parameters = new DialogParameters
            {
                ["ContentText"] = string.Format(L["ResidencesManagement_Dialog_ConfirmDelete_Content"], residence.Name),
                ["ButtonText"] = L["ResidencesManagement_Dialog_ConfirmDelete_Button"],
                ["Color"] = Color.Error
            };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>(L["ResidencesManagement_Dialog_ConfirmDelete_Title"],
        parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            try
            {
                await using var context = await DbFactory.CreateDbContextAsync();
                Console.WriteLine($"Attempting to delete residence with ID: {residence.Id}");
                var entity = await context.Residences.FindAsync(residence.Id);
                if (entity != null)
                {
                    Console.WriteLine($"Found residence: {entity.Name}. Marking as deleted.");
                    entity.IsDeleted = true; // Soft delete
                    entity.DeletedAt = DateTime.UtcNow;
                    entity.IsActive = false;
                    await context.SaveChangesAsync();
                    Console.WriteLine($"Residence {entity.Name} (ID: {entity.Id}) marked as deleted and changes saved.");

                    Snackbar.Add(string.Format(L["ResidencesManagement_Snackbar_Deleted"], residence.Name), Severity.Success);
                    await LoadResidences();
                }
                else
                {
                    Console.WriteLine($"Residence with ID: {residence.Id} not found for deletion.");
                    Snackbar.Add(string.Format(L["ResidencesManagement_Snackbar_NotFound"], residence.Name), Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                await Console.Error.WriteLineAsync($"Error during residence deletion: {ex.Message}");
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}
