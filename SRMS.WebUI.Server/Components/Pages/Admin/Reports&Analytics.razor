@page "/admin/reports"
@using SRMS.Application.AuditLogs.Interfaces
@using SRMS.Domain.AuditLogs.Enums
@using SRMS.Domain.Complaints
@using SRMS.Domain.Payments
@using SRMS.Domain.Repositories
@using SRMS.Domain.Residences
@using Microsoft.Extensions.Localization
@attribute [Authorize(Roles = "Admin,SuperRoot")]
@inject IRepositories<Student> StudentRepo
@inject IRepositories<Payment> PaymentRepo
@inject IRepositories<Complaint> ComplaintRepo
@inject IRepositories<ComplaintType> ComplaintTypeRepo
@inject IRepositories<Residence> ResidenceRepo
@inject IAuditService AuditService
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["ReportsAndAnalytics_PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Header -->
    <MudPaper Elevation="0" Class="p-4 md:p-6 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Class="text-2xl md:text-4xl font-bold flex items-center">
                    <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2 text-3xl md:text-4xl" />
                    @L["ReportsAndAnalytics_Header"]
                </MudText>
                <MudBreadcrumbs Items="_breadcrumbs" Class="mt-2" />
            </div>
            <MudButtonGroup Variant="Variant.Outlined" Class="hidden md:flex">
                <MudButton StartIcon="@Icons.Material.Filled.Download">@L["ReportsAndAnalytics_Button_ExportPDF"]
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.TableChart">@L["ReportsAndAnalytics_Button_ExportExcel"]
                </MudButton>
            </MudButtonGroup>

            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Variant="Variant.Outlined" Class="flex md:hidden">
                <MudMenuItem Icon="@Icons.Material.Filled.Download">@L["ReportsAndAnalytics_Button_ExportPDF"]
                </MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.TableChart">@L["ReportsAndAnalytics_Button_ExportExcel"]
                </MudMenuItem>
            </MudMenu>
        </MudStack>
    </MudPaper>

    <!-- Date Range Selector -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudDatePicker Date="_startDate"
                    DateChanged="@(async (DateTime? date) => { _startDate = date; await LoadReports(); })"
                    Label='@L["ReportsAndAnalytics_Label_StartDate"]' Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudDatePicker Date="_endDate"
                    DateChanged="@(async (DateTime? date) => { _endDate = date; await LoadReports(); })"
                    Label='@L["ReportsAndAnalytics_Label_EndDate"]' Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect Value="_reportPeriod" ValueChanged="@((string value) => HandlePeriodChange(value))"
                    Label='@L["ReportsAndAnalytics_Label_QuickSelect"]' Variant="Variant.Outlined">
                    <MudSelectItem Value="@("today")">@L["ReportsAndAnalytics_Period_Today"]</MudSelectItem>
                    <MudSelectItem Value="@("week")">@L["ReportsAndAnalytics_Period_ThisWeek"]</MudSelectItem>
                    <MudSelectItem Value="@("month")">@L["ReportsAndAnalytics_Period_ThisMonth"]</MudSelectItem>
                    <MudSelectItem Value="@("quarter")">@L["ReportsAndAnalytics_Period_ThisQuarter"]</MudSelectItem>
                    <MudSelectItem Value="@("year")">@L["ReportsAndAnalytics_Period_ThisYear"]</MudSelectItem>
                    <MudSelectItem Value="@("custom")">@L["ReportsAndAnalytics_Period_CustomRange"]</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <!-- Summary Cards -->
        <!-- Summary Cards -->
        <MudGrid Class="mb-4">
            <!-- Revenue Card -->
            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2" Class="h-full">
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <div class="flex justify-between items-center">
                                <MudText Class="text-xs md:text-caption text-secondary uppercase">
                                    @L["ReportsAndAnalytics_Summary_TotalRevenue"]</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success"
                                    Size="Size.Small" />
                            </div>
                            <MudText Class="text-lg md:text-2xl font-bold text-success">
                                @_reportData.TotalRevenue.ToString("N0") LYD
                            </MudText>
                            <MudText Class="text-xs text-secondary">
                                @string.Format(L["ReportsAndAnalytics_Summary_PaymentsReceived"], _reportData.PaidPayments)
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Pending Payments Card -->
            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2" Class="h-full">
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <div class="flex justify-between items-center">
                                <MudText Class="text-xs md:text-caption text-secondary uppercase">
                                    @L["ReportsAndAnalytics_Summary_PendingPayments"]</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning"
                                    Size="Size.Small" />
                            </div>
                            <MudText Class="text-lg md:text-2xl font-bold text-warning">
                                @_reportData.PendingAmount.ToString("N0") LYD
                            </MudText>
                            <MudText Class="text-xs text-secondary">
                                @string.Format(L["ReportsAndAnalytics_Summary_PaymentsPending"],
                            _reportData.PendingPayments)
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- New Students Card -->
            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2" Class="h-full">
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <div class="flex justify-between items-center">
                                <MudText Class="text-xs md:text-caption text-secondary uppercase">
                                    @L["ReportsAndAnalytics_Summary_NewStudents"]</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" Size="Size.Small" />
                            </div>
                            <MudText Class="text-lg md:text-2xl font-bold text-primary">
                                @_reportData.NewStudents
                            </MudText>
                            <MudText Class="text-xs text-secondary">
                                @L["ReportsAndAnalytics_Summary_InSelectedPeriod"]
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Complaints Card -->
            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2" Class="h-full">
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <div class="flex justify-between items-center">
                                <MudText Class="text-xs md:text-caption text-secondary uppercase">
                                    @L["ReportsAndAnalytics_Summary_Complaints"]</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.ReportProblem" Color="Color.Error"
                                    Size="Size.Small" />
                            </div>
                            <MudText Class="text-lg md:text-2xl font-bold text-error">
                                @_reportData.TotalComplaints
                            </MudText>
                            <MudText Class="text-xs text-secondary">
                                @string.Format(L["ReportsAndAnalytics_Summary_ComplaintsResolved"],
                            _reportData.ResolvedComplaints)
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Charts Row -->
        <MudGrid Class="mb-4">
            <!-- Revenue Chart -->
            <MudItem xs="12" md="8" Style="margin-bottom: 20px">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["ReportsAndAnalytics_Chart_RevenueTrend"]</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="height: 350px;">
                        @if (_revenueChartData.Any())
                        {
                            <MudChart ChartType="ChartType.Line" ChartSeries="@_revenueSeries"
                                XAxisLabels="@_revenueChartData.Select(x => x.Label).ToArray()" Width="100%" Height="320px"
                                ChartOptions="@_chartOptions" />
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Payment Status Pie Chart -->
            <MudItem xs="12" md="4" Style="margin-bottom: 20px">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["ReportsAndAnalytics_Chart_PaymentStatus"]</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="height: 350px;">
                        <MudChart ChartType="ChartType.Donut" InputData="@_paymentStatusData"
                            InputLabels="@_paymentStatusLabels" Width="100%" Height="320px" />
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Occupancy Analysis -->
        <MudGrid Class="mb-4" Style="margin-bottom: 20px">
            <MudItem xs="12" md="6">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["ReportsAndAnalytics_Chart_OccupancyByResidence"]</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Class="max-h-[400px] overflow-y-auto">
                        @foreach (var residence in _reportData.ResidenceOccupancy)
                        {
                            <MudStack Spacing="1" Class="mb-3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">@residence.Name</MudText>
                                    <MudText Typo="Typo.body2">@residence.Rate.ToString("F0")%</MudText>
                                </MudStack>
                                <MudProgressLinear Value="@residence.Rate" Color="@GetOccupancyColor(residence.Rate)"
                                    Size="Size.Small" Rounded="true" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @string.Format(L["ReportsAndAnalytics_Chart_Occupied"], residence.Occupied, residence.Total)
                                </MudText>
                            </MudStack>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Complaint Categories -->
            <MudItem xs="12" md="6" Style="margin-bottom: 20px">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["ReportsAndAnalytics_Chart_ComplaintsByCategory"]</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Class="h-[400px]">
                        <MudChart ChartType="ChartType.Bar" ChartSeries="@_complaintSeries"
                            XAxisLabels="@_complaintCategories" Width="100%" Height="370px"
                            ChartOptions="@_barChartOptions" />
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Top Statistics Tables -->
        <MudGrid>
            <!-- Top Revenue Generators -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Class="mr-2" />
                                @L["ReportsAndAnalytics_Table_TopRevenueGenerators"]
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudTable Items="@_reportData.TopResidences" Hover="true" Dense="true">
                            <HeaderContent>
                                <MudTh>@L["ReportsAndAnalytics_Table_Header_Residence"]</MudTh>
                                <MudTh>@L["ReportsAndAnalytics_Table_Header_Revenue"]</MudTh>
                                <MudTh>@L["ReportsAndAnalytics_Table_Header_Students"]</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Name</MudTd>
                                <MudTd>@context.Revenue.ToString("N0") LYD</MudTd>
                                <MudTd>@context.Students</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Recent Activity Summary -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Class="mr-2" />
                                @L["ReportsAndAnalytics_ActivitySummary"]
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Login" IconColor="Color.Primary">
                                <MudText Typo="Typo.body2">@string.Format(L["ReportsAndAnalytics_Activity_UserLogins"],
                                _reportData.LoginCount)</MudText>
                            </MudListItem>
                            <MudListItem T="string" Icon="@Icons.Material.Filled.PersonAdd" IconColor="Color.Success">
                                <MudText Typo="Typo.body2">
                                    @string.Format(L["ReportsAndAnalytics_Activity_NewRegistrations"],
                                _reportData.NewStudents)</MudText>
                            </MudListItem>
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Payment" IconColor="Color.Warning">
                                <MudText Typo="Typo.body2">
                                    @string.Format(L["ReportsAndAnalytics_Activity_PaymentsProcessed"],
                                _reportData.PaidPayments)</MudText>
                            </MudListItem>
                            <MudListItem T="string" Icon="@Icons.Material.Filled.ReportProblem" IconColor="Color.Error">
                                <MudText Typo="Typo.body2">@string.Format(L["ReportsAndAnalytics_Activity_ComplaintsFiled"],
                                _reportData.TotalComplaints)</MudText>
                            </MudListItem>
                            <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Info">
                                <MudText Typo="Typo.body2">
                                    @string.Format(L["ReportsAndAnalytics_Activity_ComplaintsResolved"],
                                _reportData.ResolvedComplaints)</MudText>
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private DateTime? _startDate = DateTime.Today.AddMonths(-1);
    private DateTime? _endDate = DateTime.Today;
    private string _reportPeriod = "month";
    private bool _isLoading = true;

    private ReportData _reportData = new();
    private List<ChartDataPoint> _revenueChartData = new();
    private List<ChartSeries> _revenueSeries = new();
    private double[] _paymentStatusData = [];
    private string[] _paymentStatusLabels = [];
    private List<ChartSeries> _complaintSeries = new();
    private string[] _complaintCategories = [];
    private List<ComplaintType> _allComplaintTypes = new();

    private readonly ChartOptions _chartOptions = new()
        {
            YAxisTicks = 10,
            MaxNumYAxisTicks = 10,
            YAxisLines = true,
            XAxisLines = false
        };

    private readonly ChartOptions _barChartOptions = new()
        {
            YAxisTicks = 5,
            XAxisLines = false
        };

    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
    new("Admin", href: "/admin", icon: Icons.Material.Filled.Home),
    new("Reports", href: null, disabled: true)
    ];

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
    }

    private async Task HandlePeriodChange(string period)
    {
        _reportPeriod = period;
        var now = DateTime.Today;

        (_startDate, _endDate) = period switch
        {
            "today" => (now, now),
            "week" => (now.AddDays(-7), now),
            "month" => (now.AddMonths(-1), now),
            "quarter" => (now.AddMonths(-3), now),
            "year" => (now.AddYears(-1), now),
            _ => (_startDate, _endDate)
        };

        await LoadReports();
    }

    private async Task LoadReports()
    {
        _isLoading = true;

        try
        {
            var students = await StudentRepo.GetAllAsync();
            var payments = await PaymentRepo.GetAllAsync();
            var complaints = await ComplaintRepo.GetAllAsync();
            _allComplaintTypes = (await ComplaintTypeRepo.GetAllAsync()).Where(ct => !ct.IsDeleted).ToList();
            var residences = await ResidenceRepo.GetAllAsync();
            var auditLogs = await AuditService.GetAllAsync();

            // Filter by date range
            var iEnumerable = students.ToList();
            var filteredStudents = iEnumerable.Where(s =>
            s.CreatedAt >= _startDate && s.CreatedAt <= _endDate).ToList();
            var filteredPayments = payments.Where(p =>
            p.CreatedAt >= _startDate && p.CreatedAt <= _endDate).ToList();
            var filteredComplaints = complaints.Where(c =>
            c.CreatedAt >= _startDate && c.CreatedAt <= _endDate).ToList();

            // Calculate statistics
            var enumerable = residences.ToList();
            _reportData = new ReportData
                {
                    TotalRevenue = filteredPayments
                .Where(p => p.Status == PaymentStatus.Paid)
                .Sum(p => p.Amount.Amount ?? 0),
                    PendingAmount = filteredPayments
                .Where(p => p.Status == PaymentStatus.Pending)
                .Sum(p => p.Amount.Amount ?? 0),
                    PaidPayments = filteredPayments.Count(p => p.Status == PaymentStatus.Paid),
                    PendingPayments = filteredPayments.Count(p => p.Status == PaymentStatus.Pending),
                    NewStudents = filteredStudents.Count,
                    TotalComplaints = filteredComplaints.Count,
                    ResolvedComplaints = filteredComplaints.Count(c => c.Status == ComplaintStatus.Resolved),
                    LoginCount = auditLogs.Count(l => l.AuditAction == AuditAction.Login),

                    // Occupancy by residence
                    ResidenceOccupancy = enumerable.Select(r => new OccupancyData
                    {
                        Name = r.Name,
                        Total = r.TotalCapacity,
                        Occupied = r.TotalCapacity - r.AvailableCapacity,
                        Rate = r.TotalCapacity > 0 ? ((double)(r.TotalCapacity - r.AvailableCapacity) / r.TotalCapacity) * 100 : 0
                    }).ToList(),

                    // Top residences
                    TopResidences = enumerable.Select(r => new TopResidenceData
                    {
                        Name = r.Name,
                        Revenue = filteredPayments
                    .Where(p => p.Reservation.Room.ResidenceId == r.Id && p.Status == PaymentStatus.Paid)
                    .Sum(p => p.Amount.Amount ?? 0),
                        Students = iEnumerable.Count(s => s.Reservations.Any(res => res.Room.ResidenceId == r.Id))
                    }).OrderByDescending(r => r.Revenue).Take(5).ToList()
                };

            // Generate charts
            GenerateRevenueChart(filteredPayments);
            GeneratePaymentStatusChart(filteredPayments);
            GenerateComplaintChart(filteredComplaints);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GenerateRevenueChart(List<Payment> payments)
    {
        var days = (_endDate!.Value - _startDate!.Value).Days;
        var interval = Math.Max(1, days / 10);

        _revenueChartData = new List<ChartDataPoint>();

        for (var date = _startDate.Value; date <= _endDate.Value; date = date.AddDays(interval))
        {
            var endRange = date.AddDays(interval);
            var revenue = payments
            .Where(p => p.CreatedAt.Date >= date && p.CreatedAt.Date < endRange && p.Status == PaymentStatus.Paid)
            .Sum(p => p.Amount.Amount ?? 0);

            _revenueChartData.Add(new ChartDataPoint
                {
                    Label = date.ToString("MMM dd"),
                    Value = (double)revenue
                });
        }

        _revenueSeries =
        [
        new ChartSeries
            {
                Name = "Revenue (LYD)",
                Data = _revenueChartData.Select(x => x.Value).ToArray()
            }
        ];
    }

    private void GeneratePaymentStatusChart(List<Payment> payments)
    {
        var paid = payments.Count(p => p.Status == PaymentStatus.Paid);
        var pending = payments.Count(p => p.Status == PaymentStatus.Pending);
        var overdue = payments.Count(p => p.Status == PaymentStatus.Overdue);

        _paymentStatusData = [paid, pending, overdue];
        _paymentStatusLabels = ["Paid", "Pending", "Overdue"];
    }

    private void GenerateComplaintChart(List<Complaint> complaints)
    {
        var categories = _allComplaintTypes;
        var categoryCounts = categories.Select(c => complaints.Count(comp => comp.ComplaintTypeId == c.Id)).ToArray();

        _complaintCategories = categories.Select(c => c.Name).ToArray();
        _complaintSeries =
        [
        new ChartSeries
            {
                Name = "Complaints",
                Data = categoryCounts.Select(x => (double)x).ToArray()
            }
        ];
    }

    private Color GetOccupancyColor(double rate)
    {
        return rate >= 90 ? Color.Error : rate >= 70 ? Color.Warning : Color.Success;
    }

    private class ReportData
    {
        public decimal TotalRevenue { get; init; }
        public decimal PendingAmount { get; init; }
        public int PaidPayments { get; init; }
        public int PendingPayments { get; init; }
        public int NewStudents { get; init; }
        public int TotalComplaints { get; init; }
        public int ResolvedComplaints { get; init; }
        public int LoginCount { get; init; }
        public List<OccupancyData> ResidenceOccupancy { get; init; } = [];
        public List<TopResidenceData> TopResidences { get; init; } = [];
    }

    private class OccupancyData
    {
        public string Name { get; init; } = "";
        public int Total { get; init; }
        public int Occupied { get; init; }
        public double Rate { get; init; }
    }

    private class TopResidenceData
    {
        public string Name { get; init; } = "";
        public decimal Revenue { get; init; }
        public int Students { get; init; }
    }

    private class ChartDataPoint
    {
        public string Label { get; init; } = "";
        public double Value { get; init; }
    }
}
