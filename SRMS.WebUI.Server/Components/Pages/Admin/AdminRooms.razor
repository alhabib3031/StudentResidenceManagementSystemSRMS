@page "/admin/rooms"
@attribute [Authorize(Roles = "Admin")]
@using SRMS.Application.SystemSettings.DTOs
@inject HttpClient Http
@inject IJSRuntime JsRuntime

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <MudText Class="text-3xl md:text-4xl font-bold text-gradient">Admin Room Management</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/admin/rooms/create" Class="w-full md:w-auto rounded-xl shadow-lg">
            Create New Room
        </MudButton>
    </div>

    @if (_rooms == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="my-8" />
    }
    else
    {
        <MudPaper Elevation="2" Class="mb-8 overflow-hidden rounded-3xl">
            <MudTable Items="_rooms" Hover="true" Breakpoint="Breakpoint.Sm" Class="glass-table">
                <HeaderContent>
                    <MudTh>Room Number</MudTh>
                    <MudTh>Floor</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Monthly Rent</MudTh>
                    <MudTh>Beds (Total/Occ)</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Residence</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Room Number" Class="font-bold">@context.RoomNumber</MudTd>
                    <MudTd DataLabel="Floor">@context.Floor</MudTd>
                    <MudTd DataLabel="Type">@context.RoomType</MudTd>
                    <MudTd DataLabel="Rent">@context.MonthlyRentAmount @context.MonthlyRentCurrency</MudTd>
                    <MudTd DataLabel="Beds">@context.TotalBeds / @context.OccupiedBeds</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Color='@(context.Status.ToString() == "Available" ? Color.Success : Color.Warning)' Size="Size.Small">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Residence">@context.ResidenceName</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudStack Row="true" Spacing="2">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Href="@($"/admin/rooms/edit/{context.Id}")" Size="Size.Small" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteRoom(context.Id))" Size="Size.Small" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }

    <MudDivider Class="my-8" />

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <MudText Class="text-2xl md:text-3xl font-bold text-secondary">Fees Configurations</MudText>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" Href="/admin/fees-configurations/create" Class="w-full md:w-auto rounded-xl">
            Create Configuration
        </MudButton>
    </div>

    @if (_feesConfigurations == null)
    {
         <MudProgressCircular Color="Color.Secondary" Indeterminate="true" Class="my-8" />
    }
    else
    {
        <MudPaper Elevation="1" Class="overflow-hidden rounded-3xl">
            <MudTable Items="_feesConfigurations" Hover="true" Breakpoint="Breakpoint.Sm" Class="glass-table">
                <HeaderContent>
                    <MudTh>Nationality</MudTh>
                    <MudTh>Study Level</MudTh>
                    <MudTh>Is Monthly</MudTh>
                    <MudTh>Fee Amount</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Nationality">@context.NationalityName</MudTd>
                    <MudTd DataLabel="Study Level">@context.StudyLevelName</MudTd>
                    <MudTd DataLabel="Is Monthly">
                        <MudIcon Icon="@(context.IsMonthly ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" Color="@(context.IsMonthly ? Color.Success : Color.Default)" Size="Size.Small" />
                    </MudTd>
                    <MudTd DataLabel="Fee Amount" Class="font-bold">@context.FeeAmount.Amount @context.FeeAmount.Currency</MudTd>
                    <MudTd DataLabel="Description">@context.Description</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudStack Row="true" Spacing="2">
                             <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Secondary" Href="@($"/admin/fees-configurations/edit/{context.Id}")" Size="Size.Small" />
                             <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteFeesConfiguration(context.Id))" Size="Size.Small" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private IEnumerable<RoomDto>? _rooms;
    private IEnumerable<FeesConfigurationDto>? _feesConfigurations;

    protected override async Task OnInitializedAsync()
    {
        await LoadRooms();
        await LoadFeesConfigurations();
    }

    private async Task LoadRooms()
    {
        _rooms = await Http.GetFromJsonAsync<IEnumerable<RoomDto>>("api/admin/AdminRooms");
    }

    private async Task DeleteRoom(Guid id)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this room?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/admin/AdminRooms/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadRooms();
            }
            else
            {
                // Handle error
                Console.WriteLine($"Error deleting room: {response.ReasonPhrase}");
            }
        }
    }

    private async Task LoadFeesConfigurations()
    {
        _feesConfigurations = await Http.GetFromJsonAsync<IEnumerable<FeesConfigurationDto>>("api/admin/AdminRooms/fees-configurations");
    }

    private async Task DeleteFeesConfiguration(Guid id)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this fees configuration?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/admin/AdminRooms/fees-configurations/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadFeesConfigurations();
            }
            else
            {
                // Handle error
                Console.WriteLine($"Error deleting fees configuration: {response.ReasonPhrase}");
            }
        }
    }
}
