@page "/student"
@using Microsoft.Extensions.Localization
@attribute [Authorize(Roles = "Student")]
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> Localizer
@rendermode InteractiveServer

<PageTitle>@Localizer["MyDashboard"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <!-- Welcome Header -->
    <MudPaper Elevation="0" Class="pa-4 mb-4 bg-gradient-to-br from-primary to-secondary">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h4" Class="text-white">
                    <MudIcon Icon="@Icons.Material.Filled.WavingHand" Class="mr-2" />
                    @Localizer["WelcomeBack"], @_userName!
                </MudText>
                <MudText Typo="Typo.body2" Class="text-white/80">
                    @Localizer["HeresYourResidenceOverview"]
                </MudText>
            </MudStack>
            <MudAvatar Size="Size.Large" Color="Color.Surface">
                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
            </MudAvatar>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <MudGrid>
        <!-- Quick Stats -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["MyRoom"]</MudText>
                            <MudText Typo="Typo.h5">@Localizer["Room"] 201</MudText>
                            <MudText Typo="Typo.caption">@Localizer["Floor"] 2 - @Localizer["BuildingA"]</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Primary" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Href="/student/room">
                        @Localizer["ViewDetails"]
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["NextPayment"]</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Warning">@Localizer["DueSoon"]</MudText>
                            <MudText Typo="Typo.caption">500 LYD - @Localizer["Jan2025"]</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Warning" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Payment" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Href="/payments">
                        @Localizer["PayNow"]
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["MyComplaints"]</MudText>
                            <MudText Typo="Typo.h5">2 @Localizer["Active"]</MudText>
                            <MudText Typo="Typo.caption">1 @Localizer["Resolved"]</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Info" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Report" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                               Href="/student/complaints">
                        @Localizer["ViewAll"]
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["Notifications"]</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Error">5 @Localizer["New"]</MudText>
                            <MudText Typo="Typo.caption">3 @Localizer["UnreadMessages"]</MudText>
                        </MudStack>
                        <MudAvatar Color="Color.Error" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Notifications" Size="Size.Large" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Href="/notifications">
                        @Localizer["ViewAll"]
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12" md="8">
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Bolt" Class="mr-2" Size="Size.Small" />
                            @Localizer["QuickActions"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Report" Href="/student/complaints/create">
                                @Localizer["SubmitComplaint"]
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Payment" Href="/student/payments">
                                @Localizer["MakePayment"]
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Person" Href="/profile">
                                @Localizer["UpdateProfile"]
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.MeetingRoom" Href="/student/room">
                                @Localizer["ViewRoom"]
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Receipt" OnClick="@DownloadReceipts">
                                @Localizer["DownloadReceipts"]
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Help" Href="/help">
                                @Localizer["GetHelp"]
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Recent Activity -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" Size="Size.Small" />
                            @Localizer["RecentActivity"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="max-h-[400px] overflow-y-auto">
                    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical">
                        <MudTimelineItem Color="Color.Success" Size="Size.Small">
                            <ItemContent>
                                <MudText Typo="Typo.body2">@Localizer["PaymentReceived"]</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["2hoursAgo"]</MudText>
                            </ItemContent>
                        </MudTimelineItem>
                        <MudTimelineItem Color="Color.Info" Size="Size.Small">
                            <ItemContent>
                                <MudText Typo="Typo.body2">@Localizer["ComplaintResolved"]</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["1dayAgo"]</MudText>
                            </ItemContent>
                        </MudTimelineItem>
                        <MudTimelineItem Color="Color.Warning" Size="Size.Small">
                            <ItemContent>
                                <MudText Typo="Typo.body2">@Localizer["NewComplaintSubmitted"]</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["3daysAgo"]</MudText>
                            </ItemContent>
                        </MudTimelineItem>
                        <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                            <ItemContent>
                                <MudText Typo="Typo.body2">@Localizer["ProfileUpdated"]</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@Localizer["1weekAgo"]</MudText>
                            </ItemContent>
                        </MudTimelineItem>
                    </MudTimeline>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Announcements -->
        <MudItem xs="12">
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Campaign" Class="mr-2" Size="Size.Small" />
                            @Localizer["ImportantAnnouncements"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="3">
                        <MudAlert Severity="Severity.Warning" Dense="true">
                            <strong>@Localizer["PaymentReminder"]:</strong> @Localizer["JanuaryRentDue"]
                        </MudAlert>
                        <MudAlert Severity="Severity.Info" Dense="true">
                            <strong>@Localizer["MaintenanceNotice"]:</strong> @Localizer["BuildingAMaintenance"]
                        </MudAlert>
                        <MudAlert Severity="Severity.Success" Dense="true">
                            <strong>@Localizer["NewFeature"]:</strong> @Localizer["TrackComplaintStatus"]
                        </MudAlert>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string _userName = "Student";
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userName = user.Identity.Name ?? "Student";
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        _isLoading = true;
        try
        {
            // TODO: Load real data
            await Task.Delay(500);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void DownloadReceipts()
    {
        Snackbar.Add(Localizer["DownloadingReceipts"], Severity.Info);
    }
}
