@page "/register"
@using System.Security.Claims
@using Microsoft.Extensions.Localization
@using SRMS.WebUI.Server.Resources
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IStringLocalizer<Resource> L
@rendermode InteractiveServer

<PageTitle>@L["Register_PageTitle"]</PageTitle>

@if (_isCheckingAuth)
{
    <MudContainer MaxWidth="MaxWidth.Small" Class="min-h-screen flex items-center justify-center">
        <MudStack AlignItems="AlignItems.Center" Spacing="4">
            <MudProgressCircular Size="Size.Large" Indeterminate="true" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Color="Color.Secondary">@L["Register_CheckingAuth"]</MudText>
        </MudStack>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="min-h-screen flex items-center justify-center py-4 md:py-8">
        <MudPaper Elevation="0" Class="glass-card w-full max-w-4xl p-4 md:p-8 rounded-2xl animate-fade-in">
            
            <!-- Header -->
            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="mb-8">
                <MudPaper Elevation="0"
                    Class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl flex items-center justify-center shadow-[0_0_20px_rgba(139,92,246,0.3)]">
                    <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Surface" Size="Size.Large" />
                </MudPaper>
                
                <MudStack Spacing="1" AlignItems="AlignItems.Center">
                    <MudText Class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                        @L["Register_Header_CreateAccount"]
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @L["Register_Subtitle_Join"]
                    </MudText>
                </MudStack>
            </MudStack>

            <EditForm Model="@_registerModel" OnValidSubmit="HandleRegister" FormName="RegisterForm">
                <DataAnnotationsValidator />

                <MudGrid Spacing="4">
                    <!-- Personal Information Section -->
                    <MudItem xs="12">
                        <MudPaper Elevation="0" Class="bg-purple-500/10 dark:bg-purple-500/20 p-4 rounded-xl border border-purple-500/20">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" Size="Size.Medium" />
                                <MudText Typo="Typo.h6" Class="font-semibold">@L["Register_PersonalInformation"]</MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.FirstName" 
                            Label='@L["Register_Label_FirstName"]'
                            Variant="Variant.Outlined" 
                            For="@(() => _registerModel.FirstName)" 
                            Required="true"
                            Disabled="_isLoading" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Badge" 
                            Class="rounded-xl" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.LastName" 
                            Label='@L["Register_Label_LastName"]'
                            Variant="Variant.Outlined" 
                            For="@(() => _registerModel.LastName)" 
                            Required="true"
                            Disabled="_isLoading" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Badge"
                            Class="rounded-xl" />
                    </MudItem>

                    <!-- Contact Information Section -->
                    <MudItem xs="12" Class="mt-2">
                        <MudPaper Elevation="0" Class="bg-pink-500/10 dark:bg-pink-500/20 p-4 rounded-xl border border-pink-500/20">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.ContactMail" Color="Color.Secondary" Size="Size.Medium" />
                                <MudText Typo="Typo.h6" Class="font-semibold">@L["Register_ContactInformation"]</MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.Email" 
                            Label='@L["Register_Label_Email"]'
                            Variant="Variant.Outlined" 
                            InputType="InputType.Email" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Email"
                            For="@(() => _registerModel.Email)" 
                            Required="true" 
                            Disabled="_isLoading"
                            HelperText='@L["Register_Helper_EmailVerification"]'
                            Class="rounded-xl" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.PhoneNumber" 
                            Label='@L["Register_Label_Phone"]'
                            Variant="Variant.Outlined" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Phone"
                            For="@(() => _registerModel.PhoneNumber)" 
                            Required="true" 
                            Disabled="_isLoading"
                            Placeholder="+218 91 234 5678"
                            Class="rounded-xl" />
                    </MudItem>

                    <!-- Additional Information Section -->
                    <MudItem xs="12" Class="mt-2">
                        <MudPaper Elevation="0" Class="bg-blue-500/10 dark:bg-blue-500/20 p-4 rounded-xl border border-blue-500/20">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Medium" />
                                <MudText Typo="Typo.h6" Class="font-semibold">@L["Register_AdditionalInformation"]</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Text="Optional" Class="text-xs" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.NationalId" 
                            Label='@L["Register_Label_NationalId"]'
                            Variant="Variant.Outlined" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.CreditCard"
                            Disabled="_isLoading" 
                            Placeholder="123456789012"
                            Class="rounded-xl" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudDatePicker 
                            @bind-Date="_registerModel.DateOfBirth" 
                            Label='@L["Register_Label_DateOfBirth"]'
                            Variant="Variant.Outlined" 
                            MaxDate="DateTime.Today.AddYears(-16)"
                            Placeholder="Select your birth date" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Cake"
                            Disabled="_isLoading"
                            Class="rounded-xl" />
                    </MudItem>

                    <!-- Security Section -->
                    <MudItem xs="12" Class="mt-2">
                        <MudPaper Elevation="0" Class="bg-red-500/10 dark:bg-red-500/20 p-4 rounded-xl border border-red-500/20">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Error" Size="Size.Medium" />
                                <MudText Typo="Typo.h6" Class="font-semibold">@L["Register_Security"]</MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.Password" 
                            Label='@L["Register_Label_Password"]'
                            Variant="Variant.Outlined"
                            InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                            Adornment="Adornment.End"
                            AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                            OnAdornmentClick="TogglePasswordVisibility"
                            For="@(() => _registerModel.Password)"
                            HelperText='@L["Register_Helper_PasswordRules"]'
                            Required="true" 
                            Disabled="_isLoading" 
                            @onkeyup="@(CalculatePasswordStrength)"
                            Class="rounded-xl" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField 
                            @bind-Value="_registerModel.ConfirmPassword" 
                            Label='@L["Register_Label_ConfirmPassword"]'
                            Variant="Variant.Outlined"
                            InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                            For="@(() => _registerModel.ConfirmPassword)"
                            Required="true" 
                            Disabled="_isLoading"
                            Class="rounded-xl" />
                    </MudItem>

                    <!-- Password Strength Indicator -->
                    <MudItem xs="12">
                        <MudPaper Elevation="0" Class="bg-gray-100 dark:bg-gray-800/50 p-4 rounded-xl">
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @L["Register_PasswordStrength_Prefix"]
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetPasswordStrengthColor()" Text="@GetPasswordStrengthText()" />
                                </MudStack>
                                <MudProgressLinear 
                                    Color="@GetPasswordStrengthColor()" 
                                    Value="@_passwordStrength"
                                    Size="Size.Medium" 
                                    Class="rounded-lg h-2" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <!-- Terms & Conditions -->
                    <MudItem xs="12" Class="mt-2">
                        <MudPaper Elevation="0" Class="bg-gray-100 dark:bg-gray-800/50 p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700">
                            <MudCheckBox 
                                @bind-Value="_acceptTerms" 
                                Color="Color.Primary" 
                                Required="true"
                                Disabled="_isLoading">
                                <MudText Typo="Typo.body2">
                                    @((MarkupString)string.Format(
                                        L["Register_TermsAndConditions"],
                                        $"<MudLink Href=\"/terms\" Target=\"_blank\" Class=\"text-purple-500 font-semibold hover:text-purple-600\">{L["TermsOfService"]}</MudLink>",
                                        $"<MudLink Href=\"/privacy\" Target=\"_blank\" Class=\"text-purple-500 font-semibold hover:text-purple-600\">{L["PrivacyPolicy"]}</MudLink>"
                                    ))
                                </MudText>
                            </MudCheckBox>
                        </MudPaper>
                    </MudItem>

                    <!-- Submit Button -->
                    <MudItem xs="12" Class="mt-4">
                        <MudButton 
                            ButtonType="ButtonType.Submit" 
                            Variant="Variant.Filled" 
                            Color="Color.Primary"
                            FullWidth="true" 
                            Size="Size.Large" 
                            Disabled="@(_isLoading || !_acceptTerms)"
                            StartIcon="@Icons.Material.Filled.AppRegistration"
                            Class="btn-modern btn-primary h-14 rounded-xl font-bold">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>@L["Register_Button_CreatingAccount"]</span>
                            }
                            else
                            {
                                <span>@L["Register_Button_CreateAccount"]</span>
                            }
                        </MudButton>
                    </MudItem>

                    <!-- Divider -->
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="my-2">
                            <MudDivider Class="flex-1" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@L["Register_OR"]</MudText>
                            <MudDivider Class="flex-1" />
                        </MudStack>
                    </MudItem>

                    <!-- Login Link -->
                    <MudItem xs="12">
                        <MudPaper Elevation="0" Class="bg-gray-100 dark:bg-gray-800/50 p-5 rounded-xl text-center">
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                                @L["Register_AlreadyHaveAccount"]
                            </MudText>
                            <MudButton 
                                Href="/login" 
                                Variant="Variant.Outlined" 
                                Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.Login" 
                                Disabled="_isLoading"
                                Class="rounded-xl font-semibold border-2 hover-lift">
                                @L["Register_Button_SignInInstead"]
                            </MudButton>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudPaper>
    </MudContainer>
}

@code {
    private readonly RegisterDto _registerModel = new();
    private bool _showPassword;
    private bool _isLoading;
    private bool _acceptTerms;
    private int _passwordStrength;
    private bool _isCheckingAuth = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var role = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;

                var redirectUrl = role switch
                {
                    "SuperRoot" => "/superroot",
                    "Admin" => "/admin",
                    "Manager" => "/manager",
                    "Student" => "/student",
                    _ => "/"
                };

                Navigation.NavigateTo(redirectUrl, replace: true);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[REGISTER_INIT_ERROR] {ex.Message}");
        }
        finally
        {
            _isCheckingAuth = false;
        }
    }

    private void TogglePasswordVisibility() => _showPassword = !_showPassword;

    private void CalculatePasswordStrength()
    {
        if (string.IsNullOrEmpty(_registerModel.Password))
        {
            _passwordStrength = 0;
            return;
        }

        var strength = 0;
        if (_registerModel.Password.Length >= 8) strength += 20;
        if (_registerModel.Password.Any(char.IsUpper)) strength += 20;
        if (_registerModel.Password.Any(char.IsLower)) strength += 20;
        if (_registerModel.Password.Any(char.IsDigit)) strength += 20;
        if (_registerModel.Password.Any(ch => !char.IsLetterOrDigit(ch))) strength += 20;

        _passwordStrength = strength;
    }

    private Color GetPasswordStrengthColor()
    {
        return _passwordStrength switch
        {
            <= 20 => Color.Error,
            <= 40 => Color.Warning,
            <= 60 => Color.Info,
            <= 80 => Color.Primary,
            _ => Color.Success
        };
    }

    private string GetPasswordStrengthText()
    {
        return _passwordStrength switch
        {
            0 => L["Register_PasswordStrength_NotSet"].Value,
            <= 20 => L["Register_PasswordStrength_VeryWeak"].Value,
            <= 40 => L["Register_PasswordStrength_Weak"].Value,
            <= 60 => L["Register_PasswordStrength_Fair"].Value,
            <= 80 => L["Register_PasswordStrength_Good"].Value,
            _ => L["Register_PasswordStrength_Strong"].Value
        };
    }

    private async Task HandleRegister()
    {
        _isLoading = true;

        try
        {
            var result = await AuthService.RegisterAsync(_registerModel);

            if (result.Success)
            {
                Snackbar.Add(
                    L["Register_Snackbar_Success"].Value,
                    Severity.Success,
                    config =>
                    {
                        config.VisibleStateDuration = 7000;
                        config.ShowCloseIcon = true;
                    }
                );

                await Task.Delay(2000);
                Navigation.NavigateTo("/login", replace: true);
            }
            else
            {
                Snackbar.Add(
                    result.Message ?? L["Register_Snackbar_Failure"].Value,
                    Severity.Error,
                    config => { config.ShowCloseIcon = true; }
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[REGISTER_ERROR] {ex}");
            Snackbar.Add(
                string.Format(L["Register_Snackbar_Error"].Value, ex.Message),
                Severity.Error,
                config => { config.ShowCloseIcon = true; }
            );
        }
        finally
        {
            _isLoading = false;
        }
    }
}
